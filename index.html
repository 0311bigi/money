<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Èõ≤Á´ØÂ∏≥Êú¨ Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Èõ≤Á´ØÂ∏≥Êú¨">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F8FAFC">
    <script>
        (function() {
            var c = document.createElement('canvas'); c.width = 512; c.height = 512; var x = c.getContext('2d');
            x.fillStyle = '#e11d48'; 
            x.fillRect(0, 0, 512, 512);
            x.strokeStyle = 'rgba(255,255,255,0.2)'; x.lineWidth = 40; x.beginPath(); x.arc(512, 512, 200, 0, Math.PI*2); x.stroke();
            x.fillStyle = '#fff'; x.font = 'bold 300px sans-serif'; x.textAlign = 'center'; x.textBaseline = 'middle'; x.fillText('Â∏≥', 256, 270);
            var u = c.toDataURL('image/png');
            var l1 = document.createElement('link'); l1.rel = 'apple-touch-icon'; l1.href = u; document.head.appendChild(l1);
            var l2 = document.createElement('link'); l2.rel = 'icon'; l2.type = 'image/png'; l2.href = u; document.head.appendChild(l2);
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 text-base">
    <div id="root"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, writeBatch, getDoc, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut };
        window.isFirebaseSDKReady = true;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => { if (window.lucide && ref.current) { const i = document.createElement('i'); i.setAttribute('data-lucide', name); ref.current.innerHTML = ''; ref.current.appendChild(i); window.lucide.createIcons({ root: ref.current, attrs: { width: String(size), height: String(size), class: className } }); } }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const getLocalToday = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
        const getLocalMonth = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; };
        const addMonths = (dStr, m) => { const [y,M,d]=dStr.split('-').map(Number); const nd=new Date(y,M-1+m,1); if(m>0) return `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-01`; const maxD=new Date(nd.getFullYear(),nd.getMonth()+1,0).getDate(); return `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-${String(Math.min(d,maxD)).padStart(2,'0')}`; };

        const DEFAULT_CATS = { expense: [{name:'È£≤È£ü',icon:'utensils',subs:[]},{name:'‰∫§ÈÄö',icon:'bus',subs:[]},{name:'Ë≥ºÁâ©',icon:'shopping-bag',subs:[]},{name:'Â®õÊ®Ç',icon:'film',subs:[]},{name:'Â±Ö‰Ωè',icon:'home',subs:[]}], income: [{name:'Ëñ™Ë≥á',icon:'wallet',subs:[]},{name:'ÁçéÈáë',icon:'gift',subs:[]},{name:'ÊäïË≥á',icon:'trending-up',subs:[]}] };
        
        const ACCOUNT_TYPES = { 
            'cash': { label: 'ÁèæÈáë', iconName: 'coins', color: 'text-emerald-600 bg-emerald-50' },
            'bank': { label: 'ÈäÄË°å', iconName: 'landmark', color: 'text-blue-600 bg-blue-50' },
            'credit': { label: '‰ø°Áî®Âç°', iconName: 'credit-card', color: 'text-purple-600 bg-purple-50' },
            'electronic': { label: 'ÈõªÂ≠êË≤®Âπ£', iconName: 'smartphone-nfc', color: 'text-sky-600 bg-sky-50' },
            'invest': { label: 'ÊäïË≥áÁêÜË≤°', iconName: 'trending-up', color: 'text-rose-600 bg-rose-50' },
            'payable': { label: 'Êáâ‰ªòÂ∏≥Ê¨æ', iconName: 'file-minus', color: 'text-orange-600 bg-orange-50' },
            'receivable': { label: 'ÊáâÊî∂Â∏≥Ê¨æ', iconName: 'file-plus', color: 'text-teal-600 bg-teal-50' },
            'other': { label: 'ÂÖ∂ÂÆÉ', iconName: 'wallet', color: 'text-stone-600 bg-stone-100' }
        };

        const CURRENCIES = ['TWD','USD','JPY','EUR','CNY','HKD','KRW','AUD','CAD','GBP','SGD','CHF'];
        const DEFAULT_RATES = {'TWD':1,'USD':32.5,'JPY':0.22,'EUR':35.0,'CNY':4.5,'HKD':4.1,'KRW':0.024,'AUD':21.5,'CAD':24.0,'GBP':41.0,'SGD':24.2,'CHF':36.5};
        
        const CATEGORY_COLORS = { 'È£≤È£ü': '#f97316', '‰∫§ÈÄö': '#3b82f6', 'Ë≥ºÁâ©': '#ec4899', 'Â®õÊ®Ç': '#a855f7', 'Â±Ö‰Ωè': '#6366f1', 'ÈÜ´ÁôÇ': '#ef4444', 'ÊïôËÇ≤': '#22c55e', 'Ëñ™Ë≥á': '#10b981', 'ÁçéÈáë': '#eab308', 'ÊäïË≥á': '#f43f5e', 'ËΩâÂ∏≥': '#64748b', '‰ª£Â¢ä': '#8b5cf6', 'ÈÇÑÊ¨æ': '#10b981', 'Ëá™ÂãïÁπ≥Ê¨æ': '#94a3b8', 'ÈÅãÂãï': '#f59e0b' };

        const AVAILABLE_ICONS = ['utensils', 'coffee', 'beer', 'shopping-cart', 'shopping-bag', 'gift', 'bus', 'car', 'plane', 'bed', 'map', 'home', 'zap', 'wifi', 'phone', 'hammer', 'film', 'gamepad-2', 'music', 'camera', 'ticket', 'stethoscope', 'pill', 'heart', 'graduation-cap', 'book', 'briefcase', 'smile', 'frown', 'star', 'tag', 'dumbbell', 'more-horizontal'];
        
        const OFFSET_ACCOUNT_ID = 'virtual-offset-account';

        const NavBtn = ({icon, label, active, onClick}) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-full gap-1 ${active?'text-rose-600 scale-105':'text-stone-400 hover:text-stone-600'}`}>{icon}<span className="text-[10px] font-bold">{label}</span></button>
        );

        const Header = ({ currentBook, setIsBookSelectOpen, user, handleGoogleLogin }) => (
            <header className="sticky top-0 z-20 bg-white border-b border-stone-100 px-6 py-4 flex justify-between items-center shadow-sm">
                <div className="flex items-center gap-3 cursor-pointer p-2 hover:bg-stone-50 rounded-xl" onClick={() => setIsBookSelectOpen(true)}>
                    <div className="bg-rose-500 p-2.5 rounded-xl text-white shadow-md shadow-rose-200"><Icon name={currentBook.id==='main'?'book':'plane'} size={22}/></div>
                    <div><h1 className="font-bold text-lg text-stone-700 tracking-wide flex items-center gap-1.5">{currentBook.name} <Icon name="chevron-down" size={16} className="text-stone-400"/></h1></div>
                </div>
                {user?.isAnonymous ? <button onClick={handleGoogleLogin} className="text-xs font-bold text-rose-600 bg-rose-50 px-3 py-2 rounded-lg">ÁôªÂÖ•</button> : <div className="h-8 w-8 rounded-full overflow-hidden border border-stone-200"><img src={user?.photoURL||'https://via.placeholder.com/32'} alt="User"/></div>}
            </header>
        );

        function App() {
            const [sdkReady, setSdkReady] = useState(false);
            const [needConfig, setNeedConfig] = useState(false);
            const [configInput, setConfigInput] = useState('');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('home');

            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATS);
            const [recurring, setRecurring] = useState([]);
            const [retirement, setRetirement] = useState({ currentAge:30, retireAge:60, monthlyExpense:30000, inflation:2 });
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_RATES);
            const [monthlyBudget, setMonthlyBudget] = useState(30000);
            const [books, setBooks] = useState([]);
            const [currentBook, setCurrentBook] = useState({ id:'main', name:'Êó•Â∏∏Â∏≥Êú¨', currency:'TWD' });

            const [currentLedgerMonth, setCurrentLedgerMonth] = useState(getLocalMonth());
            const [analysisMode, setAnalysisMode] = useState('month');
            const [analysisType, setAnalysisType] = useState('expense');
            const [analysisGroupBy, setAnalysisGroupBy] = useState('main'); 
            
            const [modal, setModal] = useState(null); 
            const [editTarget, setEditTarget] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null); 
            
            const [txForm, setTxForm] = useState({ type:'expense', amount:'', toAmount:'', category:'', subCategory:'', accountId:'', toAccountId:'', debtor:'', date:getLocalToday(), note:'', currency:'TWD' });
            const [editingTx, setEditingTx] = useState(null); // New: Track which transaction is being edited

            const [accForm, setAccForm] = useState({ name:'', type:'cash', currency:'TWD', initialBalance:'', includeInTotal: true });
            const [recForm, setRecForm] = useState({ name:'', type:'expense', amount:'', day:1 });
            const [newCatForm, setNewCatForm] = useState({ name:'', icon:'tag', type:'expense' });
            const [retireForm, setRetireForm] = useState({});
            const [bookForm, setBookForm] = useState({ name:'', currency:'TWD', startDate:'', endDate:'' });
            
            const [isAdvanceSplit, setIsAdvanceSplit] = useState(false);
            const [splitData, setSplitData] = useState({ advances:[{debtor:'',amount:''}], principalAmount:'', sourceAccountId:'' });
            const [installment, setInstallment] = useState({ enabled:false, periods:3 });
            const [settleToAccount, setSettleToAccount] = useState('');
            const [newMarketValue, setNewMarketValue] = useState('');
            const [editingCategoryType, setEditingCategoryType] = useState('expense');
            const [editingCategory, setEditingCategory] = useState(null);
            const [settleTargetTx, setSettleTargetTx] = useState(null);
            const [isOffset, setIsOffset] = useState(false);
            const [offsetTargetId, setOffsetTargetId] = useState('');

            const fbRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'my-cloud-ledger-pro';

            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            useEffect(() => {
                const init = () => {
                    if (window.isFirebaseSDKReady) {
                        try {
                            let cfg = window.__firebase_config ? JSON.parse(window.__firebase_config) : JSON.parse(localStorage.getItem('my_ledger_firebase_config'));
                            if (cfg) {
                                const app = window.FirebaseSDK.initializeApp(cfg);
                                fbRef.current = window.FirebaseSDK;
                                authRef.current = window.FirebaseSDK.getAuth(app);
                                dbRef.current = window.FirebaseSDK.getFirestore(app);
                                setSdkReady(true);
                            } else { setNeedConfig(true); setLoading(false); }
                        } catch (e) { setNeedConfig(true); setLoading(false); }
                    } else setTimeout(init, 100);
                };
                init();
            }, []);

            const handleSaveConfig = () => {
                try {
                    let v = configInput.trim().replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g, '$1"$2":').replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                    if(v.includes("const")) v = v.substring(v.indexOf('{'), v.lastIndexOf('}')+1);
                    const c = JSON.parse(v);
                    if(!c.apiKey) throw new Error("Áº∫Â∞ë apiKey");
                    localStorage.setItem('my_ledger_firebase_config', JSON.stringify(c));
                    window.location.reload();
                } catch(e) { setError({ title:"Ë®≠ÂÆöÁÑ°Êïà", message:e.message }); }
            };

            const resetApp = () => { localStorage.removeItem('my_ledger_firebase_config'); window.location.reload(); };

            useEffect(() => {
                const timer = setTimeout(() => { if (loading && !needConfig) { setLoading(false); setError({ title: "ÈÄ£Á∑öÈÄæÊôÇ", message: "Á≥ªÁµ±ÈÄ£Á∑öÈÅé‰πÖÔºåÂèØËÉΩÊòØÔºö\n1. Êú™ÈñãÂïü„ÄåÂåøÂêçÁôªÂÖ•„Äç„ÄÇ\n2. Á∂≤ÂüüÊú™ÊéàÊ¨ä„ÄÇ\n3. API Key ÈåØË™§„ÄÇ" }); } }, 15000); 
                return () => clearTimeout(timer);
            }, [loading, needConfig]);

            useEffect(() => {
                if (!sdkReady) return;
                const unsubAuth = fbRef.current.onAuthStateChanged(authRef.current, async (u) => {
                    if (u) setUser(u);
                    else {
                        try { await fbRef.current.signInAnonymously(authRef.current); }
                        catch (e) { setError({ title:"ÁôªÂÖ•Â§±Êïó", message: "Ë´ãÈñãÂïüÂåøÂêçÁôªÂÖ•ÊàñÊ™¢Êü•Á∂≤ÂüüÊéàÊ¨ä" }); setLoading(false); }
                    }
                });
                return () => unsubAuth();
            }, [sdkReady]);

            const handleGoogleLogin = async () => { try { await fbRef.current.signInWithPopup(authRef.current, new fbRef.current.GoogleAuthProvider()); } catch(e) { setError({title:"ÁôªÂÖ•ÈåØË™§", message:e.message}); } };

            useEffect(() => {
                if (!user || !sdkReady) return;
                const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                
                const checkAutoPay = async (accs) => {
                    const m = getLocalMonth();
                    const cards = accs.filter(a => a.type==='credit' && a.autoPayment && a.autoPaymentAccount);
                    if (cards.length === 0) return;
                    const batch = fbRef.current.writeBatch(dbRef.current);
                    let hasUpd = false;
                    cards.forEach(c => {
                        if (c.lastAutoPaymentMonth !== m && new Date().getDate() >= parseInt(c.paymentDueDay||15)) {
                            batch.set(fbRef.current.doc(fbRef.current.collection(userRef, 'transactions')), {
                                type: 'transfer', amount: 0, category: 'Ëá™ÂãïÁπ≥Ê¨æ', accountId: c.autoPaymentAccount, toAccountId: c.id, date: getLocalToday(), bookId: 'main', note: `[Á≥ªÁµ±] Âç°Ë≤ª (${c.name})`, createdAt: new Date().toISOString()
                            });
                            batch.update(fbRef.current.doc(userRef, 'accounts', c.id), { lastAutoPaymentMonth: m });
                            hasUpd = true;
                        }
                    });
                    if (hasUpd) await batch.commit();
                };

                const unsubs = [
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'transactions'), s => setTransactions(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date)))),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'accounts'), s => { 
                        const a = s.docs.map(d=>({id:d.id,...d.data()})).sort((a, b) => (a.order || 0) - (b.order || 0)); 
                        setAccounts(a); 
                        checkAutoPay(a); 
                    }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'config'), d => { 
                        if(d.exists()) { 
                            const data = d.data();
                            if (data.categories) setCategories(data.categories); 
                            if (data.budget) setMonthlyBudget(data.budget); 
                        } else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'config'), { categories: DEFAULT_CATS }, {merge: true}); 
                    }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'rates'), d => { if(d.exists()) setExchangeRates(d.data()); else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'rates'), DEFAULT_RATES, {merge: true}); }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'retirement'), d => { if(d.exists()) setRetirement(d.data()); else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'retirement'), retirement, {merge: true}); }),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'recurring'), s => setRecurring(s.docs.map(d=>({id:d.id,...d.data()})))),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'books'), s => setBooks([{id:'main',name:'Êó•Â∏∏Â∏≥Êú¨',currency:'TWD'},...s.docs.map(d=>({id:d.id,...d.data()}))]))
                ];
                setLoading(false);
                return () => unsubs.forEach(u => u());
            }, [user, sdkReady]);

            const saveData = async (col, data, id=null) => {
                const ref = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                if (id) await fbRef.current.updateDoc(fbRef.current.doc(ref, col, id), data);
                else await fbRef.current.addDoc(fbRef.current.collection(ref, col), { ...data, createdAt: new Date().toISOString() });
            };
            const deleteData = async (col, id) => { await fbRef.current.deleteDoc(fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid, col, id)); };

            const getCategoryIcon = (catName, type) => {
                if(type === 'transfer') return 'arrow-right-left';
                if(type === 'advance') return 'hand-coins';
                if(type === 'repayment') return 'check-circle';
                if (!categories[type]) return 'tag';
                const cat = categories[type].find(c => c.name === catName);
                return cat ? cat.icon : 'tag';
            };

            const stats = useMemo(() => {
                const bals = {}; accounts.forEach(a => bals[a.id] = parseFloat(a.initialBalance)||0);
                const advanceMap = {}; 
                transactions.forEach(t => { if (t.type === 'advance') advanceMap[t.id] = { ...t, repaid: 0, remaining: parseFloat(t.amount) }; });
                transactions.forEach(t => { if (t.type === 'repayment' && t.relatedTxId && advanceMap[t.relatedTxId]) { const repaidAmt = parseFloat(t.amount); advanceMap[t.relatedTxId].repaid += repaidAmt; advanceMap[t.relatedTxId].remaining -= repaidAmt; } });
                let debt = 0;
                Object.values(advanceMap).forEach(a => { if (!a.isSettled && a.remaining > 0.1) debt += a.remaining; });
                
                let totalAsset=0, inc=0, exp=0;
                transactions.forEach(t => {
                    const amt = parseFloat(t.amount)||0;
                    if (t.accountId !== OFFSET_ACCOUNT_ID && t.toAccountId !== OFFSET_ACCOUNT_ID) { 
                        if (t.type==='income'||t.type==='repayment') if(bals[t.accountId]!=null) bals[t.accountId]+=amt;
                        if (t.type==='expense'||t.type==='advance') if(bals[t.accountId]!=null) bals[t.accountId]-=amt;
                        if (t.type==='transfer') { if(bals[t.accountId]!=null) bals[t.accountId]-=amt; if(bals[t.toAccountId]!=null) bals[t.toAccountId]+=(t.toAmount?parseFloat(t.toAmount):amt); }
                    }
                    if ((t.bookId||'main') === currentBook.id && t.date.startsWith(currentLedgerMonth)) {
                        if (t.type==='income') inc+=amt;
                        if (t.type==='expense') exp+=amt;
                    }
                });
                accounts.forEach(a => { if(a.includeInTotal !== false) { let v = (a.type==='invest' && a.marketValue) ? parseFloat(a.marketValue) : (bals[a.id]||0); if(a.currency!=='TWD') v *= (exchangeRates[a.currency]||1); totalAsset+=v; } });
                return { bals, totalAsset, inc, exp, debt, advanceMap };
            }, [accounts, transactions, currentLedgerMonth, currentBook, exchangeRates]);

            const retireProgress = useMemo(() => {
                const years = Math.max(0, retirement.retireAge - retirement.currentAge);
                const target = retirement.monthlyExpense * Math.pow(1 + (retirement.inflation/100), years) * 12 * 25;
                const pct = target > 0 ? Math.min(100, (stats.totalAsset / target) * 100) : 0;
                return { target, pct, years };
            }, [retirement, stats.totalAsset]);

            const homeInsight = useMemo(() => {
                const saving = stats.inc - stats.exp;
                if (saving < 0) return { type:'danger', icon:'alert-triangle', text:`‚ö†Ô∏è ÈÄèÊîØ $${Math.abs(saving)}` };
                if (stats.exp > monthlyBudget) return { type:'danger', icon:'alert-triangle', text:`‚ö†Ô∏è Ë∂ÖÂá∫È†êÁÆó $${stats.exp - monthlyBudget}` };
                return { type:'success', icon:'thumbs-up', text:`‚úÖ È†êÁÆóÂâ©È§ò $${monthlyBudget - stats.exp}` };
            }, [stats, monthlyBudget]);
            
            const retirementInsight = useMemo(() => {
                const savings = stats.inc - stats.exp;
                if (savings < 0) return { icon: 'alert-triangle', text: `‚ö†Ô∏è Êú¨ÊúàÈÄèÊîØÔºåË≥áÁî¢Á∏ÆÊ∞¥‰∏≠ÔºÅ`, color: 'text-rose-400', bg: 'bg-rose-500/20' };
                if (savings < retirement.monthlyExpense) return { icon: 'target', text: `üéØ Èõ¢ÊúàÂ≠òÈ°çÁõÆÊ®ôÈÇÑÊúâÂ∑ÆË∑ùÔºåÂä†Ê≤πÔºÅ`, color: 'text-amber-400', bg: 'bg-amber-500/20' };
                return { icon: 'party-popper', text: `üöÄ Â§™Ê£í‰∫ÜÔºÅÂÑ≤ËìÑÂäõË∂ÖÊ®ôÔºÅ`, color: 'text-emerald-400', bg: 'bg-emerald-500/20' };
            }, [stats, retirement, currentLedgerMonth]);

            const analysisData = useMemo(() => {
                const bookTxs = transactions.filter(tx => (tx.bookId || 'main') === currentBook.id);
                let filteredTx = [];
                if (analysisMode === 'month') { filteredTx = bookTxs.filter(t => t.date.substring(0, 7) === currentLedgerMonth); } 
                else if (analysisMode === 'year') { const year = currentLedgerMonth.split('-')[0]; filteredTx = bookTxs.filter(t => t.date.substring(0, 4) === year); }

                const targetTx = filteredTx.filter(t => t.type === analysisType);
                const total = targetTx.reduce((sum, t) => sum + (parseFloat(t.amount)||0), 0);
                
                const byCat = {};
                targetTx.forEach(t => {
                    const k = (analysisGroupBy === 'sub' && t.subCategory) ? t.subCategory : t.category;
                    byCat[k] = (byCat[k] || 0) + parseFloat(t.amount);
                });

                const chart = Object.entries(byCat).map(([name, val]) => {
                    let color = CATEGORY_COLORS[name];
                    if (!color) {
                         const parentCat = categories[analysisType] && categories[analysisType].find(c => c.subs && c.subs.includes(name));
                         if (parentCat) color = CATEGORY_COLORS[parentCat.name];
                    }
                    return { name, value: val, percent: total ? (val/total)*100 : 0, color: color || '#94a3b8' };
                }).sort((a,b) => b.value - a.value);

                return { total, chart, filteredTx: targetTx };
            }, [transactions, analysisMode, currentLedgerMonth, currentBook, analysisType, analysisGroupBy, categories]);

            // --- Group Transactions by Date (New Feature) ---
            const groupedTransactions = useMemo(() => {
                const targetTxs = transactions.filter(t => (t.bookId||'main')===currentBook.id && t.date.startsWith(currentLedgerMonth));
                const groups = {};
                targetTxs.forEach(tx => {
                    if (!groups[tx.date]) groups[tx.date] = [];
                    groups[tx.date].push(tx);
                });
                // Sort dates descending
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
            }, [transactions, currentBook, currentLedgerMonth]);

            const getDayOfWeek = (dateStr) => {
                const days = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'];
                return days[new Date(dateStr).getDay()];
            };

            // Handlers
            const handleTxSave = () => {
                const amt = parseFloat(txForm.amount);
                if (!amt) { alert('Ë´ãËº∏ÂÖ•ÈáëÈ°ç'); return; }
                if (!txForm.accountId && !isOffset) { alert('Ë´ãÈÅ∏ÊìáÂ∏≥Êà∂'); return; }

                let finalCategory = txForm.category;
                if (!finalCategory) {
                    if (categories[txForm.type] && categories[txForm.type].length > 0) finalCategory = categories[txForm.type][0].name;
                    else finalCategory = 'Êú™ÂàÜÈ°û';
                }

                // If editing, use existing createdAt, otherwise use current
                const createdAt = editingTx ? editingTx.createdAt : new Date().toISOString();
                
                const base = { ...txForm, bookId: currentBook.id, amount: amt, category: finalCategory, createdAt };
                
                // If editing existing transaction, just update it
                if (editingTx) {
                    saveData('transactions', base, editingTx.id);
                    setModal(null);
                    setEditingTx(null);
                    return;
                }

                // Handle Offset
                if (isOffset && offsetTargetId) {
                    const expenseTx = { ...base, accountId: OFFSET_ACCOUNT_ID, note: `ÊäµÊâ£: ${txForm.note}` };
                    saveData('transactions', expenseTx); // Create Expense
                    saveData('transactions', {
                        type: 'repayment', amount: amt, accountId: OFFSET_ACCOUNT_ID, relatedTxId: offsetTargetId,
                        date: txForm.date, bookId: currentBook.id, note: `ÊäµÊâ£ÊîØÂá∫ (${finalCategory})`, createdAt: new Date().toISOString()
                    }); // Create Repayment
                    setModal(null);
                    return;
                }

                // Handle Installment / Advance / Normal
                if (txForm.type === 'expense' && installment.enabled) {
                    const p = parseInt(installment.periods);
                    const per = Math.round(amt / p);
                    for (let i = 0; i < p; i++) {
                        saveData('transactions', { ...base, amount: (i===0?amt-(per*p)+per:per), date: addMonths(txForm.date, i), note: `${txForm.note} (${i+1}/${p})`, createdAt: new Date().toISOString() });
                    }
                } else if (txForm.type === 'expense' && isAdvanceSplit) {
                     let advTotal = 0;
                     splitData.advances.forEach(a => {
                         if (a.debtor && a.amount) {
                             saveData('transactions', { ...base, type:'advance', amount: parseFloat(a.amount), debtor: a.debtor, isSettled: false, note: `‰ª£Â¢ä: ${txForm.note}`, createdAt: new Date().toISOString() });
                             advTotal += parseFloat(a.amount);
                         }
                     });
                     const myExp = amt - advTotal;
                     if (myExp > 0) saveData('transactions', { ...base, amount: myExp, createdAt: new Date().toISOString() });
                } else if (txForm.type === 'income' && isAdvanceSplit) {
                    const principal = parseFloat(splitData.principalAmount) || 0;
                    const gain = amt - principal;
                    if (principal > 0) saveData('transactions', { ...base, type: 'transfer', amount: principal, category: 'ËΩâÂ∏≥', accountId: splitData.sourceAccountId, toAccountId: txForm.accountId, note: `ÊäïË≥áÊú¨Èáë`, createdAt: new Date().toISOString() });
                    if (gain !== 0) saveData('transactions', { ...base, type: 'income', amount: gain, category: txForm.category || 'ÊäïË≥á', note: `ÊäïË≥áÁç≤Âà©`, createdAt: new Date().toISOString() });
                } else {
                    saveData('transactions', base);
                }
                setModal(null);
            };
            
            const handleAddSubCategory = async (mainCat, sub) => {
                if(!sub) return;
                const newCats = {...categories};
                const cat = newCats[editingCategoryType].find(c=>c.name===mainCat);
                if(cat && !cat.subs.includes(sub)) { cat.subs.push(sub); setCategories(newCats); await saveData('settings', {categories:newCats}, 'config'); }
            };

            const handleDeleteSubCategory = async (mainCat, sub) => {
                const newCats = {...categories};
                const cat = newCats[editingCategoryType].find(c=>c.name===mainCat);
                if(cat) { cat.subs = cat.subs.filter(s => s !== sub); setCategories(newCats); await saveData('settings', {categories:newCats}, 'config'); }
            };
            
            const handleAccSubmit = async (e) => {
                e.preventDefault();
                if (!accForm.name) return;
                const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                const accountData = { ...accForm, order: editingAccount ? editingAccount.order : accounts.length };
                if (editingAccount) { await fbRef.current.updateDoc(fbRef.current.doc(userRef, 'accounts', editingAccount.id), accountData); } 
                else { await fbRef.current.addDoc(fbRef.current.collection(userRef, 'accounts'), { ...accountData, createdAt: new Date().toISOString() }); }
                setModal(null);
            };
            
            const handleSort = async () => {
                if (dragItem.current === null || dragOverItem.current === null) return;
                const _accounts = [...accounts];
                const draggedItemContent = _accounts[dragItem.current];
                _accounts.splice(dragItem.current, 1);
                _accounts.splice(dragOverItem.current, 0, draggedItemContent);
                dragItem.current = null; dragOverItem.current = null;
                setAccounts(_accounts);
                const batch = fbRef.current.writeBatch(dbRef.current);
                const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                _accounts.forEach((acc, index) => { const ref = fbRef.current.doc(userRef, 'accounts', acc.id); batch.update(ref, { order: index }); });
                await batch.commit();
            };

            const handleUpdateMarketValue = async () => {
                if (!editTarget) return;
                const accRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'accounts', editTarget.id);
                await fbRef.current.updateDoc(accRef, { marketValue: parseFloat(newMarketValue) || 0 });
                setModal(null);
            };
            
            const handleBudgetSubmit = (val) => { setMonthlyBudget(val); saveData('settings', { budget: parseFloat(val) }, 'config'); };
            const handleAddCategory = () => { if(!newCatForm.name) return; const newCats = {...categories}; newCats[newCatForm.type].push({ name: newCatForm.name, icon: newCatForm.icon, subs: [] }); setCategories(newCats); saveData('settings', {categories: newCats}, 'config'); };
            const handleDeleteCategory = (catName) => { const newCats = {...categories}; newCats[editingCategoryType] = newCats[editingCategoryType].filter(c => c.name !== catName); setCategories(newCats); saveData('settings', {categories: newCats}, 'config'); };
            const handleRatesSubmit = () => { saveData('settings', exchangeRates, 'rates'); setModal(null); };

            const updateAdvanceRow = (index, field, value) => { const newAdvances = [...splitData.advances]; newAdvances[index][field] = value; setSplitData({...splitData, advances: newAdvances}); };
            const addAdvanceRow = () => { setSplitData({...splitData, advances: [...splitData.advances, { debtor: '', amount: '' }]}); };
            const removeAdvanceRow = (index) => { if (splitData.advances.length <= 1) return; const newAdvances = splitData.advances.filter((_, i) => i !== index); setSplitData({...splitData, advances: newAdvances}); };

            const openTxModal = (type = 'expense', existingTx = null) => {
                 if (existingTx) {
                     setEditingTx(existingTx);
                     setTxForm({
                         ...existingTx,
                         // Ensure accountId is present, or default to first account
                         accountId: existingTx.accountId || (accounts.length > 0 ? accounts[0].id : ''),
                     });
                     // Disable advanced features when editing for simplicity
                     setIsAdvanceSplit(false); 
                     setIsOffset(false);
                     setInstallment({ enabled: false, periods: 3 });
                 } else {
                     setEditingTx(null);
                     setTxForm({ 
                         ...txForm, 
                         type, 
                         category: categories[type] && categories[type].length > 0 ? categories[type][0].name : '',
                         accountId: accounts.length > 0 ? accounts[0].id : '',
                         amount: '',
                         note: '',
                         date: getLocalToday()
                     });
                     setIsAdvanceSplit(false); 
                     setIsOffset(false);
                     setSplitData({ advances:[{debtor:'',amount:''}], principalAmount:'', sourceAccountId:'' }); 
                 }
                 setModal('tx');
            };
            
            const changeMonthStep = (step) => {
                const [y, m] = currentLedgerMonth.split('-').map(Number);
                const date = new Date(y, m - 1 + step, 1);
                const ny = date.getFullYear();
                const nm = String(date.getMonth() + 1).padStart(2, '0');
                setCurrentLedgerMonth(`${ny}-${nm}`);
            };
            
            const handleEditMainCategoryName = async (newName) => {
                if (!newName || !editingCategory) return;
                const newCats = { ...categories };
                const catIdx = newCats[editingCategoryType].findIndex(c => c.name === editingCategory.name);
                if (catIdx > -1) { newCats[editingCategoryType][catIdx].name = newName; setCategories(newCats); setEditingCategory(newCats[editingCategoryType][catIdx]); await saveData('settings', { categories: newCats }, 'config'); }
            };
            
            const handleEditMainCategoryIcon = async (newIcon) => {
                if (!editingCategory) return;
                const newCats = { ...categories };
                const catIdx = newCats[editingCategoryType].findIndex(c => c.name === editingCategory.name);
                if (catIdx > -1) { newCats[editingCategoryType][catIdx].icon = newIcon; setCategories(newCats); setEditingCategory(newCats[editingCategoryType][catIdx]); await saveData('settings', { categories: newCats }, 'config'); }
            };

            if (needConfig) return (
                <div className="min-h-screen bg-stone-50 flex items-center justify-center p-6"><div className="bg-white max-w-md w-full p-8 rounded-3xl shadow-xl"><div className="flex justify-center mb-6 text-stone-800"><Icon name="settings" size={48}/></div><h2 className="text-xl font-bold text-center mb-4">Ëº∏ÂÖ• Firebase Ë®≠ÂÆö</h2><textarea className="w-full h-48 p-4 bg-stone-50 rounded-xl text-xs font-mono mb-4 border" placeholder='{ "apiKey": "..." }' value={configInput} onChange={e=>setConfigInput(e.target.value)}/><button onClick={handleSaveConfig} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold">ÂÑ≤Â≠ò</button></div></div>
            );
            if (!sdkReady || loading) return <div className="h-screen flex items-center justify-center bg-stone-50"><Icon name="loader-2" className="animate-spin text-stone-500" size={40}/></div>;

            return (
                <div className="min-h-screen pb-24 max-w-xl mx-auto bg-stone-50 relative">
                    <Header currentBook={currentBook} setIsBookSelectOpen={()=>setModal('bookSelect')} user={user} handleGoogleLogin={handleGoogleLogin} />
                    
                    <main className="p-4 space-y-6">
                        {activeTab === 'home' && (
                            <div className="animate-in space-y-6">
                                <div className="flex items-center justify-between bg-white rounded-xl p-2 shadow-sm border border-stone-200">
                                    <button onClick={()=>changeMonthStep(-1)} className="p-2 hover:bg-stone-50 rounded-lg text-stone-400"><Icon name="chevron-left"/></button>
                                    <div className="text-center font-bold text-stone-800 text-lg">
                                        {currentLedgerMonth.replace('-','Âπ¥ ')}Êúà
                                    </div>
                                    <button onClick={()=>changeMonthStep(1)} className="p-2 hover:bg-stone-50 rounded-lg text-stone-400"><Icon name="chevron-right"/></button>
                                </div>
                                <div className={`rounded-xl p-6 text-white shadow-lg relative overflow-hidden bg-gradient-to-br from-orange-400 to-rose-600`}>
                                    <p className="text-white/80 text-xs mb-1">Êú¨ÊúàÁµêÈ§ò</p>
                                    <h2 className="text-4xl font-black tabular-nums">${(stats.inc - stats.exp).toLocaleString()}</h2>
                                    <div className="flex gap-4 mt-6">
                                        <div className="flex-1 p-3 bg-white/20 rounded-lg backdrop-blur-sm"><p className="text-xs text-white/80">Êî∂ÂÖ•</p><p className="font-bold text-white">+${stats.inc.toLocaleString()}</p></div>
                                        <div className="flex-1 p-3 bg-white/20 rounded-lg backdrop-blur-sm"><p className="text-xs text-white/80">ÊîØÂá∫</p><p className="font-bold text-white">-${stats.exp.toLocaleString()}</p></div>
                                    </div>
                                    <div className="mt-4 bg-white p-2 rounded-lg text-xs flex items-center gap-2 font-bold text-stone-700 shadow-sm"><Icon name={homeInsight.icon} size={14} className="text-rose-500"/> {homeInsight.text}</div>
                                </div>
                                
                                {/* Grouped Transaction List */}
                                <div className="space-y-4">
                                    {groupedTransactions.length === 0 ? (
                                        <div className="text-center py-16 text-stone-400 text-sm border-2 border-dashed border-stone-200 rounded-xl bg-white">Êú¨ÊúàÂ∞öÁÑ°Á¥ÄÈåÑ</div>
                                    ) : (
                                        groupedTransactions.map(([date, txs]) => (
                                            <div key={date} className="animate-in slide-in-from-bottom">
                                                <div className="flex items-center gap-2 mb-2 px-1">
                                                    <span className="text-xs font-bold text-stone-400 bg-stone-100 px-2 py-1 rounded-md tabular-nums">{date}</span>
                                                    <span className="text-xs font-bold text-stone-400">{getDayOfWeek(date)}</span>
                                                </div>
                                                <div className="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                                                    {txs.map((tx, idx) => (
                                                        <div 
                                                            key={tx.id} 
                                                            onClick={() => openTxModal(tx.type, tx)}
                                                            className={`p-4 flex justify-between items-center cursor-pointer hover:bg-stone-50 transition-colors ${idx !== txs.length - 1 ? 'border-b border-stone-50' : ''}`}
                                                        >
                                                            <div className="flex items-center gap-3">
                                                                <div className={`p-2.5 rounded-xl ${tx.type==='income'?'bg-emerald-50 text-emerald-600': tx.type==='advance'?'bg-indigo-50 text-indigo-600' : 'bg-stone-100 text-stone-600'}`}>
                                                                    <Icon name={getCategoryIcon(tx.category, tx.type)} size={18}/>
                                                                </div>
                                                                <div>
                                                                    <p className="font-bold text-sm text-stone-800">
                                                                        {tx.type === 'advance' ? `‰ª£Â¢ä: ${tx.debtor}` : (tx.category || 'Êú™ÂàÜÈ°û')} 
                                                                        {tx.subCategory && <span className="text-xs text-stone-400 ml-1">({tx.subCategory})</span>}
                                                                    </p>
                                                                    <p className="text-xs text-stone-400 mt-0.5">{tx.note}</p>
                                                                </div>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className={`font-bold tabular-nums ${tx.type==='income'?'text-emerald-600':'text-stone-800'}`}>{tx.type==='income'?'+':'-'}{parseFloat(tx.amount).toLocaleString()}</p>
                                                                <div className="flex justify-end gap-3 mt-1" onClick={e => e.stopPropagation()}>
                                                                     <button onClick={()=>deleteData('transactions', tx.id)} className="text-stone-300 hover:text-rose-500"><Icon name="trash-2" size={14}/></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                        {activeTab === 'assets' && (
                            <div className="animate-in space-y-4">
                                <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-stone-800">ÊàëÁöÑÂ∏≥Êà∂</h2><button onClick={()=>{setEditTarget(null); setAccForm({name:'', type:'cash', currency:'TWD', initialBalance:'', includeInTotal: true}); setModal('acc')}}><Icon name="plus-circle" className="text-rose-500"/></button></div>
                                <div className="bg-stone-800 rounded-xl p-5 text-white shadow-lg">
                                    <div className="flex justify-between mb-2"><span className="text-xs text-stone-400">FIRE ÈÄ≤Â∫¶</span><span className="font-bold">{retireProgress.pct.toFixed(1)}%</span></div>
                                    <div className="h-2 bg-stone-700 rounded-full overflow-hidden mb-2"><div className="h-full bg-gradient-to-r from-yellow-400 to-rose-500" style={{width:`${Math.min(100, retireProgress.pct)}%`}}></div></div>
                                    <p className="text-xs text-stone-400 flex justify-between"><span>ÁõÆÊ®ô ${Math.round(retireProgress.target/10000).toLocaleString()} Ëê¨</span><span>Ââ© {retireProgress.years} Âπ¥</span></p>
                                    <div className={`mt-3 p-2 rounded-lg bg-white/10 text-xs flex items-start gap-2 ${retirementInsight.color}`}>
                                        <Icon name={retirementInsight.icon} size={14} className="mt-0.5"/>
                                        <span>{retirementInsight.text}</span>
                                    </div>
                                </div>
                                <div className="grid gap-3">{accounts.map((acc, index) => (
                                    <div 
                                        key={acc.id} 
                                        className="bg-white p-4 rounded-xl shadow-sm border border-stone-100 relative cursor-move hover:shadow-md transition-shadow"
                                        draggable
                                        onDragStart={() => (dragItem.current = index)}
                                        onDragEnter={() => (dragOverItem.current = index)}
                                        onDragEnd={handleSort}
                                        onDragOver={(e) => e.preventDefault()}
                                    >
                                        <div className="absolute top-3 right-3 flex gap-2">
                                            <button onClick={()=>{setEditTarget(acc); openAccModalCorrect(acc);}} className="text-stone-400 hover:text-rose-500"><Icon name="edit-2" size={14}/></button>
                                            <button onClick={()=>deleteData('accounts', acc.id)} className="text-stone-400 hover:text-rose-600"><Icon name="trash-2" size={14}/></button>
                                        </div>
                                        <div className="flex gap-3 items-center mb-2">
                                            <div className="text-stone-300 cursor-move"><Icon name="grip-vertical" size={16}/></div>
                                            <div className={`p-2 rounded-lg ${ACCOUNT_TYPES[acc.type]?.color || 'bg-stone-100 text-stone-600'}`}><Icon name={ACCOUNT_TYPES[acc.type]?.iconName || 'wallet'} size={18}/></div>
                                            <div>
                                                <h3 className="font-bold text-stone-700">{acc.name}</h3>
                                                {acc.includeInTotal === false && <span className="text-[10px] bg-stone-100 text-stone-400 px-1 rounded">‰∏çË®àÂÖ•</span>}
                                            </div>
                                        </div>
                                        <p className="text-2xl font-black tabular-nums text-stone-800 ml-7">${(acc.marketValue || stats.bals[acc.id]||0).toLocaleString()} <span className="text-xs text-stone-400 font-normal">{acc.currency}</span></p>
                                        {acc.currency!=='TWD' && <p className="text-xs text-stone-400 font-bold tabular-nums ml-7">‚âà TWD ${Math.round((acc.marketValue || stats.bals[acc.id]||0) * (exchangeRates[acc.currency]||1)).toLocaleString()}</p>}
                                        {acc.type === 'invest' && (
                                            <div className="mt-2 pt-2 border-t flex justify-between items-center text-xs ml-7">
                                                <span className="text-stone-400">ÊàêÊú¨: ${(stats.bals[acc.id]||0).toLocaleString()}</span>
                                                <button onClick={()=>{setEditTarget(acc); setNewMarketValue(acc.marketValue||''); setModal('market')}} className="text-rose-500 font-bold bg-rose-50 px-2 py-1 rounded">Ë™øÊï¥Â∏ÇÂÄº</button>
                                            </div>
                                        )}
                                    </div>
                                ))}</div>
                            </div>
                        )}
                        {/* Settings, Analysis, Debts tabs same as V15.3, omitted for brevity but preserved structure */}
                        {activeTab === 'settings' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold text-stone-800">Ë®≠ÂÆö</h2>
                                <button onClick={()=>setModal('budget')} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700"><div>ÊúàÈ†êÁÆóË®≠ÂÆö <span className="text-xs text-stone-400 font-normal block">ÁõÆÂâç: ${monthlyBudget.toLocaleString()}</span></div><Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>{setRetireForm(retirement); setModal('retire')}} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700"><div>ÈÄÄ‰ºëË®àÁï´ <span className="text-xs text-stone-400 font-normal block">{retirement.retireAge}Ê≠≤ÈÄÄ‰ºë / ÊúàËä±Ë≤ª${retirement.monthlyExpense}</span></div><Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>setModal('cat')} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700">È°ûÂà•ÁÆ°ÁêÜ <Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>setModal('rate')} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700">ÂåØÁéáË®≠ÂÆö <Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>{localStorage.removeItem('my_ledger_firebase_config');window.location.reload()}} className="w-full bg-red-50 text-red-600 p-4 rounded-xl font-bold mt-8 text-center border border-red-100">ÈáçË®≠ App ÈÄ£Á∑ö</button>
                            </div>
                        )}
                        {activeTab === 'analysis' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold text-stone-800 px-1">Êî∂ÊîØÂàÜÊûê</h2>
                                <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100 space-y-3">
                                    <div className="flex justify-between items-center bg-stone-50 rounded-lg p-1">
                                        <button onClick={()=>changeMonthStep(-1)} className="p-2 text-stone-400"><Icon name="chevron-left"/></button>
                                        <div className="relative">
                                            <span className="font-bold text-stone-700">{currentLedgerMonth.replace('-','Âπ¥ ')}Êúà</span>
                                            <input type="month" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" value={currentLedgerMonth} onChange={e=>setCurrentLedgerMonth(e.target.value)} />
                                        </div>
                                        <button onClick={()=>changeMonthStep(1)} className="p-2 text-stone-400"><Icon name="chevron-right"/></button>
                                    </div>
                                    <div className="flex bg-stone-100 p-1 rounded-lg">
                                        <button onClick={()=>setAnalysisType('expense')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisType==='expense'?'bg-white text-rose-500 shadow':'text-stone-400'}`}>ÊîØÂá∫</button>
                                        <button onClick={()=>setAnalysisType('income')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisType==='income'?'bg-white text-emerald-500 shadow':'text-stone-400'}`}>Êî∂ÂÖ•</button>
                                    </div>
                                    <div className="flex bg-stone-100 p-1 rounded-lg">
                                        <button onClick={()=>setAnalysisGroupBy('main')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisGroupBy==='main'?'bg-white text-stone-800 shadow':'text-stone-400'}`}>‰æù‰∏ªÂàÜÈ°û</button>
                                        <button onClick={()=>setAnalysisGroupBy('sub')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisGroupBy==='sub'?'bg-white text-stone-800 shadow':'text-stone-400'}`}>‰æùÂ≠êÂàÜÈ°û</button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-stone-100 flex flex-col items-center">
                                    {/* Pie Chart SVG */}
                                    <div className="relative h-48 w-48 mb-4">
                                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                                            {(() => {
                                                if (analysisData.chart.length === 1 && analysisData.chart[0].value > 0) {
                                                     return <circle cx="50" cy="50" r="40" fill={analysisData.chart[0].color} />;
                                                }
                                                let cumulative = 0;
                                                return analysisData.chart.map((d, i) => {
                                                    const startA = cumulative * Math.PI * 2; cumulative += d.percent / 100; const endA = cumulative * Math.PI * 2;
                                                    const x1 = 50 + 40 * Math.cos(startA), y1 = 50 + 40 * Math.sin(startA), x2 = 50 + 40 * Math.cos(endA), y2 = 50 + 40 * Math.sin(endA);
                                                    const largeArc = d.percent > 50 ? 1 : 0;
                                                    return <path key={i} d={`M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={d.color} stroke="#fff" strokeWidth="1" onClick={() => setSelectedCategory(d.name)} style={{cursor: 'pointer'}} />;
                                                });
                                            })()}
                                            {analysisData.total === 0 && <circle cx="50" cy="50" r="40" fill="#f5f5f4" />}
                                            <circle cx="50" cy="50" r="28" fill="white" />
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <p className="text-[10px] text-stone-400 font-bold uppercase">Á∏ΩÈ°ç</p>
                                            <p className="text-sm font-black tabular-nums text-stone-800">${analysisData.total.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div className="w-full space-y-2">
                                        {analysisData.chart.map(d=>(
                                            <div key={d.name} className="flex items-center gap-2 text-sm">
                                                <div className="w-3 h-3 rounded-full" style={{backgroundColor:d.color}}></div>
                                                <div className="flex-1 font-bold text-stone-700">{d.name}</div>
                                                <div className="font-bold tabular-nums text-stone-800">${d.value.toLocaleString()}</div>
                                                <div className="text-xs text-stone-400 w-8 text-right">{Math.round(d.percent)}%</div>
                                            </div>
                                        ))}
                                        {analysisData.total === 0 && <p className="text-center text-stone-400 text-xs py-2">Êú¨ÊúàÂ∞öÁÑ°Á¥ÄÈåÑ</p>}
                                    </div>
                                </div>
                                {/* Drill down list if category selected */}
                                {selectedCategory && (
                                    <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
                                        <div className="flex justify-between mb-2 items-center">
                                            <h3 className="font-bold text-stone-700">{selectedCategory} ÊòéÁ¥∞</h3>
                                            <button onClick={()=>setSelectedCategory(null)} className="text-stone-400"><Icon name="x" size={16}/></button>
                                        </div>
                                        {analysisData.filteredTx.filter(t=>t.category===selectedCategory || t.subCategory===selectedCategory).map(tx=>(
                                            <div key={tx.id} className="flex justify-between py-2 border-b last:border-0 text-sm">
                                                <span className="text-stone-500 tabular-nums">{tx.date}</span>
                                                <span className="truncate flex-1 mx-2 text-stone-700">{tx.note || tx.subCategory || '-'}</span>
                                                <span className="font-bold tabular-nums text-stone-800">${parseFloat(tx.amount).toLocaleString()}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'debts' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold px-1 text-stone-800">‰ª£Â¢äËàáÂæÖÊî∂</h2>
                                <div className="bg-teal-600 rounded-xl p-6 text-white shadow-md">
                                    <p className="text-xs opacity-80 font-bold uppercase tracking-widest mb-1">ÂæÖÊî∂Á∏ΩÈ°ç</p>
                                    <h2 className="text-4xl font-black tabular-nums">${stats.debt.toLocaleString()}</h2>
                                </div>
                                <div className="space-y-3">
                                    {transactions.filter(t => t.type === 'advance' && getRemainingDebt(t.id) > 1).map(tx => (
                                        <div key={tx.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-teal-500 flex justify-between items-center">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1"><span className="bg-teal-50 text-teal-700 px-2 py-0.5 rounded text-xs font-bold">Â∞çË±°: {tx.debtor}</span><span className="text-xs text-stone-400 tabular-nums">{tx.date}</span></div>
                                                <p className="font-bold text-lg text-stone-800 tabular-nums">${getRemainingDebt(tx.id).toLocaleString()}</p>
                                                <p className="text-xs text-stone-500">{tx.note || 'ÁÑ°ÂÇôË®ª'}</p>
                                            </div>
                                            <button onClick={() => { setSettleTargetTx({ ...tx, amount: getRemainingDebt(tx.id) }); setModal('settle'); }} className="bg-stone-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-stone-700">Êî∂Ê¨æ</button>
                                        </div>
                                    ))}
                                    {transactions.filter(t => t.type === 'advance' && getRemainingDebt(t.id) > 1).length===0 && <div className="text-center py-10 text-stone-400 text-sm">ÁÑ°ÂæÖÊî∂È†ÖÁõÆ</div>}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-0 w-full bg-white border-t border-stone-200 px-6 py-3 flex justify-between z-[100] pb-safe max-w-xl mx-auto left-0 right-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <NavBtn icon={<Icon name="home"/>} label="Â∏≥Êú¨" active={activeTab==='home'} onClick={()=>setActiveTab('home')}/>
                        <NavBtn icon={<Icon name="pie-chart"/>} label="ÂàÜÊûê" active={activeTab==='analysis'} onClick={()=>setActiveTab('analysis')}/>
                        <NavBtn icon={<Icon name="credit-card"/>} label="ÂæÖÊî∂" active={activeTab==='debts'} onClick={()=>setActiveTab('debts')}/>
                        <NavBtn icon={<Icon name="landmark"/>} label="Â∏≥Êà∂" active={activeTab==='assets'} onClick={()=>setActiveTab('assets')}/>
                        <NavBtn icon={<Icon name="settings"/>} label="Ë®≠ÂÆö" active={activeTab==='settings'} onClick={()=>setActiveTab('settings')}/>
                    </nav>

                    {/* FAB (Fire Theme) */}
                    {activeTab === 'home' && <button onClick={()=>openTxModal('expense')} className="fixed bottom-24 right-6 bg-gradient-to-r from-orange-500 to-rose-500 text-white p-4 rounded-full shadow-lg z-[100] transition-transform active:scale-95 border-2 border-white"><Icon name="plus" size={32}/></button>}

                    {/* --- Modals (All z-[200] to ensure top) --- */}
                    
                    {/* TX Modal */}
                    {modal === 'tx' && (
                        <div className="fixed inset-0 z-[200] bg-black/50 flex items-end sm:items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-in slide-in-from-bottom max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-xl mb-4 text-stone-800">{editingTx ? 'Á∑®ËºØÁ¥ÄÈåÑ' : 'Ë®ò‰∏ÄÁ≠Ü'}</h3>
                                <input type="number" className="w-full text-4xl font-black mb-4 outline-none tabular-nums text-stone-800 placeholder-stone-300" placeholder="0" value={txForm.amount} onChange={e=>setTxForm({...txForm, amount:e.target.value})} autoFocus />
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <button onClick={()=>{setTxForm({...txForm, type:'expense', category: categories['expense'][0].name});}} className={`p-3 rounded-lg font-bold ${txForm.type==='expense'?'bg-rose-100 text-rose-600':'bg-stone-100 text-stone-500'}`}>ÊîØÂá∫</button>
                                    <button onClick={()=>{setTxForm({...txForm, type:'income', category: categories['income'][0].name});}} className={`p-3 rounded-lg font-bold ${txForm.type==='income'?'bg-emerald-100 text-emerald-600':'bg-stone-100 text-stone-500'}`}>Êî∂ÂÖ•</button>
                                </div>
                                <div className="space-y-4">
                                    <div className="flex gap-2">
                                        <select className="flex-1 bg-stone-50 p-3 rounded-lg font-bold text-stone-700" value={txForm.category} onChange={e=>{
                                            if(e.target.value === 'ADD_NEW') {
                                                setEditingCategoryType(txForm.type); 
                                                setModal('cat');
                                            } else {
                                                setTxForm({...txForm, category:e.target.value});
                                            }
                                        }}>
                                            {categories[txForm.type].map(c=><option key={c.name} value={c.name}>{c.name}</option>)}
                                            <option value="ADD_NEW">‚ûï Êñ∞Â¢ûÈ°ûÂà•...</option>
                                        </select>
                                        <button 
                                            onClick={()=>{setEditingCategoryType(txForm.type); setModal('cat');}} 
                                            className="px-3 bg-stone-100 rounded-lg text-stone-500 hover:bg-stone-200 flex items-center justify-center"
                                            title="ÁÆ°ÁêÜÈ°ûÂà•"
                                        >
                                            <Icon name="plus" size={20}/>
                                        </button>
                                    </div>
                                    {/* Sub Categories */}
                                    {categories[txForm.type].find(c=>c.name===txForm.category)?.subs?.length > 0 && (
                                        <div className="flex flex-wrap gap-2">
                                            {categories[txForm.type].find(c=>c.name===txForm.category).subs.map(s=>(
                                                <button key={s} onClick={()=>setTxForm({...txForm, subCategory:s})} className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${txForm.subCategory===s?'bg-stone-800 text-white':'bg-white text-stone-500'}`}>{s}</button>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {!isOffset ? (
                                        <select className="w-full bg-stone-50 p-3 rounded-lg font-bold text-stone-700" value={txForm.accountId} onChange={e=>setTxForm({...txForm, accountId:e.target.value})}>
                                            <option value="">ÈÅ∏ÊìáÂ∏≥Êà∂</option>
                                            {accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}
                                        </select>
                                    ) : (
                                        <select className="w-full bg-rose-50 border-rose-200 p-3 rounded-lg font-bold text-rose-700" value={offsetTargetId} onChange={e=>setOffsetTargetId(e.target.value)}>
                                            <option value="">ÈÅ∏ÊìáÂæÖÊî∂Â∞çË±°...</option>
                                            {Object.values(stats.advanceMap).filter(a => !a.isSettled && a.remaining > 0.1).map(adv => (
                                                <option key={adv.id} value={adv.id}>{adv.debtor} (Ââ©È§ò ${adv.remaining})</option>
                                            ))}
                                        </select>
                                    )}

                                    <div className="flex items-center gap-2">
                                        <input type="date" className="bg-stone-50 p-3 rounded-lg flex-1 font-bold text-stone-700" value={txForm.date} onChange={e=>setTxForm({...txForm, date:e.target.value})} />
                                        <input className="bg-stone-50 p-3 rounded-lg flex-[2] font-bold text-stone-700" placeholder="ÂÇôË®ª" value={txForm.note} onChange={e=>setTxForm({...txForm, note:e.target.value})} />
                                    </div>
                                    
                                    {/* Advanced Options (Only show when adding new, hide when editing for safety) */}
                                    {!editingTx && txForm.type === 'expense' && (
                                        <div className="space-y-2 pt-2 border-t border-stone-100">
                                            <label className="flex items-center justify-between p-2">
                                                <span className="text-sm font-bold text-stone-500">‰ΩøÁî®ÂæÖÊî∂ÊäµÊâ£ (‰∫íÊäµ)</span>
                                                <input type="checkbox" checked={isOffset} onChange={e=>{
                                                    setIsOffset(e.target.checked);
                                                    if(e.target.checked) {
                                                        setIsAdvanceSplit(false); 
                                                        setInstallment({...installment, enabled: false});
                                                    }
                                                }} />
                                            </label>

                                            {!isOffset && (
                                            <>
                                                <label className="flex items-center justify-between p-2">
                                                    <span className="text-sm font-bold text-stone-500">ÂàÜÊúü‰ªòÊ¨æ</span>
                                                    <input type="checkbox" checked={installment.enabled} onChange={e=>setInstallment({...installment, enabled:e.target.checked})} />
                                                </label>
                                                {installment.enabled && <select className="w-full bg-white border p-2 rounded" value={installment.periods} onChange={e=>setInstallment({...installment, periods:e.target.value})}><option value="3">3 Êúü</option><option value="6">6 Êúü</option><option value="12">12 Êúü</option></select>}
                                                <label className="flex items-center justify-between p-2">
                                                    <span className="text-sm font-bold text-stone-500">‰ª£Â¢äÊ¨æ (Â§ö‰∫∫)</span>
                                                    <input type="checkbox" checked={isAdvanceSplit} onChange={e=>setIsAdvanceSplit(e.target.checked)} />
                                                </label>
                                                {isAdvanceSplit && (
                                                    <div className="p-2 bg-stone-50 rounded space-y-2">
                                                        {splitData.advances.map((adv, idx) => (
                                                            <div key={idx} className="flex gap-2">
                                                                <input placeholder="Â∞çË±°" className="border p-2 rounded w-1/2 text-sm" value={adv.debtor} onChange={e=>updateAdvanceRow(idx, 'debtor', e.target.value)} />
                                                                <input type="number" placeholder="ÈáëÈ°ç" className="border p-2 rounded w-1/3 text-sm tabular-nums" value={adv.amount} onChange={e=>updateAdvanceRow(idx, 'amount', e.target.value)} />
                                                                {splitData.advances.length > 1 && <button onClick={()=>removeAdvanceRow(idx)} className="text-red-500"><Icon name="x" size={16}/></button>}
                                                            </div>
                                                        ))}
                                                        <button onClick={addAdvanceRow} className="text-xs text-rose-600 font-bold flex items-center gap-1 p-1">+ Êñ∞Â¢ûÂ∞çË±°</button>
                                                        <div className="text-xs text-stone-400 text-right mt-1 tabular-nums border-t border-stone-200 pt-1">
                                                            Á∏Ω‰ª£Â¢ä: ${splitData.advances.reduce((s,a)=>s+(parseFloat(a.amount)||0),0)} / Ëá™‰ªò: ${Math.max(0, (parseFloat(txForm.amount)||0) - splitData.advances.reduce((s,a)=>s+(parseFloat(a.amount)||0),0))}
                                                        </div>
                                                    </div>
                                                )}
                                            </>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={()=>setModal(null)} className="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-stone-500">ÂèñÊ∂à</button>
                                    <button onClick={handleTxSave} className="flex-1 bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-rose-200">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Account Modal */}
                    {modal === 'acc' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">{editTarget ? 'Á∑®ËºØÂ∏≥Êà∂' : 'Êñ∞Â¢ûÂ∏≥Êà∂'}</h3>
                                 <input className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200" placeholder="ÂêçÁ®±" value={accForm.name} onChange={e=>setAccForm({...accForm, name:e.target.value})}/>
                                 <select className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200" value={accForm.type} onChange={e=>setAccForm({...accForm, type:e.target.value})}>{Object.entries(ACCOUNT_TYPES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select>
                                 <input type="number" className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200 tabular-nums" placeholder="ÂàùÂßãÈ§òÈ°ç" value={accForm.initialBalance} onChange={e=>setAccForm({...accForm, initialBalance:e.target.value})}/>
                                 <div className="flex gap-2 mb-4"><span className="p-3 bg-stone-100 rounded text-sm text-stone-500">Âπ£Âà•</span><select className="flex-1 p-3 bg-stone-50 rounded border border-stone-200" value={accForm.currency} onChange={e=>setAccForm({...accForm, currency:e.target.value})}>{CURRENCIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                 {/* Include in Total Toggle */}
                                 <label className="flex items-center gap-3 p-3 bg-stone-50 rounded-lg mb-6 cursor-pointer border border-stone-200">
                                    <div className={`w-5 h-5 rounded-md flex items-center justify-center border ${accForm.includeInTotal ? 'bg-rose-500 border-rose-500 text-white' : 'bg-white border-stone-300'}`}>
                                        {accForm.includeInTotal && <Icon name="check" size={14} />}
                                    </div>
                                    <input type="checkbox" className="hidden" checked={accForm.includeInTotal} onChange={e=>setAccForm({...accForm, includeInTotal:e.target.checked})} />
                                    <span className="text-sm font-bold text-stone-700">Ë®àÂÖ•Á∏ΩË≥áÁî¢</span>
                                 </label>
                                 <button onClick={handleAccSubmit} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400 py-2">ÂèñÊ∂à</button>
                             </div>
                         </div>
                    )}
                    
                    {/* ... (Other modals same as V15.3: TX, Book, Budget, Retire, Cat, Rate, Market, Settle) ... */}
                    {/* Book Select Modal */}
                    {modal === 'bookSelect' && (
                        <div className="fixed inset-0 z-[200] bg-black/50 flex items-end justify-center p-4">
                            <div className="bg-white w-full max-w-sm p-6 rounded-t-2xl">
                                <h3 className="font-bold text-xl mb-4 text-stone-800">ÂàáÊèõÂ∏≥Êú¨</h3>
                                <button onClick={()=>setModal('addBook')} className="w-full py-3 bg-stone-100 rounded-xl font-bold mb-2 text-stone-600">+ Êñ∞Â¢ûÂ∏≥Êú¨</button>
                                {books.map(b=><button key={b.id} onClick={()=>{setCurrentBook(b);setModal(null)}} className={`w-full py-3 text-left border-b font-bold ${currentBook.id===b.id?'text-rose-500':'text-stone-600'}`}>{b.name}</button>)}
                                <button onClick={()=>setModal(null)} className="w-full py-3 mt-4 text-stone-400">ÂèñÊ∂à</button>
                            </div>
                        </div>
                    )}

                    {/* Add Book Modal */}
                    {modal === 'addBook' && (
                         <div className="fixed inset-0 z-[210] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">Êñ∞Â¢ûÊóÖÈÅäÂ∏≥Êú¨</h3>
                                 <input className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200" placeholder="ÂêçÁ®±" id="newBookName"/>
                                 <button onClick={()=>{
                                     saveData('books', {name: document.getElementById('newBookName').value, currency:'TWD'});
                                     setModal(null);
                                 }} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">Âª∫Á´ã</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">ÂèñÊ∂à</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Budget Modal */}
                    {modal === 'budget' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">Ë®≠ÂÆöÊúàÈ†êÁÆó</h3>
                                 <input type="number" className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200 tabular-nums" value={monthlyBudget} onChange={e=>setMonthlyBudget(e.target.value)}/>
                                 <button onClick={()=>{ handleBudgetSubmit(monthlyBudget); setModal(null); }} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">ÂèñÊ∂à</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Retire Modal */}
                    {modal === 'retire' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">ÈÄÄ‰ºëË®àÁï´</h3>
                                 <input type="number" placeholder="ÁõÆÂâçÂπ¥ÈΩ°" className="w-full p-3 border rounded-lg mb-2 tabular-nums" value={retireForm.currentAge} onChange={e=>setRetireForm({...retireForm, currentAge:e.target.value})}/>
                                 <input type="number" placeholder="ÈÄÄ‰ºëÂπ¥ÈΩ°" className="w-full p-3 border rounded-lg mb-2 tabular-nums" value={retireForm.retireAge} onChange={e=>setRetireForm({...retireForm, retireAge:e.target.value})}/>
                                 <input type="number" placeholder="ÊúàËä±Ë≤ª" className="w-full p-3 border rounded-lg mb-2 tabular-nums" value={retireForm.monthlyExpense} onChange={e=>setRetireForm({...retireForm, monthlyExpense:e.target.value})}/>
                                 <button onClick={()=>{handleRetireSubmit({preventDefault:()=>{}}); setModal(null);}} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">ÂèñÊ∂à</button>
                             </div>
                         </div>
                    )}
                    
                     {/* Category Modal */}
                    {modal === 'cat' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl max-h-[80vh] overflow-y-auto">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">È°ûÂà•ÁÆ°ÁêÜ</h3>
                                 <div className="flex gap-2 mb-4">
                                     <button onClick={()=>setEditingCategoryType('expense')} className={`flex-1 py-2 rounded ${editingCategoryType==='expense'?'bg-rose-500 text-white':'bg-stone-100 text-stone-500'}`}>ÊîØÂá∫</button>
                                     <button onClick={()=>setEditingCategoryType('income')} className={`flex-1 py-2 rounded ${editingCategoryType==='income'?'bg-rose-500 text-white':'bg-stone-100 text-stone-500'}`}>Êî∂ÂÖ•</button>
                                 </div>
                                 <div className="space-y-2">
                                     {categories[editingCategoryType].map(c=>(
                                         <div key={c.name} className="flex justify-between p-3 bg-stone-50 rounded-lg cursor-pointer hover:bg-stone-100" onClick={()=>{setEditingCategory(c); setModal('editCat')}}>
                                             <span><Icon name={c.icon} size={14} className="inline mr-2"/>{c.name}</span>
                                             <span className="text-xs text-stone-400">{c.subs.length} Â≠êÈ°ûÂà• ></span>
                                         </div>
                                     ))}
                                 </div>
                                 <div className="mt-4 pt-4 border-t flex gap-2">
                                     <input id="newCatName" placeholder="Êñ∞È°ûÂà•ÂêçÁ®±" className="flex-1 p-2 border rounded" value={newCatForm.name} onChange={e=>setNewCatForm({...newCatForm, name:e.target.value, type:editingCategoryType})}/>
                                     <button onClick={handleAddCategory} className="bg-blue-600 text-white px-4 rounded">Êñ∞Â¢û</button>
                                 </div>
                                 <button onClick={()=>setModal(null)} className="w-full mt-4 text-stone-400">ÈóúÈñâ</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Edit Cat Modal */}
                    {modal === 'editCat' && editingCategory && (
                         <div className="fixed inset-0 z-[210] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <div className="flex items-center gap-2 mb-4">
                                    <Icon name={editingCategory.icon}/>
                                    {/* Editable Main Category Name */}
                                    <input 
                                        className="font-bold text-xl bg-transparent border-b border-stone-300 focus:border-rose-500 outline-none w-full" 
                                        value={editingCategory.name} 
                                        onChange={(e) => handleEditMainCategoryName(e.target.value)}
                                    />
                                 </div>
                                 
                                 {/* Icon Selector (Simplified) */}
                                 <div className="mb-4 h-24 overflow-y-auto grid grid-cols-6 gap-2 p-2 bg-stone-50 rounded">
                                     {AVAILABLE_ICONS.map(icon => (
                                         <button key={icon} onClick={() => handleEditMainCategoryIcon(icon)} className={`p-2 rounded hover:bg-stone-200 ${editingCategory.icon === icon ? 'bg-rose-100 text-rose-500' : 'text-stone-400'}`}>
                                             <Icon name={icon} size={18}/>
                                         </button>
                                     ))}
                                 </div>

                                 <div className="flex flex-wrap gap-2 mb-4">
                                     {editingCategory.subs.map(s=>(
                                         <span key={s} className="bg-stone-100 px-3 py-1 rounded-full text-sm flex items-center gap-1 text-stone-600">{s} <button onClick={()=>handleDeleteSubCategory(editingCategory.name, s)} className="text-red-400 hover:text-red-600"><Icon name="x" size={12}/></button></span>
                                     ))}
                                 </div>
                                 <div className="flex gap-2">
                                     <input id="newSubCat" className="flex-1 border p-2 rounded" placeholder="Êñ∞Â¢ûÂ≠êÈ°ûÂà•"/>
                                     <button onClick={()=>{handleAddSubCategory(editingCategory.name, document.getElementById('newSubCat').value); document.getElementById('newSubCat').value=''}} className="bg-rose-500 text-white px-4 rounded">Êñ∞Â¢û</button>
                                 </div>
                                 <div className="mt-4 pt-4 border-t border-stone-100">
                                    <button onClick={()=>{handleDeleteCategory(editingCategory.name); setModal('cat');}} className="w-full text-red-500 text-sm py-2 hover:bg-red-50 rounded flex items-center justify-center gap-1"><Icon name="trash-2" size={14}/> Âà™Èô§Ê≠§‰∏ªÈ°ûÂà•</button>
                                 </div>
                                 <button onClick={()=>setModal('cat')} className="w-full mt-2 text-stone-400">ËøîÂõû</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Rate Modal */}
                    {modal === 'rate' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl max-h-[80vh] overflow-y-auto">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">ÂåØÁéáË®≠ÂÆö (1 Â§ñÂπ£ = ? TWD)</h3>
                                 <div className="space-y-2">
                                     {CURRENCIES.filter(c=>c!=='TWD').map(c=>(
                                         <div key={c} className="flex justify-between items-center"><span className="font-bold w-12 text-stone-600">{c}</span><input type="number" className="border p-2 rounded w-32 text-right tabular-nums" value={exchangeRates[c]||''} onChange={e=>setExchangeRates({...exchangeRates, [c]:parseFloat(e.target.value)})}/></div>
                                     ))}
                                 </div>
                                 <button onClick={handleRatesSubmit} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold mt-4 shadow-lg">ÂÑ≤Â≠ò</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Market Value Modal */}
                    {modal === 'market' && editTarget && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-2 text-stone-800">Êõ¥Êñ∞Â∏ÇÂÄº</h3>
                                 <p className="text-sm text-stone-500 mb-4">{editTarget.name} ({editTarget.currency})</p>
                                 <input type="number" autoFocus className="w-full p-4 bg-stone-50 rounded-xl text-2xl font-black mb-4 outline-none tabular-nums text-stone-800" value={newMarketValue} onChange={e=>setNewMarketValue(e.target.value)} placeholder="ÊúÄÊñ∞Â∏ÇÂÄº" />
                                 <button onClick={handleUpdateMarketValue} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">Êõ¥Êñ∞</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">ÂèñÊ∂à</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Settle Modal */}
                    {modal === 'settle' && settleTargetTx && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-2 text-stone-800">Êî∂Âõû‰ª£Â¢ä</h3>
                                 <p className="text-stone-500 mb-4">Â∞çË±°: {settleTargetTx.debtor} / ÈáëÈ°ç: ${settleTargetTx.amount.toLocaleString()}</p>
                                 <select className="w-full p-3 border rounded-lg mb-4" value={settleToAccount} onChange={e=>setSettleToAccount(e.target.value)}><option value="">Â≠òÂÖ•Â∏≥Êà∂</option>{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select>
                                 <button onClick={handleSettle} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg">Á¢∫Ë™çÊî∂Ê¨æ</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">ÂèñÊ∂à</button>
                             </div>
                         </div>
                    )}

                    {error && (
                        <div className="fixed inset-0 z-[300] bg-black/50 flex items-center justify-center p-6">
                            <div className="bg-white p-6 rounded-2xl max-w-xs w-full shadow-2xl">
                                <h3 className="font-bold text-lg text-rose-500 mb-2">{error.title}</h3>
                                <p className="text-sm text-stone-600 mb-4 whitespace-pre-wrap">{error.message}</p>
                                <button onClick={()=>setError(null)} className="w-full bg-stone-800 text-white py-2 rounded-lg">OK</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
