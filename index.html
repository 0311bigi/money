<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é›²ç«¯å¸³æœ¬ Pro (å¤§å­—ç‰ˆ)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="é›²ç«¯å¸³æœ¬">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#F8FAFC">
    
    <script>
        window.EMBEDDED_CONFIG = {
          apiKey: "AIzaSyD5AwqqAkFRBNY-f-FXAMAbf4H8BlBCGsk",
          authDomain: "bigi-1234.firebaseapp.com",
          projectId: "bigi-1234",
          storageBucket: "bigi-1234.firebasestorage.app",
          messagingSenderId: "177215769037",
          appId: "1:177215769037:web:740e6d3277ef5f7e0b1c84",
          measurementId: "G-5Q2HQY3S6Y"
        }; 
    </script>

    <script>
        (function() {
            var c = document.createElement('canvas'); c.width = 512; c.height = 512; var x = c.getContext('2d');
            x.fillStyle = '#e11d48'; 
            x.fillRect(0, 0, 512, 512);
            x.strokeStyle = 'rgba(255,255,255,0.2)'; x.lineWidth = 40; x.beginPath(); x.arc(512, 512, 200, 0, Math.PI*2); x.stroke();
            x.fillStyle = '#fff'; x.font = 'bold 300px sans-serif'; x.textAlign = 'center'; x.textBaseline = 'middle'; x.fillText('å¸³', 256, 270);
            var u = c.toDataURL('image/png');
            var l1 = document.createElement('link'); l1.rel = 'apple-touch-icon'; l1.href = u; document.head.appendChild(l1);
            var l2 = document.createElement('link'); l2.rel = 'icon'; l2.type = 'image/png'; l2.href = u; document.head.appendChild(l2);
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        /* ğŸ”´ é—œéµä¿®æ”¹ï¼šè¨­å®šæ ¹å­—é«”å¤§å°ç‚º 19px (åŸç‚º16px)ï¼Œé€™æœƒè®“æ‰€æœ‰ä»¥ rem ç‚ºå–®ä½çš„å°ºå¯¸æ”¾å¤§ç´„ 20% */
        html { font-size: 19px; }
        
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 text-base">
    <div id="root"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, writeBatch, getDoc, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut };
        window.isFirebaseSDKReady = true;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const Icon = ({ name, size = 24, className = "" }) => { // ç¨å¾®æ”¾å¤§é è¨­ Icon
            const ref = useRef(null);
            useEffect(() => { if (window.lucide && ref.current) { const i = document.createElement('i'); i.setAttribute('data-lucide', name); ref.current.innerHTML = ''; ref.current.appendChild(i); window.lucide.createIcons({ root: ref.current, attrs: { width: String(size), height: String(size), class: className } }); } }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const getLocalToday = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
        const getLocalMonth = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; };
        const addMonths = (dStr, m) => { const [y,M,d]=dStr.split('-').map(Number); const nd=new Date(y,M-1+m,1); if(m>0) return `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-01`; const maxD=new Date(nd.getFullYear(),nd.getMonth()+1,0).getDate(); return `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-${String(Math.min(d,maxD)).padStart(2,'0')}`; };
        const getDayOfWeek = (dateStr) => { const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­']; return days[new Date(dateStr).getDay()]; };

        const DEFAULT_CATS = { expense: [{name:'é£²é£Ÿ',icon:'utensils',subs:[]},{name:'äº¤é€š',icon:'bus',subs:[]},{name:'è³¼ç‰©',icon:'shopping-bag',subs:[]},{name:'å¨›æ¨‚',icon:'film',subs:[]},{name:'å±…ä½',icon:'home',subs:[]}], income: [{name:'è–ªè³‡',icon:'wallet',subs:[]},{name:'çé‡‘',icon:'gift',subs:[]},{name:'æŠ•è³‡',icon:'trending-up',subs:[]}] };
        
        const ACCOUNT_TYPES = { 
            'cash': { label: 'ç¾é‡‘', iconName: 'coins', color: 'text-emerald-600 bg-emerald-50' },
            'bank': { label: 'éŠ€è¡Œ', iconName: 'landmark', color: 'text-blue-600 bg-blue-50' },
            'credit': { label: 'ä¿¡ç”¨å¡', iconName: 'credit-card', color: 'text-purple-600 bg-purple-50' },
            'electronic': { label: 'é›»å­è²¨å¹£', iconName: 'smartphone-nfc', color: 'text-sky-600 bg-sky-50' },
            'invest': { label: 'æŠ•è³‡ç†è²¡', iconName: 'trending-up', color: 'text-rose-600 bg-rose-50' },
            'payable': { label: 'æ‡‰ä»˜å¸³æ¬¾', iconName: 'file-minus', color: 'text-orange-600 bg-orange-50' },
            'receivable': { label: 'æ‡‰æ”¶å¸³æ¬¾', iconName: 'file-plus', color: 'text-teal-600 bg-teal-50' },
            'other': { label: 'å…¶å®ƒ', iconName: 'wallet', color: 'text-stone-600 bg-stone-100' }
        };

        const CURRENCIES = ['TWD','USD','JPY','EUR','CNY','HKD','KRW','AUD','CAD','GBP','SGD','CHF'];
        const DEFAULT_RATES = {'TWD':1,'USD':32.5,'JPY':0.22,'EUR':35.0,'CNY':4.5,'HKD':4.1,'KRW':0.024,'AUD':21.5,'CAD':24.0,'GBP':41.0,'SGD':24.2,'CHF':36.5};
        
        const CATEGORY_COLORS = { 'é£²é£Ÿ': '#f97316', 'äº¤é€š': '#3b82f6', 'è³¼ç‰©': '#ec4899', 'å¨›æ¨‚': '#a855f7', 'å±…ä½': '#6366f1', 'é†«ç™‚': '#ef4444', 'æ•™è‚²': '#22c55e', 'è–ªè³‡': '#10b981', 'çé‡‘': '#eab308', 'æŠ•è³‡': '#f43f5e', 'è½‰å¸³': '#64748b', 'ä»£å¢Š': '#8b5cf6', 'é‚„æ¬¾': '#10b981', 'è‡ªå‹•ç¹³æ¬¾': '#94a3b8', 'é‹å‹•': '#f59e0b' };

        const AVAILABLE_ICONS = ['utensils', 'coffee', 'beer', 'shopping-cart', 'shopping-bag', 'gift', 'bus', 'car', 'plane', 'bed', 'map', 'home', 'zap', 'wifi', 'phone', 'hammer', 'film', 'gamepad-2', 'music', 'camera', 'ticket', 'stethoscope', 'pill', 'heart', 'graduation-cap', 'book', 'briefcase', 'smile', 'frown', 'star', 'tag', 'dumbbell', 'more-horizontal'];
        
        const OFFSET_ACCOUNT_ID = 'virtual-offset-account';

        const NavBtn = ({icon, label, active, onClick}) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-full gap-1 ${active?'text-rose-600 scale-105':'text-stone-400 hover:text-stone-600'}`}>{icon}<span className="text-xs font-bold">{label}</span></button>
        );

        const Header = ({ currentBook, setIsBookSelectOpen, user, handleGoogleLogin, title }) => (
            <header className="sticky top-0 z-20 bg-white border-b border-stone-100 px-6 py-4 flex justify-between items-center shadow-sm">
                <div className="flex items-center gap-3 cursor-pointer p-2 hover:bg-stone-50 rounded-xl" onClick={() => !title && setIsBookSelectOpen(true)}>
                    <div className="bg-rose-500 p-2.5 rounded-xl text-white shadow-md shadow-rose-200"><Icon name={title ? 'landmark' : (currentBook.id==='main'?'book':'plane')} size={24}/></div>
                    <div><h1 className="font-bold text-lg text-stone-700 tracking-wide flex items-center gap-1.5">{title || currentBook.name} {!title && <Icon name="chevron-down" size={18} className="text-stone-400"/>}</h1></div>
                </div>
                {user?.isAnonymous ? <button onClick={handleGoogleLogin} className="text-sm font-bold text-rose-600 bg-rose-50 px-3 py-2 rounded-lg">ç™»å…¥</button> : <div className="h-9 w-9 rounded-full overflow-hidden border border-stone-200"><img src={user?.photoURL||'https://via.placeholder.com/32'} alt="User"/></div>}
            </header>
        );

        function App() {
            const [sdkReady, setSdkReady] = useState(false);
            const [needConfig, setNeedConfig] = useState(false);
            const [configInput, setConfigInput] = useState('');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('home');

            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATS);
            const [recurring, setRecurring] = useState([]);
            const [retirement, setRetirement] = useState({ currentAge:30, retireAge:60, monthlyExpense:30000, inflation:2 });
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_RATES);
            const [monthlyBudget, setMonthlyBudget] = useState(30000);
            const [books, setBooks] = useState([]);
            const [currentBook, setCurrentBook] = useState({ id:'main', name:'æ—¥å¸¸å¸³æœ¬', currency:'TWD' });

            const [currentLedgerMonth, setCurrentLedgerMonth] = useState(getLocalMonth());
            const [analysisMode, setAnalysisMode] = useState('month');
            const [analysisType, setAnalysisType] = useState('expense');
            const [analysisGroupBy, setAnalysisGroupBy] = useState('main'); 
            
            const [modal, setModal] = useState(null); 
            const [editTarget, setEditTarget] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null); 
            
            const [txForm, setTxForm] = useState({ type:'expense', amount:'', toAmount:'', category:'', subCategory:'', accountId:'', toAccountId:'', debtor:'', date:getLocalToday(), note:'', currency:'TWD' });
            const [editingTx, setEditingTx] = useState(null);
            const [accForm, setAccForm] = useState({ name:'', type:'cash', currency:'TWD', initialBalance:'', includeInTotal: true });
            const [recForm, setRecForm] = useState({ name:'', type:'expense', amount:'', day:1 });
            const [newCatForm, setNewCatForm] = useState({ name:'', icon:'tag', type:'expense' });
            const [retireForm, setRetireForm] = useState({});
            const [bookForm, setBookForm] = useState({ name:'', currency:'TWD', startDate:'', endDate:'' });
            
            const [isAdvanceSplit, setIsAdvanceSplit] = useState(false);
            const [splitData, setSplitData] = useState({ advances:[{debtor:'',amount:''}], principalAmount:'', sourceAccountId:'' });
            const [installment, setInstallment] = useState({ enabled:false, periods:3 });
            const [settleToAccount, setSettleToAccount] = useState('');
            const [newMarketValue, setNewMarketValue] = useState('');
            const [editingCategoryType, setEditingCategoryType] = useState('expense');
            const [editingCategory, setEditingCategory] = useState(null);
            const [settleTargetTx, setSettleTargetTx] = useState(null);
            const [isOffset, setIsOffset] = useState(false);
            const [offsetTargetId, setOffsetTargetId] = useState('');
            const [viewingAccount, setViewingAccount] = useState(null);
            const [accountDetailMonth, setAccountDetailMonth] = useState(getLocalMonth());
            
            const [isImporting, setIsImporting] = useState(false);
            const fileInputRef = useRef(null);

            const fbRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'my-cloud-ledger-pro';

            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            useEffect(() => {
                const init = () => {
                    if (window.isFirebaseSDKReady) {
                        try {
                            let cfg = window.EMBEDDED_CONFIG;
                            if (!cfg) {
                                cfg = window.__firebase_config ? JSON.parse(window.__firebase_config) : JSON.parse(localStorage.getItem('my_ledger_firebase_config'));
                            }

                            if (cfg) {
                                const app = window.FirebaseSDK.initializeApp(cfg);
                                fbRef.current = window.FirebaseSDK;
                                authRef.current = window.FirebaseSDK.getAuth(app);
                                dbRef.current = window.FirebaseSDK.getFirestore(app);
                                setSdkReady(true);
                            } else { setNeedConfig(true); setLoading(false); }
                        } catch (e) { setNeedConfig(true); setLoading(false); }
                    } else setTimeout(init, 100);
                };
                init();
            }, []);

            const handleSaveConfig = () => {
                try {
                    let v = configInput.trim().replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g, '$1"$2":').replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                    if(v.includes("const")) v = v.substring(v.indexOf('{'), v.lastIndexOf('}')+1);
                    const c = JSON.parse(v);
                    if(!c.apiKey) throw new Error("ç¼ºå°‘ apiKey");
                    localStorage.setItem('my_ledger_firebase_config', JSON.stringify(c));
                    window.location.reload();
                } catch(e) { setError({ title:"è¨­å®šç„¡æ•ˆ", message:e.message }); }
            };

            const resetApp = () => { localStorage.removeItem('my_ledger_firebase_config'); window.location.reload(); };

            useEffect(() => {
                const timer = setTimeout(() => { if (loading && !needConfig) { setLoading(false); setError({ title: "é€£ç·šé€¾æ™‚", message: "ç³»çµ±é€£ç·šéä¹…ï¼Œå¯èƒ½æ˜¯ï¼š\n1. æœªé–‹å•Ÿã€ŒåŒ¿åç™»å…¥ã€ã€‚\n2. ç¶²åŸŸæœªæˆæ¬Šã€‚\n3. API Key éŒ¯èª¤ã€‚" }); } }, 15000); 
                return () => clearTimeout(timer);
            }, [loading, needConfig]);

            useEffect(() => {
                if (!sdkReady) return;
                const unsubAuth = fbRef.current.onAuthStateChanged(authRef.current, async (u) => {
                    if (u) setUser(u);
                    else {
                        try { await fbRef.current.signInAnonymously(authRef.current); }
                        catch (e) { setError({ title:"ç™»å…¥å¤±æ•—", message: "è«‹é–‹å•ŸåŒ¿åç™»å…¥æˆ–æª¢æŸ¥ç¶²åŸŸæˆæ¬Š" }); setLoading(false); }
                    }
                });
                return () => unsubAuth();
            }, [sdkReady]);

            const handleGoogleLogin = async () => { try { await fbRef.current.signInWithPopup(authRef.current, new fbRef.current.GoogleAuthProvider()); } catch(e) { setError({title:"ç™»å…¥éŒ¯èª¤", message:e.message}); } };

            useEffect(() => {
                if (!user || !sdkReady) return;
                const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                
                const checkAutoPay = async (accs) => {
                    const m = getLocalMonth();
                    const cards = accs.filter(a => a.type==='credit' && a.autoPayment && a.autoPaymentAccount);
                    if (cards.length === 0) return;
                    const batch = fbRef.current.writeBatch(dbRef.current);
                    let hasUpd = false;
                    cards.forEach(c => {
                        if (c.lastAutoPaymentMonth !== m && new Date().getDate() >= parseInt(c.paymentDueDay||15)) {
                            batch.set(fbRef.current.doc(fbRef.current.collection(userRef, 'transactions')), {
                                type: 'transfer', amount: 0, category: 'è‡ªå‹•ç¹³æ¬¾', accountId: c.autoPaymentAccount, toAccountId: c.id, date: getLocalToday(), bookId: 'main', note: `[ç³»çµ±] å¡è²» (${c.name})`, createdAt: new Date().toISOString()
                            });
                            batch.update(fbRef.current.doc(userRef, 'accounts', c.id), { lastAutoPaymentMonth: m });
                            hasUpd = true;
                        }
                    });
                    if (hasUpd) await batch.commit();
                };

                const unsubs = [
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'transactions'), s => setTransactions(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date)))),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'accounts'), s => { 
                        const a = s.docs.map(d=>({id:d.id,...d.data()})).sort((a, b) => (a.order || 0) - (b.order || 0)); 
                        setAccounts(a); 
                        checkAutoPay(a); 
                    }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'config'), d => { 
                        if(d.exists()) { 
                            const data = d.data();
                            if (data.categories) setCategories(data.categories); 
                            if (data.budget) setMonthlyBudget(data.budget); 
                        } else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'config'), { categories: DEFAULT_CATS }, {merge: true}); 
                    }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'rates'), d => { if(d.exists()) setExchangeRates(d.data()); else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'rates'), DEFAULT_RATES, {merge: true}); }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'retirement'), d => { if(d.exists()) setRetirement(d.data()); else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'retirement'), retirement, {merge: true}); }),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'recurring'), s => setRecurring(s.docs.map(d=>({id:d.id,...d.data()})))),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'books'), s => setBooks([{id:'main',name:'æ—¥å¸¸å¸³æœ¬',currency:'TWD'},...s.docs.map(d=>({id:d.id,...d.data()}))]))
                ];
                setLoading(false);
                return () => unsubs.forEach(u => u());
            }, [user, sdkReady]);

            const saveData = async (col, data, id=null) => {
                const ref = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                if (id) await fbRef.current.updateDoc(fbRef.current.doc(ref, col, id), data);
                else await fbRef.current.addDoc(fbRef.current.collection(ref, col), { ...data, createdAt: new Date().toISOString() });
            };
            const deleteData = async (col, id) => { await fbRef.current.deleteDoc(fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid, col, id)); };

            const getCategoryIcon = (catName, type) => {
                if(type === 'transfer') return 'arrow-right-left';
                if(type === 'advance') return 'hand-coins';
                if(type === 'repayment') return 'check-circle';
                if(type === 'transfer_in') return 'arrow-left-right'; 
                if(type === 'transfer_out') return 'arrow-right-left';
                if (!categories[type] && type!=='expense' && type!=='income') return 'tag';
                if (!categories[type]) return 'tag';
                const cat = categories[type].find(c => c.name === catName);
                return cat ? cat.icon : 'tag';
            };

            const stats = useMemo(() => {
                const bals = {}; accounts.forEach(a => bals[a.id] = parseFloat(a.initialBalance)||0);
                const advanceMap = {}; 
                transactions.forEach(t => { if (t.type === 'advance') advanceMap[t.id] = { ...t, repaid: 0, remaining: parseFloat(t.amount) }; });
                transactions.forEach(t => { if (t.type === 'repayment' && t.relatedTxId && advanceMap[t.relatedTxId]) { const repaidAmt = parseFloat(t.amount); advanceMap[t.relatedTxId].repaid += repaidAmt; advanceMap[t.relatedTxId].remaining -= repaidAmt; } });
                let debt = 0;
                Object.values(advanceMap).forEach(a => { if (!a.isSettled && a.remaining > 0.1) debt += a.remaining; });
                
                let totalAsset=0, inc=0, exp=0;
                transactions.forEach(t => {
                    const amt = parseFloat(t.amount)||0;
                    if (t.accountId !== OFFSET_ACCOUNT_ID && t.toAccountId !== OFFSET_ACCOUNT_ID) { 
                        if (t.type==='income'||t.type==='repayment') if(bals[t.accountId]!=null) bals[t.accountId]+=amt;
                        if (t.type==='expense'||t.type==='advance') if(bals[t.accountId]!=null) bals[t.accountId]-=amt;
                        if (t.type==='transfer') { if(bals[t.accountId]!=null) bals[t.accountId]-=amt; if(bals[t.toAccountId]!=null) bals[t.toAccountId]+=(t.toAmount?parseFloat(t.toAmount):amt); }
                    }
                    
                    const txDate = String(t.date || '');
                    if ((t.bookId||'main') === currentBook.id && txDate.startsWith(currentLedgerMonth)) {
                        if (t.type==='income') inc+=amt;
                        if (t.type==='expense') exp+=amt;
                    }
                });
                accounts.forEach(a => { if(a.includeInTotal !== false) { let v = (a.type==='invest' && a.marketValue) ? parseFloat(a.marketValue) : (bals[a.id]||0); if(a.currency!=='TWD') v *= (exchangeRates[a.currency]||1); totalAsset+=v; } });
                return { bals, totalAsset, inc, exp, debt, advanceMap };
            }, [accounts, transactions, currentLedgerMonth, currentBook, exchangeRates]);

            const retireProgress = useMemo(() => {
                const years = Math.max(0, retirement.retireAge - retirement.currentAge);
                const target = retirement.monthlyExpense * Math.pow(1 + (retirement.inflation/100), years) * 12 * 25;
                const pct = target > 0 ? Math.min(100, (stats.totalAsset / target) * 100) : 0;
                return { target, pct, years };
            }, [retirement, stats.totalAsset]);

            const homeInsight = useMemo(() => {
                const saving = stats.inc - stats.exp;
                if (saving < 0) return { type:'danger', icon:'alert-triangle', text:`âš ï¸ é€æ”¯ $${Math.abs(saving)}` };
                if (stats.exp > monthlyBudget) return { type:'danger', icon:'alert-triangle', text:`âš ï¸ è¶…å‡ºé ç®— $${stats.exp - monthlyBudget}` };
                return { type:'success', icon:'thumbs-up', text:`âœ… é ç®—å‰©é¤˜ $${monthlyBudget - stats.exp}` };
            }, [stats, monthlyBudget]);
            
            const retirementInsight = useMemo(() => {
                const savings = stats.inc - stats.exp;
                if (savings < 0) return { icon: 'alert-triangle', text: `âš ï¸ æœ¬æœˆé€æ”¯ï¼Œè³‡ç”¢ç¸®æ°´ä¸­ï¼`, color: 'text-rose-400', bg: 'bg-rose-500/20' };
                if (savings < retirement.monthlyExpense) return { icon: 'target', text: `ğŸ¯ é›¢æœˆå­˜é¡ç›®æ¨™é‚„æœ‰å·®è·ï¼ŒåŠ æ²¹ï¼`, color: 'text-amber-400', bg: 'bg-amber-500/20' };
                return { icon: 'party-popper', text: `ğŸš€ å¤ªæ£’äº†ï¼å„²è“„åŠ›è¶…æ¨™ï¼`, color: 'text-emerald-400', bg: 'bg-emerald-500/20' };
            }, [stats, retirement, currentLedgerMonth]);

            const analysisData = useMemo(() => {
                const bookTxs = transactions.filter(tx => (tx.bookId || 'main') === currentBook.id);
                let filteredTx = [];
                if (analysisMode === 'month') { filteredTx = bookTxs.filter(t => String(t.date || '').substring(0, 7) === currentLedgerMonth); } 
                else if (analysisMode === 'year') { const year = currentLedgerMonth.split('-')[0]; filteredTx = bookTxs.filter(t => String(t.date || '').substring(0, 4) === year); }

                const targetTx = filteredTx.filter(t => t.type === analysisType);
                const total = targetTx.reduce((sum, t) => sum + (parseFloat(t.amount)||0), 0);
                
                const byCat = {};
                targetTx.forEach(t => {
                    const k = (analysisGroupBy === 'sub' && t.subCategory) ? t.subCategory : t.category;
                    byCat[k] = (byCat[k] || 0) + parseFloat(t.amount);
                });

                const chart = Object.entries(byCat).map(([name, val]) => {
                    let color = CATEGORY_COLORS[name];
                    if (!color) {
                         const parentCat = categories[analysisType] && categories[analysisType].find(c => c.subs && c.subs.includes(name));
                         if (parentCat) color = CATEGORY_COLORS[parentCat.name];
                    }
                    return { name, value: val, percent: total ? (val/total)*100 : 0, color: color || '#94a3b8' };
                }).sort((a,b) => b.value - a.value);

                return { total, chart, filteredTx: targetTx };
            }, [transactions, analysisMode, currentLedgerMonth, currentBook, analysisType, analysisGroupBy, categories]);

            const groupedTransactions = useMemo(() => {
                const targetTxs = transactions.filter(t => (t.bookId||'main')===currentBook.id && String(t.date || '').startsWith(currentLedgerMonth));
                const groups = {};
                targetTxs.forEach(tx => {
                    if (!groups[tx.date]) groups[tx.date] = [];
                    groups[tx.date].push(tx);
                });
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
            }, [transactions, currentBook, currentLedgerMonth]);
            
            const accountDetailData = useMemo(() => {
                if (!viewingAccount) return null;
                const related = transactions.filter(t => t.accountId === viewingAccount.id || t.toAccountId === viewingAccount.id);
                related.sort((a, b) => {
                    const dateA = new Date(a.date).getTime();
                    const dateB = new Date(b.date).getTime();
                    if (dateA !== dateB) return dateA - dateB;
                    return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
                });

                let balance = parseFloat(viewingAccount.initialBalance) || 0;
                const withBalance = related.map(t => {
                    const amt = parseFloat(t.amount);
                    let change = 0;
                    let type = 'neutral';
                    if (t.accountId === viewingAccount.id) {
                        if (t.type === 'expense' || t.type === 'advance') { balance -= amt; change = -amt; type = 'expense'; } 
                        else if (t.type === 'income' || t.type === 'repayment') { balance += amt; change = amt; type = 'income'; } 
                        else if (t.type === 'transfer') { balance -= amt; change = -amt; type = 'transfer_out'; }
                    } else if (t.toAccountId === viewingAccount.id && t.type === 'transfer') {
                        const inAmt = t.toAmount ? parseFloat(t.toAmount) : amt; balance += inAmt; change = inAmt; type = 'transfer_in';
                    }
                    return { ...t, balanceSnapshot: balance, change, displayType: type };
                });

                const monthTxs = withBalance.filter(t => String(t.date || '').startsWith(accountDetailMonth));
                const displayList = [...monthTxs].sort((a, b) => {
                     const dateA = new Date(a.date).getTime();
                     const dateB = new Date(b.date).getTime();
                     if (dateA !== dateB) return dateB - dateA;
                     return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
                });

                let mIncome = 0, mExpense = 0, mTrans = 0;
                monthTxs.forEach(t => {
                    if (t.displayType === 'income' || t.displayType === 'repayment') mIncome += t.change;
                    else if (t.displayType === 'expense' || t.displayType === 'advance') mExpense += Math.abs(t.change);
                    else if (t.displayType === 'transfer_in' || t.displayType === 'transfer_out') mTrans += t.change;
                });

                return { displayList, stats: { mIncome, mExpense, mTrans }, currentBalance: balance };
            }, [viewingAccount, transactions, accountDetailMonth]);

            // Handlers
            const handleTxSave = () => {
                const amt = parseFloat(txForm.amount);
                if (!amt) { alert('è«‹è¼¸å…¥é‡‘é¡'); return; }
                if (!txForm.accountId && !isOffset) { alert('è«‹é¸æ“‡å¸³æˆ¶'); return; }

                let finalCategory = txForm.category;
                if (!finalCategory) {
                    if (categories[txForm.type] && categories[txForm.type].length > 0) finalCategory = categories[txForm.type][0].name;
                    else finalCategory = 'æœªåˆ†é¡';
                }
                const createdAt = editingTx ? editingTx.createdAt : new Date().toISOString();
                const base = { ...txForm, bookId: currentBook.id, amount: amt, category: finalCategory, createdAt };
                if (editingTx) {
                    saveData('transactions', base, editingTx.id);
                    setModal(null);
                    setEditingTx(null);
                    return;
                }
                if (isOffset && offsetTargetId) {
                    saveData('transactions', { ...base, accountId: OFFSET_ACCOUNT_ID, note: `æŠµæ‰£: ${txForm.note}` }); 
                    saveData('transactions', { type: 'repayment', amount: amt, accountId: OFFSET_ACCOUNT_ID, relatedTxId: offsetTargetId, date: txForm.date, bookId: currentBook.id, note: `æŠµæ‰£æ”¯å‡º (${finalCategory})`, createdAt: new Date().toISOString() }); 
                    setModal(null); return;
                }
                if (txForm.type === 'expense' && installment.enabled) {
                    const p = parseInt(installment.periods);
                    const per = Math.round(amt / p);
                    for (let i = 0; i < p; i++) {
                        saveData('transactions', { ...base, amount: (i===0?amt-(per*p)+per:per), date: addMonths(txForm.date, i), note: `${txForm.note} (${i+1}/${p})`, createdAt: new Date().toISOString() });
                    }
                } else if (txForm.type === 'expense' && isAdvanceSplit) {
                     let advTotal = 0;
                     splitData.advances.forEach(a => {
                         if (a.debtor && a.amount) {
                             saveData('transactions', { ...base, type:'advance', amount: parseFloat(a.amount), debtor: a.debtor, isSettled: false, note: `ä»£å¢Š: ${txForm.note}`, createdAt: new Date().toISOString() });
                             advTotal += parseFloat(a.amount);
                         }
                     });
                     const myExp = amt - advTotal;
                     if (myExp > 0) saveData('transactions', { ...base, amount: myExp, createdAt: new Date().toISOString() });
                } else if (txForm.type === 'income' && isAdvanceSplit) {
                    const principal = parseFloat(splitData.principalAmount) || 0;
                    const gain = amt - principal;
                    if (principal > 0) saveData('transactions', { ...base, type: 'transfer', amount: principal, category: 'è½‰å¸³', accountId: splitData.sourceAccountId, toAccountId: txForm.accountId, note: `æŠ•è³‡æœ¬é‡‘`, createdAt: new Date().toISOString() });
                    if (gain !== 0) saveData('transactions', { ...base, type: 'income', amount: gain, category: txForm.category || 'æŠ•è³‡', note: `æŠ•è³‡ç²åˆ©`, createdAt: new Date().toISOString() });
                } else {
                    saveData('transactions', base);
                }
                setModal(null);
            };
            
            // ğŸŸ¢ é‚è¼¯ä¿®æ­£ 1ï¼šæ–°å¢å­é¡åˆ¥ (å³æ™‚æ›´æ–°ç•«é¢ Stateï¼Œä¸ç«‹å³ä¸Šå‚³)
            const handleAddSubCategory = (mainCat, sub) => {
                if (!sub) return;
                const newCats = { ...categories };
                const catIndex = newCats[editingCategoryType].findIndex(c => c.name === mainCat);
                if (catIndex > -1) {
                    const targetCat = { ...newCats[editingCategoryType][catIndex] };
                    if (!targetCat.subs.includes(sub)) {
                        targetCat.subs = [...targetCat.subs, sub]; 
                        newCats[editingCategoryType][catIndex] = targetCat;
                        setCategories(newCats);
                        setEditingCategory(targetCat); 
                    }
                }
            };

            // ğŸŸ¢ é‚è¼¯ä¿®æ­£ 2ï¼šåˆªé™¤å­é¡åˆ¥ (å³æ™‚æ›´æ–°ç•«é¢)
            const handleDeleteSubCategory = (mainCat, sub) => {
                const newCats = { ...categories };
                const catIndex = newCats[editingCategoryType].findIndex(c => c.name === mainCat);
                if (catIndex > -1) {
                    const targetCat = { ...newCats[editingCategoryType][catIndex] };
                    targetCat.subs = targetCat.subs.filter(s => s !== sub);
                    newCats[editingCategoryType][catIndex] = targetCat;
                    setCategories(newCats);
                    setEditingCategory(targetCat); 
                }
            };

            // ğŸŸ¢ é‚è¼¯ä¿®æ­£ 3ï¼šå„²å­˜è®Šæ›´
            const handleSaveCategoryChanges = async () => {
                await saveData('settings', { categories: categories }, 'config');
                setModal(null); 
            };

            // ğŸ¤ æ™ºæ…§èªéŸ³è¼¸å…¥
            const handleVoiceInput = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ (è«‹ä½¿ç”¨ Chrome æˆ– Safari)");
                    return;
                }
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.start();
                recognition.onstart = () => { console.log("è«‹é–‹å§‹èªªè©±..."); };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    let processedText = transcript
                        .replace(/ä¸€/g, '1').replace(/äºŒ/g, '2').replace(/ä¸‰/g, '3')
                        .replace(/å››/g, '4').replace(/äº”/g, '5').replace(/å…­/g, '6')
                        .replace(/ä¸ƒ/g, '7').replace(/å…«/g, '8').replace(/ä¹/g, '9')
                        .replace(/å/g, '10').replace(/ç™¾/g, '00');
                    const amountMatch = processedText.match(/\d+/);
                    const amount = amountMatch ? amountMatch[0] : '';
                    let note = transcript.replace(amountMatch ? amountMatch[0] : '', '').replace(/å…ƒ|å¡Š/g, '').trim();
                    let matchedCategory = txForm.category;
                    let matchedSubCategory = '';
                    const keywordMap = {
                        'é£²é£Ÿ': ['åƒ', 'é£¯', 'éºµ', 'é¤', 'å–', 'é£²æ–™', 'å…¨è¯', '7-11', 'ä¾¿ç•¶'],
                        'äº¤é€š': ['è»Š', 'æ²¹', 'æ·é‹', 'é«˜éµ', 'æ‚ éŠå¡', 'åŠ æ²¹'],
                        'è³¼ç‰©': ['è²·', 'è¦çš®', 'è¡£æœ', 'é‹', 'è¡›ç”Ÿç´™'],
                        'å¨›æ¨‚': ['é›»å½±', 'éŠæˆ²', 'ç©', 'Netflix'],
                        'å±…ä½': ['é›»è²»', 'æ°´è²»', 'æˆ¿ç§Ÿ', 'ç“¦æ–¯']
                    };
                    if (categories[txForm.type]) {
                        for (const cat of categories[txForm.type]) {
                            if (note.includes(cat.name)) { matchedCategory = cat.name; break; }
                            if (keywordMap[cat.name] && keywordMap[cat.name].some(k => note.includes(k))) { matchedCategory = cat.name; break; }
                            if (cat.subs) { const sub = cat.subs.find(s => note.includes(s)); if (sub) { matchedCategory = cat.name; matchedSubCategory = sub; break; } }
                        }
                    }
                    setTxForm(prev => ({ ...prev, amount: amount || prev.amount, category: matchedCategory, subCategory: matchedSubCategory, note: note || prev.note }));
                };
                recognition.onerror = (event) => { console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤", event.error); };
            };

            const handleAccSubmit = async (e) => { e.preventDefault(); if (!accForm.name) return; const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid); const accountData = { ...accForm, order: editingAccount ? editingAccount.order : accounts.length }; if (editingAccount) { await fbRef.current.updateDoc(fbRef.current.doc(userRef, 'accounts', editingAccount.id), accountData); } else { await fbRef.current.addDoc(fbRef.current.collection(userRef, 'accounts'), { ...accountData, createdAt: new Date().toISOString() }); } setModal(null); };
            const handleSort = async () => { if (dragItem.current === null || dragOverItem.current === null) return; const _accounts = [...accounts]; const draggedItemContent = _accounts[dragItem.current]; _accounts.splice(dragItem.current, 1); _accounts.splice(dragOverItem.current, 0, draggedItemContent); dragItem.current = null; dragOverItem.current = null; setAccounts(_accounts); const batch = fbRef.current.writeBatch(dbRef.current); const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid); _accounts.forEach((acc, index) => { const ref = fbRef.current.doc(userRef, 'accounts', acc.id); batch.update(ref, { order: index }); }); await batch.commit(); };
            const handleUpdateMarketValue = async () => { if (!editTarget) return; const accRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'accounts', editTarget.id); await fbRef.current.updateDoc(accRef, { marketValue: parseFloat(newMarketValue) || 0 }); setModal(null); };
            const handleBudgetSubmit = (val) => { setMonthlyBudget(val); saveData('settings', { budget: parseFloat(val) }, 'config'); };
            const handleAddCategory = () => { if(!newCatForm.name) return; const newCats = {...categories}; newCats[newCatForm.type].push({ name: newCatForm.name, icon: newCatForm.icon, subs: [] }); setCategories(newCats); saveData('settings', {categories: newCats}, 'config'); };
            const handleDeleteCategory = (catName) => { const newCats = {...categories}; newCats[editingCategoryType] = newCats[editingCategoryType].filter(c => c.name !== catName); setCategories(newCats); saveData('settings', {categories: newCats}, 'config'); };
            const handleRatesSubmit = () => { saveData('settings', exchangeRates, 'rates'); setModal(null); };
            const updateAdvanceRow = (index, field, value) => { const newAdvances = [...splitData.advances]; newAdvances[index][field] = value; setSplitData({...splitData, advances: newAdvances}); };
            const addAdvanceRow = () => { setSplitData({...splitData, advances: [...splitData.advances, { debtor: '', amount: '' }]}); };
            const removeAdvanceRow = (index) => { if (splitData.advances.length <= 1) return; const newAdvances = splitData.advances.filter((_, i) => i !== index); setSplitData({...splitData, advances: newAdvances}); };
            const openTxModal = (type = 'expense', existingTx = null) => {
                 if (existingTx) { setEditingTx(existingTx); setTxForm({ ...existingTx, accountId: existingTx.accountId || (accounts.length > 0 ? accounts[0].id : ''), }); setIsAdvanceSplit(false); setIsOffset(false); setInstallment({ enabled: false, periods: 3 }); } else { setEditingTx(null); setTxForm({ ...txForm, type, category: categories[type] && categories[type].length > 0 ? categories[type][0].name : '', accountId: accounts.length > 0 ? accounts[0].id : '', amount: '', note: '', date: getLocalToday() }); setIsAdvanceSplit(false); setIsOffset(false); setSplitData({ advances:[{debtor:'',amount:''}], principalAmount:'', sourceAccountId:'' }); } setModal('tx');
            };
            const changeMonthStep = (step) => { const [y, m] = currentLedgerMonth.split('-').map(Number); const date = new Date(y, m - 1 + step, 1); setCurrentLedgerMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`); };
            const changeDetailMonthStep = (step) => { const [y, m] = accountDetailMonth.split('-').map(Number); const date = new Date(y, m - 1 + step, 1); setAccountDetailMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`); };
            const handleEditMainCategoryName = async (newName) => { if (!newName || !editingCategory) return; const newCats = { ...categories }; const catIdx = newCats[editingCategoryType].findIndex(c => c.name === editingCategory.name); if (catIdx > -1) { newCats[editingCategoryType][catIdx].name = newName; setCategories(newCats); setEditingCategory(newCats[editingCategoryType][catIdx]); } };
            const handleEditMainCategoryIcon = async (newIcon) => { if (!editingCategory) return; const newCats = { ...categories }; const catIdx = newCats[editingCategoryType].findIndex(c => c.name === editingCategory.name); if (catIdx > -1) { newCats[editingCategoryType][catIdx].icon = newIcon; setCategories(newCats); setEditingCategory(newCats[editingCategoryType][catIdx]); } };
            const openAccModalCorrect = (acc = null) => { if (acc) { setEditingAccount(acc); setAccForm({ name: acc.name, type: acc.type, currency: acc.currency || 'TWD', initialBalance: acc.initialBalance || '', includeInTotal: acc.includeInTotal !== false, closingDay: acc.closingDay || '27', paymentDueDay: acc.paymentDueDay || '15', autoPaymentAccount: acc.autoPaymentAccount || '', holidayAdjustment: acc.holidayAdjustment || 'defer', autoPayment: acc.autoPayment || false }); } else { setEditingAccount(null); setAccForm({ name: '', type: 'cash', currency: 'TWD', initialBalance: '', includeInTotal: true, closingDay: '27', paymentDueDay: '15', autoPaymentAccount: '', holidayAdjustment: 'defer', autoPayment: false }); } setModal('acc'); };

            // --- Export to Excel ---
            const handleExport = () => {
                if (!window.XLSX) { alert("Excel å…ƒä»¶è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦"); return; }
                const wb = XLSX.utils.book_new();
                
                // Prepare Transaction Data
                const txData = transactions.map(t => {
                    const accName = accounts.find(a => a.id === t.accountId)?.name || 'æœªçŸ¥å¸³æˆ¶';
                    const toAccName = t.toAccountId ? (accounts.find(a => a.id === t.toAccountId)?.name || 'æœªçŸ¥å¸³æˆ¶') : '';
                    let typeLabel = t.type;
                    if (t.type === 'expense') typeLabel = 'æ”¯å‡º';
                    else if (t.type === 'income') typeLabel = 'æ”¶å…¥';
                    else if (t.type === 'transfer') typeLabel = 'è½‰å¸³';
                    else if (t.type === 'advance') typeLabel = 'ä»£å¢Š';
                    else if (t.type === 'repayment') typeLabel = 'é‚„æ¬¾';

                    return {
                        æ—¥æœŸ: t.date,
                        é¡å‹: typeLabel,
                        é‡‘é¡: t.amount,
                        ä¸»é¡åˆ¥: t.category,
                        å­é¡åˆ¥: t.subCategory || '',
                        å¸³æˆ¶: accName,
                        è½‰å…¥å¸³æˆ¶: toAccName,
                        å‚™è¨»: t.note || '',
                        ä»£å¢Šå°è±¡: t.debtor || '',
                        å»ºç«‹æ™‚é–“: t.createdAt
                    };
                });
                
                const wsTx = XLSX.utils.json_to_sheet(txData);
                XLSX.utils.book_append_sheet(wb, wsTx, "äº¤æ˜“ç´€éŒ„");
                
                // Prepare Account Data (Optional but good for backup)
                const accData = accounts.map(a => ({
                    åç¨±: a.name,
                    é¡å‹: ACCOUNT_TYPES[a.type]?.label || a.type,
                    å¹£åˆ¥: a.currency,
                    åˆå§‹é¤˜é¡: a.initialBalance,
                    è¨ˆå…¥ç¸½è³‡ç”¢: a.includeInTotal ? 'æ˜¯' : 'å¦'
                }));
                 const wsAcc = XLSX.utils.json_to_sheet(accData);
                XLSX.utils.book_append_sheet(wb, wsAcc, "å¸³æˆ¶è¨­å®š");

                XLSX.writeFile(wb, `è¨˜å¸³å‚™ä»½_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            // --- Import from Excel ---
            const handleImportClick = () => {
                if (fileInputRef.current) fileInputRef.current.click();
            };

            const handleImportFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsImporting(true);
                
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        
                        const wsName = wb.SheetNames.includes("äº¤æ˜“ç´€éŒ„") ? "äº¤æ˜“ç´€éŒ„" : wb.SheetNames[0];
                        const ws = wb.Sheets[wsName];
                        const jsonData = XLSX.utils.sheet_to_json(ws, { raw: false });
                        
                        if (!jsonData || jsonData.length === 0) {
                            alert("æª”æ¡ˆå…§å®¹ç‚ºç©ºæˆ–æ ¼å¼ä¸ç¬¦");
                            setIsImporting(false);
                            return;
                        }

                        const batch = fbRef.current.writeBatch(dbRef.current);
                        const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                        const txCol = fbRef.current.collection(userRef, 'transactions');
                        
                        let importCount = 0;
                        
                        jsonData.forEach(row => {
                            // âœ… æ›¿æ›ç‚ºé€™æ®µä¹¾æ·¨çš„é‚è¼¯
                            let rawDate = row['æ—¥æœŸ'];
                            let date = '';

                            if (!rawDate) return; 

                            // æƒ…å¢ƒ Aï¼šExcel æŠŠæ—¥æœŸç•¶æˆç´”æ•¸å­—åºè™Ÿ (ä¾‹å¦‚ 45334)
                            if (typeof rawDate === 'number') {
                                const excelDate = new Date(Math.round((rawDate - 25569) * 86400 * 1000));
                                const year = excelDate.getFullYear();
                                const month = String(excelDate.getMonth() + 1).padStart(2, '0');
                                const day = String(excelDate.getDate()).padStart(2, '0');
                                date = `${year}-${month}-${day}`;
                            } 
                            // æƒ…å¢ƒ Bï¼šExcel çµ¦çš„æ˜¯æ–‡å­— (ä¾‹å¦‚ "2026/2/11 18:19" æˆ– "2026-02-11")
                            else {
                                try {
                                    let d = new Date(rawDate);
                                    if (isNaN(d.getTime())) {
                                        d = new Date(); // çœ‹ä¸æ‡‚çš„æ ¼å¼å°±ç•¶ä½œä»Šå¤©
                                    }
                                    const year = d.getFullYear();
                                    const month = String(d.getMonth() + 1).padStart(2, '0'); 
                                    const day = String(d.getDate()).padStart(2, '0');
                                    date = `${year}-${month}-${day}`;
                                } catch (e) {
                                    return; // åš´é‡éŒ¯èª¤å°±è·³éé€™ç­†
                                }
                            }

                            const amount = parseFloat(row['é‡‘é¡']);
                            const category = row['ä¸»é¡åˆ¥'] || 'æœªåˆ†é¡';
                            const subCategory = row['å­é¡åˆ¥'] || '';
                            const note = row['å‚™è¨»'] || '';
                            const accName = row['å¸³æˆ¶'];
                            
                            if (!date || isNaN(amount)) return; // Skip invalid rows

                            let type = 'expense';
                            if (row['é¡å‹'] === 'æ”¶å…¥') type = 'income';
                            else if (row['é¡å‹'] === 'è½‰å¸³') type = 'transfer';
                            else if (row['é¡å‹'] === 'ä»£å¢Š') type = 'advance';
                            else if (row['é¡å‹'] === 'é‚„æ¬¾') type = 'repayment';
                            
                            const acc = accounts.find(a => a.name === accName);
                            const accountId = acc ? acc.id : (accounts[0]?.id || ''); 

                            let toAccountId = '';
                            if (type === 'transfer' && row['è½‰å…¥å¸³æˆ¶']) {
                                const toAcc = accounts.find(a => a.name === row['è½‰å…¥å¸³æˆ¶']);
                                if (toAcc) toAccountId = toAcc.id;
                            }

                            const newDocRef = fbRef.current.doc(txCol);
                            batch.set(newDocRef, {
                                date, amount, type, category, subCategory, accountId, toAccountId,
                                note: note + (acc ? '' : ' (åŒ¯å…¥:æœªçŸ¥å¸³æˆ¶)'), 
                                debtor: row['ä»£å¢Šå°è±¡'] || '',
                                createdAt: new Date().toISOString()
                            });
                            importCount++;
                        });

                        await batch.commit();
                        alert(`æˆåŠŸåŒ¯å…¥ ${importCount} ç­†äº¤æ˜“ï¼`);
                    } catch (err) {
                        console.error("Import failed", err);
                        alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
                    } finally {
                        setIsImporting(false);
                        if (fileInputRef.current) fileInputRef.current.value = '';
                    }
                };
                reader.readAsBinaryString(file);
            };


            if (needConfig) return <div className="min-h-screen bg-stone-50 flex items-center justify-center p-6"><div className="bg-white max-w-md w-full p-8 rounded-3xl shadow-xl"><div className="flex justify-center mb-6 text-stone-800"><Icon name="settings" size={48}/></div><h2 className="text-xl font-bold text-center mb-4">è¼¸å…¥ Firebase è¨­å®š</h2><textarea className="w-full h-48 p-4 bg-stone-50 rounded-xl text-xs font-mono mb-4 border" placeholder='{ "apiKey": "..." }' value={configInput} onChange={e=>setConfigInput(e.target.value)}/><button onClick={handleSaveConfig} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold">å„²å­˜</button></div></div>;
            if (!sdkReady || loading) return <div className="h-screen flex items-center justify-center bg-stone-50"><Icon name="loader-2" className="animate-spin text-stone-500" size={40}/></div>;

            if (viewingAccount) {
                return (
                     <div className="min-h-screen pb-24 max-w-xl mx-auto bg-stone-50 relative">
                        <header className="sticky top-0 z-20 bg-stone-900 text-white px-4 py-4 flex justify-between items-center shadow-lg">
                            <button onClick={()=>setViewingAccount(null)} className="p-2 bg-white/10 rounded-lg"><Icon name="arrow-left"/></button>
                            <h1 className="font-bold text-lg">{viewingAccount.name} <span className="text-xs opacity-50">{viewingAccount.currency}</span></h1>
                            <div className="w-10"></div>
                        </header>
                        <div className="p-4 space-y-4">
                            <div className="flex items-center justify-between bg-white rounded-xl p-2 shadow-sm border border-stone-200">
                                <button onClick={()=>changeDetailMonthStep(-1)} className="p-2 hover:bg-stone-50 rounded-lg text-stone-400"><Icon name="chevron-left"/></button>
                                <div className="text-center font-bold text-stone-800 text-lg">{accountDetailMonth.replace('-','å¹´ ')}æœˆ</div>
                                <button onClick={()=>changeDetailMonthStep(1)} className="p-2 hover:bg-stone-50 rounded-lg text-stone-400"><Icon name="chevron-right"/></button>
                            </div>
                            <div className="bg-stone-900 rounded-xl p-6 text-white shadow-lg">
                                <div className="flex justify-between items-end mb-4"><div><p className="text-xs text-stone-400 mb-1">ç•¶å‰é¤˜é¡</p><h2 className="text-3xl font-black tabular-nums">${(accountDetailData?.currentBalance||0).toLocaleString()}</h2></div></div>
                                <div className="grid grid-cols-3 gap-2 text-center text-xs">
                                    <div className="bg-white/10 p-2 rounded"><p className="text-stone-400 mb-1">æ”¶å…¥</p><p className="font-bold text-emerald-400">+${accountDetailData?.stats.mIncome.toLocaleString()}</p></div>
                                    <div className="bg-white/10 p-2 rounded"><p className="text-stone-400 mb-1">æ”¯å‡º</p><p className="font-bold text-rose-400">-${accountDetailData?.stats.mExpense.toLocaleString()}</p></div>
                                    <div className="bg-white/10 p-2 rounded"><p className="text-stone-400 mb-1">è½‰å¸³</p><p className={`font-bold ${accountDetailData?.stats.mTrans >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{accountDetailData?.stats.mTrans > 0 ? '+' : ''}{accountDetailData?.stats.mTrans.toLocaleString()}</p></div>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <h3 className="text-xs font-bold text-stone-400 uppercase ml-1">äº¤æ˜“æ˜ç´° (å«é¤˜é¡)</h3>
                                {accountDetailData?.displayList.length === 0 ? <div className="text-center py-10 text-stone-400 text-sm">æœ¬æœˆç„¡äº¤æ˜“</div> : 
                                    accountDetailData?.displayList.map(tx => (
                                    <div key={tx.id} className="bg-white p-3 rounded-xl shadow-sm border border-stone-100 flex justify-between items-center">
                                            <div className="flex items-center gap-3">
                                                 <div className={`p-2 rounded-lg text-white ${tx.displayType==='income'?'bg-emerald-500': tx.displayType==='expense'?'bg-rose-500':'bg-slate-500'}`}><Icon name={getCategoryIcon(tx.category, tx.type)} size={16}/></div>
                                                 <div><p className="font-bold text-sm text-stone-800">{tx.category} <span className="text-xs font-normal text-stone-400">{tx.date.slice(5)}</span></p><p className="text-xs text-stone-400">{tx.note || 'ç„¡å‚™è¨»'}</p></div>
                                            </div>
                                            <div className="text-right"><p className={`font-bold tabular-nums ${tx.change > 0 ? 'text-emerald-600' : 'text-stone-800'}`}>{tx.change > 0 ? '+' : ''}{tx.change.toLocaleString()}</p><p className="text-xs text-stone-400 font-bold mt-0.5 tabular-nums">é¤˜é¡: ${tx.balanceSnapshot.toLocaleString()}</p></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                     </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 max-w-xl mx-auto bg-stone-50 relative">
                    <Header currentBook={currentBook} setIsBookSelectOpen={()=>setModal('bookSelect')} user={user} handleGoogleLogin={handleGoogleLogin} />
                    
                    <main className="p-4 space-y-6">
                        {activeTab === 'home' && (
                            <div className="animate-in space-y-6">
                                <div className="flex items-center justify-between bg-white rounded-xl p-2 shadow-sm border border-stone-200">
                                    <button onClick={()=>changeMonthStep(-1)} className="p-2 hover:bg-stone-50 rounded-lg text-stone-400"><Icon name="chevron-left"/></button>
                                    <div className="text-center font-bold text-stone-800 text-lg">{currentLedgerMonth.replace('-','å¹´ ')}æœˆ</div>
                                    <button onClick={()=>changeMonthStep(1)} className="p-2 hover:bg-stone-50 rounded-lg text-stone-400"><Icon name="chevron-right"/></button>
                                </div>
                                <div className={`rounded-xl p-6 text-white shadow-lg relative overflow-hidden bg-gradient-to-br from-orange-400 to-rose-600`}>
                                    <p className="text-white/80 text-xs mb-1">æœ¬æœˆçµé¤˜</p>
                                    <h2 className="text-4xl font-black tabular-nums">${(stats.inc - stats.exp).toLocaleString()}</h2>
                                    <div className="flex gap-4 mt-6">
                                            <div className="flex-1 p-3 bg-white/20 rounded-lg backdrop-blur-sm"><p className="text-xs text-white/80">æ”¶å…¥</p><p className="font-bold text-white">+${stats.inc.toLocaleString()}</p></div>
                                            <div className="flex-1 p-3 bg-white/20 rounded-lg backdrop-blur-sm"><p className="text-xs text-white/80">æ”¯å‡º</p><p className="font-bold text-white">-${stats.exp.toLocaleString()}</p></div>
                                    </div>
                                    <div className="mt-4 bg-white p-2 rounded-lg text-xs flex items-center gap-2 font-bold text-stone-700 shadow-sm"><Icon name={homeInsight.icon} size={14} className="text-rose-500"/> {homeInsight.text}</div>
                                </div>
                                <div className="space-y-4">
                                    {groupedTransactions.length === 0 ? <div className="text-center py-16 text-stone-400 text-sm border-2 border-dashed border-stone-200 rounded-xl bg-white">æœ¬æœˆå°šç„¡ç´€éŒ„</div> : 
                                        groupedTransactions.map(([date, txs]) => (
                                            <div key={date} className="animate-in slide-in-from-bottom">
                                                <div className="flex items-center gap-2 mb-2 px-1">
                                                    <span className="text-xs font-bold text-stone-400 bg-stone-100 px-2 py-1 rounded-md tabular-nums">{date}</span>
                                                    <span className="text-xs font-bold text-stone-400">{getDayOfWeek(date)}</span>
                                                </div>
                                                <div className="bg-white rounded-xl shadow-sm border border-stone-100 overflow-hidden">
                                                    {txs.map((tx, idx) => (
                                                        <div key={tx.id} onClick={() => openTxModal(tx.type, tx)} className={`p-4 flex justify-between items-center cursor-pointer hover:bg-stone-50 transition-colors ${idx !== txs.length - 1 ? 'border-b border-stone-50' : ''}`}>
                                                            <div className="flex items-center gap-3">
                                                                <div className={`p-2.5 rounded-xl ${tx.type==='income'?'bg-emerald-50 text-emerald-600': tx.type==='advance'?'bg-indigo-50 text-indigo-600' : 'bg-stone-100 text-stone-600'}`}><Icon name={getCategoryIcon(tx.category, tx.type)} size={18}/></div>
                                                                <div><p className="font-bold text-sm text-stone-800">{tx.type === 'advance' ? `ä»£å¢Š: ${tx.debtor}` : (tx.category || 'æœªåˆ†é¡')} {tx.subCategory && <span className="text-xs text-stone-400 ml-1">({tx.subCategory})</span>}</p><p className="text-xs text-stone-400 mt-0.5">{tx.note}</p></div>
                                                            </div>
                                                            <div className="text-right"><p className={`font-bold tabular-nums ${tx.type==='income'?'text-emerald-600':'text-stone-800'}`}>{tx.type==='income'?'+':'-'}{parseFloat(tx.amount).toLocaleString()}</p><div className="flex justify-end gap-3 mt-1" onClick={e => e.stopPropagation()}><button onClick={()=>deleteData('transactions', tx.id)} className="text-stone-300 hover:text-rose-500"><Icon name="trash-2" size={14}/></button></div></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'assets' && (
                            <div className="animate-in space-y-4">
                                <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-stone-800">æˆ‘çš„å¸³æˆ¶</h2><button onClick={()=>{setEditTarget(null); setAccForm({name:'', type:'cash', currency:'TWD', initialBalance:'', includeInTotal: true}); setModal('acc')}}><Icon name="plus-circle" className="text-rose-500"/></button></div>
                                <div className="bg-stone-800 rounded-xl p-5 text-white shadow-lg">
                                    <div className="flex justify-between mb-2"><span className="text-xs text-stone-400">FIRE é€²åº¦</span><span className="font-bold">{retireProgress.pct.toFixed(1)}%</span></div>
                                    <div className="h-2 bg-stone-700 rounded-full overflow-hidden mb-2"><div className="h-full bg-gradient-to-r from-yellow-400 to-rose-500" style={{width:`${Math.min(100, retireProgress.pct)}%`}}></div></div>
                                    <p className="text-xs text-stone-400 flex justify-between"><span>ç›®æ¨™ ${Math.round(retireProgress.target/10000).toLocaleString()} è¬</span><span>å‰© {retireProgress.years} å¹´</span></p>
                                    <div className={`mt-3 p-2 rounded-lg bg-white/10 text-xs flex items-start gap-2 ${retirementInsight.color}`}>
                                        <Icon name={retirementInsight.icon} size={14} className="mt-0.5"/>
                                        <span>{retirementInsight.text}</span>
                                    </div>
                                </div>
                                <div className="grid gap-3">{accounts.map((acc, index) => (
                                    <div key={acc.id} onClick={() => { setViewingAccount(acc); setAccountDetailMonth(currentLedgerMonth); }} className="bg-white p-4 rounded-xl shadow-sm border border-stone-100 relative cursor-pointer hover:shadow-md transition-shadow" draggable onDragStart={() => (dragItem.current = index)} onDragEnter={() => (dragOverItem.current = index)} onDragEnd={handleSort} onDragOver={(e) => e.preventDefault()}>
                                            <div className="absolute top-3 right-3 flex gap-2" onClick={e => e.stopPropagation()}>
                                                <button onClick={()=>{setEditTarget(acc); openAccModalCorrect(acc);}} className="text-stone-400 hover:text-rose-500"><Icon name="edit-2" size={14}/></button>
                                                <button onClick={()=>deleteData('accounts', acc.id)} className="text-stone-400 hover:text-rose-600"><Icon name="trash-2" size={14}/></button>
                                            </div>
                                            <div className="flex gap-3 items-center mb-2">
                                                <div className="text-stone-300 cursor-move" onClick={e => e.stopPropagation()}><Icon name="grip-vertical" size={16}/></div>
                                                <div className={`p-2 rounded-lg ${ACCOUNT_TYPES[acc.type]?.color || 'bg-stone-100 text-stone-600'}`}><Icon name={ACCOUNT_TYPES[acc.type]?.iconName || 'wallet'} size={18}/></div>
                                                <div><h3 className="font-bold text-stone-700">{acc.name}</h3>{acc.includeInTotal === false && <span className="text-xs bg-stone-100 text-stone-400 px-1 rounded">ä¸è¨ˆå…¥</span>}</div>
                                            </div>
                                            <p className="text-2xl font-black tabular-nums text-stone-800 ml-7">${(acc.marketValue || stats.bals[acc.id]||0).toLocaleString()} <span className="text-xs text-stone-400 font-normal">{acc.currency}</span></p>
                                            {acc.currency!=='TWD' && <p className="text-xs text-stone-400 font-bold tabular-nums ml-7">â‰ˆ TWD ${Math.round((acc.marketValue || stats.bals[acc.id]||0) * (exchangeRates[acc.currency]||1)).toLocaleString()}</p>}
                                            {acc.type === 'invest' && (<div className="mt-2 pt-2 border-t flex justify-between items-center text-xs ml-7" onClick={e => e.stopPropagation()}><span className="text-stone-400">æˆæœ¬: ${(stats.bals[acc.id]||0).toLocaleString()}</span><button onClick={()=>{setEditTarget(acc); setNewMarketValue(acc.marketValue||''); setModal('market')}} className="text-rose-500 font-bold bg-rose-50 px-2 py-1 rounded">èª¿æ•´å¸‚å€¼</button></div>)}
                                    </div>
                                ))}</div>
                            </div>
                        )}
                        {/* Settings, Analysis, Debts tabs same as V15.3, omitted for brevity but preserved structure */}
                        {activeTab === 'settings' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold text-stone-800">è¨­å®š</h2>
                                <button onClick={()=>setModal('budget')} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700"><div>æœˆé ç®—è¨­å®š <span className="text-xs text-stone-400 font-normal block">ç›®å‰: ${monthlyBudget.toLocaleString()}</span></div><Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>{setRetireForm(retirement); setModal('retire')}} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700"><div>é€€ä¼‘è¨ˆç•« <span className="text-xs text-stone-400 font-normal block">{retirement.retireAge}æ­²é€€ä¼‘ / æœˆèŠ±è²»${retirement.monthlyExpense}</span></div><Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>setModal('cat')} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700">é¡åˆ¥ç®¡ç† <Icon name="chevron-right" className="text-stone-300"/></button>
                                <button onClick={()=>setModal('rate')} className="w-full bg-white p-4 rounded-xl shadow-sm border border-stone-100 text-left font-bold flex justify-between items-center text-stone-700">åŒ¯ç‡è¨­å®š <Icon name="chevron-right" className="text-stone-300"/></button>
                                {/* Excel Export/Import Buttons */}
                                <div className="grid grid-cols-2 gap-3 mt-4">
                                    <button onClick={handleExport} className="bg-emerald-50 text-emerald-600 p-4 rounded-xl font-bold text-center border border-emerald-100 flex items-center justify-center gap-2"><Icon name="download" size={18}/> åŒ¯å‡º Excel</button>
                                    <button onClick={handleImportClick} className="bg-blue-50 text-blue-600 p-4 rounded-xl font-bold text-center border border-blue-100 flex items-center justify-center gap-2"><Icon name="upload" size={18}/> åŒ¯å…¥ Excel</button>
                                    <input type="file" ref={fileInputRef} onChange={handleImportFile} className="hidden" accept=".xlsx, .xls, .csv" />
                                </div>
                                <button onClick={()=>{localStorage.removeItem('my_ledger_firebase_config');window.location.reload()}} className="w-full bg-red-50 text-red-600 p-4 rounded-xl font-bold mt-8 text-center border border-red-100">é‡è¨­ App é€£ç·š</button>
                                {isImporting && <div className="text-center text-sm text-stone-400 mt-2">æ­£åœ¨åŒ¯å…¥è³‡æ–™ï¼Œè«‹ç¨å€™...</div>}
                            </div>
                        )}
                        {activeTab === 'analysis' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold text-stone-800 px-1">æ”¶æ”¯åˆ†æ</h2>
                                <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100 space-y-3">
                                    <div className="flex justify-between items-center bg-stone-50 rounded-lg p-1">
                                            <button onClick={()=>changeMonthStep(-1)} className="p-2 text-stone-400"><Icon name="chevron-left"/></button>
                                            <div className="relative">
                                                <span className="font-bold text-stone-700">{currentLedgerMonth.replace('-','å¹´ ')}æœˆ</span>
                                                <input type="month" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" value={currentLedgerMonth} onChange={e=>setCurrentLedgerMonth(e.target.value)} />
                                            </div>
                                            <button onClick={()=>changeMonthStep(1)} className="p-2 text-stone-400"><Icon name="chevron-right"/></button>
                                    </div>
                                    <div className="flex bg-stone-100 p-1 rounded-lg">
                                            <button onClick={()=>setAnalysisType('expense')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisType==='expense'?'bg-white text-rose-500 shadow':'text-stone-400'}`}>æ”¯å‡º</button>
                                            <button onClick={()=>setAnalysisType('income')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisType==='income'?'bg-white text-emerald-500 shadow':'text-stone-400'}`}>æ”¶å…¥</button>
                                    </div>
                                    <div className="flex bg-stone-100 p-1 rounded-lg">
                                            <button onClick={()=>setAnalysisGroupBy('main')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisGroupBy==='main'?'bg-white text-stone-800 shadow':'text-stone-400'}`}>ä¾ä¸»åˆ†é¡</button>
                                            <button onClick={()=>setAnalysisGroupBy('sub')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisGroupBy==='sub'?'bg-white text-stone-800 shadow':'text-stone-400'}`}>ä¾å­åˆ†é¡</button>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl p-6 shadow-sm border border-stone-100 flex flex-col items-center">
                                    {/* Pie Chart SVG */}
                                    <div className="relative h-48 w-48 mb-4">
                                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                                            {(() => {
                                                if (analysisData.chart.length === 1 && analysisData.chart[0].value > 0) {
                                                     return <circle cx="50" cy="50" r="40" fill={analysisData.chart[0].color} />;
                                                }
                                                let cumulative = 0;
                                                return analysisData.chart.map((d, i) => {
                                                    const startA = cumulative * Math.PI * 2; cumulative += d.percent / 100; const endA = cumulative * Math.PI * 2;
                                                    const x1 = 50 + 40 * Math.cos(startA), y1 = 50 + 40 * Math.sin(startA), x2 = 50 + 40 * Math.cos(endA), y2 = 50 + 40 * Math.sin(endA);
                                                    const largeArc = d.percent > 50 ? 1 : 0;
                                                    return <path key={i} d={`M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={d.color} stroke="#fff" strokeWidth="1" onClick={() => setSelectedCategory(d.name)} style={{cursor: 'pointer'}} />;
                                                });
                                            })()}
                                            {analysisData.total === 0 && <circle cx="50" cy="50" r="40" fill="#f5f5f4" />}
                                            <circle cx="50" cy="50" r="28" fill="white" />
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <p className="text-xs text-stone-400 font-bold uppercase">ç¸½é¡</p>
                                            <p className="text-sm font-black tabular-nums text-stone-800">${analysisData.total.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div className="w-full space-y-2">
                                            {analysisData.chart.map(d=>(
                                                <div key={d.name} className="flex items-center gap-2 text-sm">
                                                    <div className="w-3 h-3 rounded-full" style={{backgroundColor:d.color}}></div>
                                                    <div className="flex-1 font-bold text-stone-700">{d.name}</div>
                                                    <div className="font-bold tabular-nums text-stone-800">${d.value.toLocaleString()}</div>
                                                    <div className="text-xs text-stone-400 w-8 text-right">{Math.round(d.percent)}%</div>
                                                </div>
                                            ))}
                                            {analysisData.total === 0 && <p className="text-center text-stone-400 text-xs py-2">æœ¬æœˆå°šç„¡ç´€éŒ„</p>}
                                    </div>
                                </div>
                                {/* Drill down list if category selected */}
                                {selectedCategory && (
                                    <div className="bg-white rounded-xl p-4 shadow-sm border border-stone-100">
                                            <div className="flex justify-between mb-2 items-center">
                                                <h3 className="font-bold text-stone-700">{selectedCategory} æ˜ç´°</h3>
                                                <button onClick={()=>setSelectedCategory(null)} className="text-stone-400"><Icon name="x" size={16}/></button>
                                            </div>
                                            {analysisData.filteredTx.filter(t=>t.category===selectedCategory || t.subCategory===selectedCategory).map(tx=>(
                                                <div key={tx.id} className="flex justify-between py-2 border-b last:border-0 text-sm">
                                                    <span className="text-stone-500 tabular-nums">{tx.date}</span>
                                                    <span className="truncate flex-1 mx-2 text-stone-700">{tx.note || tx.subCategory || '-'}</span>
                                                    <span className="font-bold tabular-nums text-stone-800">${parseFloat(tx.amount).toLocaleString()}</span>
                                                </div>
                                            ))}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {activeTab === 'debts' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold px-1 text-stone-800">ä»£å¢Šèˆ‡å¾…æ”¶</h2>
                                <div className="bg-teal-600 rounded-xl p-6 text-white shadow-md">
                                    <p className="text-xs opacity-80 font-bold uppercase tracking-widest mb-1">å¾…æ”¶ç¸½é¡</p>
                                    <h2 className="text-4xl font-black tabular-nums">${stats.debt.toLocaleString()}</h2>
                                </div>
                                <div className="space-y-3">
                                    {transactions.filter(t => t.type === 'advance' && getRemainingDebt(t.id) > 1).map(tx => (
                                        <div key={tx.id} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-teal-500 flex justify-between items-center">
                                            <div>
                                                <div className="flex items-center gap-2 mb-1"><span className="bg-teal-50 text-teal-700 px-2 py-0.5 rounded text-xs font-bold">å°è±¡: {tx.debtor}</span><span className="text-xs text-stone-400 tabular-nums">{tx.date}</span></div>
                                                <p className="font-bold text-lg text-stone-800 tabular-nums">${getRemainingDebt(tx.id).toLocaleString()}</p>
                                                <p className="text-xs text-stone-500">{tx.note || 'ç„¡å‚™è¨»'}</p>
                                            </div>
                                            <button onClick={() => { setSettleTargetTx({ ...tx, amount: getRemainingDebt(tx.id) }); setModal('settle'); }} className="bg-stone-600 text-white px-4 py-2 rounded-lg text-xs font-bold shadow hover:bg-stone-700">æ”¶æ¬¾</button>
                                        </div>
                                    ))}
                                    {transactions.filter(t => t.type === 'advance' && getRemainingDebt(t.id) > 1).length===0 && <div className="text-center py-10 text-stone-400 text-sm">ç„¡å¾…æ”¶é …ç›®</div>}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-0 w-full bg-white border-t border-stone-200 px-6 py-3 flex justify-between z-[100] pb-safe max-w-xl mx-auto left-0 right-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <NavBtn icon={<Icon name="home"/>} label="å¸³æœ¬" active={activeTab==='home'} onClick={()=>setActiveTab('home')}/>
                        <NavBtn icon={<Icon name="pie-chart"/>} label="åˆ†æ" active={activeTab==='analysis'} onClick={()=>setActiveTab('analysis')}/>
                        <NavBtn icon={<Icon name="credit-card"/>} label="å¾…æ”¶" active={activeTab==='debts'} onClick={()=>setActiveTab('debts')}/>
                        <NavBtn icon={<Icon name="landmark"/>} label="å¸³æˆ¶" active={activeTab==='assets'} onClick={()=>setActiveTab('assets')}/>
                        <NavBtn icon={<Icon name="settings"/>} label="è¨­å®š" active={activeTab==='settings'} onClick={()=>setActiveTab('settings')}/>
                    </nav>

                    {/* FAB (Fire Theme) */}
                    {activeTab === 'home' && <button onClick={()=>openTxModal('expense')} className="fixed bottom-24 right-6 bg-gradient-to-r from-orange-500 to-rose-500 text-white p-4 rounded-full shadow-lg z-[100] transition-transform active:scale-95 border-2 border-white"><Icon name="plus" size={32}/></button>}

                    {/* --- Modals (All z-[200] to ensure top) --- */}
                    
                    {/* TX Modal */}
                    {modal === 'tx' && (
                        <div className="fixed inset-0 z-[200] bg-black/50 flex items-end sm:items-center justify-center p-4">
                            <div className="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-in slide-in-from-bottom max-h-[90vh] overflow-y-auto">
                                <h3 className="font-bold text-xl mb-4 text-stone-800">è¨˜ä¸€ç­†</h3>
                                <input type="number" className="w-full text-4xl font-black mb-4 outline-none tabular-nums text-stone-800 placeholder-stone-300" placeholder="0" value={txForm.amount} onChange={e=>setTxForm({...txForm, amount:e.target.value})} autoFocus />
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <button onClick={()=>{setTxForm({...txForm, type:'expense', category: categories['expense'][0].name});}} className={`p-3 rounded-lg font-bold ${txForm.type==='expense'?'bg-rose-100 text-rose-600':'bg-stone-100 text-stone-500'}`}>æ”¯å‡º</button>
                                    <button onClick={()=>{setTxForm({...txForm, type:'income', category: categories['income'][0].name});}} className={`p-3 rounded-lg font-bold ${txForm.type==='income'?'bg-emerald-100 text-emerald-600':'bg-stone-100 text-stone-500'}`}>æ”¶å…¥</button>
                                </div>
                                <div className="space-y-4">
                                    <div className="flex gap-2">
                                        <select className="flex-1 bg-stone-50 p-3 rounded-lg font-bold text-stone-700" value={txForm.category} onChange={e=>{
                                            if(e.target.value === 'ADD_NEW') {
                                                setEditingCategoryType(txForm.type); 
                                                setModal('cat');
                                            } else {
                                                setTxForm({...txForm, category:e.target.value});
                                            }
                                        }}>
                                            {categories[txForm.type].map(c=><option key={c.name} value={c.name}>{c.name}</option>)}
                                            <option value="ADD_NEW">â• æ–°å¢é¡åˆ¥...</option>
                                        </select>
                                        <button 
                                            onClick={()=>{setEditingCategoryType(txForm.type); setModal('cat');}} 
                                            className="px-3 bg-stone-100 rounded-lg text-stone-500 hover:bg-stone-200 flex items-center justify-center"
                                            title="ç®¡ç†é¡åˆ¥"
                                        >
                                            <Icon name="plus" size={20}/>
                                        </button>
                                    </div>
                                    {/* Sub Categories */}
                                    {categories[txForm.type].find(c=>c.name===txForm.category)?.subs?.length > 0 && (
                                        <div className="flex flex-wrap gap-2">
                                            {categories[txForm.type].find(c=>c.name===txForm.category).subs.map(s=>(
                                                <button key={s} onClick={()=>setTxForm({...txForm, subCategory:s})} className={`px-3 py-1 rounded-full text-xs font-bold border transition-colors ${txForm.subCategory===s?'bg-stone-800 text-white':'bg-white text-stone-500'}`}>{s}</button>
                                            ))}
                                        </div>
                                    )}
                                    
                                    {!isOffset ? (
                                        <select className="w-full bg-stone-50 p-3 rounded-lg font-bold text-stone-700" value={txForm.accountId} onChange={e=>setTxForm({...txForm, accountId:e.target.value})}>
                                            <option value="">é¸æ“‡å¸³æˆ¶</option>
                                            {accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}
                                        </select>
                                    ) : (
                                        <select className="w-full bg-rose-50 border-rose-200 p-3 rounded-lg font-bold text-rose-700" value={offsetTargetId} onChange={e=>setOffsetTargetId(e.target.value)}>
                                            <option value="">é¸æ“‡å¾…æ”¶å°è±¡...</option>
                                            {Object.values(stats.advanceMap).filter(a => !a.isSettled && a.remaining > 0.1).map(adv => (
                                                <option key={adv.id} value={adv.id}>{adv.debtor} (å‰©é¤˜ ${adv.remaining})</option>
                                            ))}
                                        </select>
                                    )}

                                    <div className="flex items-center gap-2">
                                        <input type="date" className="bg-stone-50 p-3 rounded-lg flex-1 font-bold text-stone-700" value={txForm.date} onChange={e=>setTxForm({...txForm, date:e.target.value})} />
                                        
                                        {/* å‚™è¨»æ¬„ä½èˆ‡éº¥å…‹é¢¨ */}
                                        <div className="flex-[2] flex gap-1">
                                            <input className="bg-stone-50 p-3 rounded-lg w-full font-bold text-stone-700" placeholder="å‚™è¨»" value={txForm.note} onChange={e=>setTxForm({...txForm, note:e.target.value})} />
                                            <button onClick={handleVoiceInput} className="bg-stone-100 p-3 rounded-lg text-stone-500 hover:text-rose-500 hover:bg-rose-50 transition-colors">
                                                <Icon name="mic" size={20} />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Advanced Options */}
                                    {txForm.type === 'expense' && (
                                        <div className="space-y-2 pt-2 border-t border-stone-100">
                                            <label className="flex items-center justify-between p-2">
                                                <span className="text-sm font-bold text-stone-500">ä½¿ç”¨å¾…æ”¶æŠµæ‰£ (äº’æŠµ)</span>
                                                <input type="checkbox" checked={isOffset} onChange={e=>{
                                                    setIsOffset(e.target.checked);
                                                    if(e.target.checked) {
                                                        setIsAdvanceSplit(false); 
                                                        setInstallment({...installment, enabled: false});
                                                    }
                                                }} />
                                            </label>

                                            {!isOffset && (
                                            <>
                                                <label className="flex items-center justify-between p-2">
                                                    <span className="text-sm font-bold text-stone-500">åˆ†æœŸä»˜æ¬¾</span>
                                                    <input type="checkbox" checked={installment.enabled} onChange={e=>setInstallment({...installment, enabled:e.target.checked})} />
                                                </label>
                                                {installment.enabled && <select className="w-full bg-white border p-2 rounded" value={installment.periods} onChange={e=>setInstallment({...installment, periods:e.target.value})}><option value="3">3 æœŸ</option><option value="6">6 æœŸ</option><option value="12">12 æœŸ</option></select>}
                                                <label className="flex items-center justify-between p-2">
                                                    <span className="text-sm font-bold text-stone-500">ä»£å¢Šæ¬¾ (å¤šäºº)</span>
                                                    <input type="checkbox" checked={isAdvanceSplit} onChange={e=>setIsAdvanceSplit(e.target.checked)} />
                                                </label>
                                                {isAdvanceSplit && (
                                                    <div className="p-2 bg-stone-50 rounded space-y-2">
                                                        {splitData.advances.map((adv, idx) => (
                                                            <div key={idx} className="flex gap-2">
                                                                <input placeholder="å°è±¡" className="border p-2 rounded w-1/2 text-sm" value={adv.debtor} onChange={e=>updateAdvanceRow(idx, 'debtor', e.target.value)} />
                                                                <input type="number" placeholder="é‡‘é¡" className="border p-2 rounded w-1/3 text-sm tabular-nums" value={adv.amount} onChange={e=>updateAdvanceRow(idx, 'amount', e.target.value)} />
                                                                {splitData.advances.length > 1 && <button onClick={()=>removeAdvanceRow(idx)} className="text-red-500"><Icon name="x" size={16}/></button>}
                                                            </div>
                                                        ))}
                                                        <button onClick={addAdvanceRow} className="text-xs text-rose-600 font-bold flex items-center gap-1 p-1">+ æ–°å¢å°è±¡</button>
                                                        <div className="text-xs text-stone-400 text-right mt-1 tabular-nums border-t border-stone-200 pt-1">
                                                            ç¸½ä»£å¢Š: ${splitData.advances.reduce((s,a)=>s+(parseFloat(a.amount)||0),0)} / è‡ªä»˜: ${Math.max(0, (parseFloat(txForm.amount)||0) - splitData.advances.reduce((s,a)=>s+(parseFloat(a.amount)||0),0))}
                                                        </div>
                                                    </div>
                                                )}
                                            </>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={()=>setModal(null)} className="flex-1 bg-stone-100 py-3 rounded-xl font-bold text-stone-500">å–æ¶ˆ</button>
                                    <button onClick={handleTxSave} className="flex-1 bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-rose-200">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Account Modal */}
                    {modal === 'acc' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">{editTarget ? 'ç·¨è¼¯å¸³æˆ¶' : 'æ–°å¢å¸³æˆ¶'}</h3>
                                 <input className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200" placeholder="åç¨±" value={accForm.name} onChange={e=>setAccForm({...accForm, name:e.target.value})}/>
                                 <select className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200" value={accForm.type} onChange={e=>setAccForm({...accForm, type:e.target.value})}>{Object.entries(ACCOUNT_TYPES).map(([k,v])=><option key={k} value={k}>{v.label}</option>)}</select>
                                 <input type="number" className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200 tabular-nums" placeholder="åˆå§‹é¤˜é¡" value={accForm.initialBalance} onChange={e=>setAccForm({...accForm, initialBalance:e.target.value})}/>
                                 <div className="flex gap-2 mb-4"><span className="p-3 bg-stone-100 rounded text-sm text-stone-500">å¹£åˆ¥</span><select className="flex-1 p-3 bg-stone-50 rounded border border-stone-200" value={accForm.currency} onChange={e=>setAccForm({...accForm, currency:e.target.value})}>{CURRENCIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                 <label className="flex items-center gap-3 p-3 bg-stone-50 rounded-lg mb-6 cursor-pointer border border-stone-200">
                                    <div className={`w-5 h-5 rounded-md flex items-center justify-center border ${accForm.includeInTotal ? 'bg-rose-500 border-rose-500 text-white' : 'bg-white border-stone-300'}`}>{accForm.includeInTotal && <Icon name="check" size={14} />}</div>
                                    <input type="checkbox" className="hidden" checked={accForm.includeInTotal} onChange={e=>setAccForm({...accForm, includeInTotal:e.target.checked})} />
                                    <span className="text-sm font-bold text-stone-700">è¨ˆå…¥ç¸½è³‡ç”¢</span>
                                 </label>
                                 <button onClick={handleAccSubmit} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400 py-2">å–æ¶ˆ</button>
                             </div>
                         </div>
                    )}

                    {/* Book Select Modal */}
                    {modal === 'bookSelect' && (
                        <div className="fixed inset-0 z-[200] bg-black/50 flex items-end justify-center p-4">
                            <div className="bg-white w-full max-w-sm p-6 rounded-t-2xl">
                                <h3 className="font-bold text-xl mb-4 text-stone-800">åˆ‡æ›å¸³æœ¬</h3>
                                <button onClick={()=>setModal('addBook')} className="w-full py-3 bg-stone-100 rounded-xl font-bold mb-2 text-stone-600">+ æ–°å¢å¸³æœ¬</button>
                                {books.map(b=><button key={b.id} onClick={()=>{setCurrentBook(b);setModal(null)}} className={`w-full py-3 text-left border-b font-bold ${currentBook.id===b.id?'text-rose-500':'text-stone-600'}`}>{b.name}</button>)}
                                <button onClick={()=>setModal(null)} className="w-full py-3 mt-4 text-stone-400">å–æ¶ˆ</button>
                            </div>
                        </div>
                    )}

                    {/* Add Book Modal */}
                    {modal === 'addBook' && (
                         <div className="fixed inset-0 z-[210] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">æ–°å¢æ—…éŠå¸³æœ¬</h3>
                                 <input className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200" placeholder="åç¨±" id="newBookName"/>
                                 <button onClick={()=>{
                                     saveData('books', {name: document.getElementById('newBookName').value, currency:'TWD'});
                                     setModal(null);
                                 }} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">å»ºç«‹</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">å–æ¶ˆ</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Budget Modal */}
                    {modal === 'budget' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">è¨­å®šæœˆé ç®—</h3>
                                 <input type="number" className="w-full p-3 bg-stone-50 rounded-lg mb-4 border border-stone-200 tabular-nums" value={monthlyBudget} onChange={e=>setMonthlyBudget(e.target.value)}/>
                                 <button onClick={()=>{ handleBudgetSubmit(monthlyBudget); setModal(null); }} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">å–æ¶ˆ</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Retire Modal */}
                    {modal === 'retire' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">é€€ä¼‘è¨ˆç•«</h3>
                                 <input type="number" placeholder="ç›®å‰å¹´é½¡" className="w-full p-3 border rounded-lg mb-2 tabular-nums" value={retireForm.currentAge} onChange={e=>setRetireForm({...retireForm, currentAge:e.target.value})}/>
                                 <input type="number" placeholder="é€€ä¼‘å¹´é½¡" className="w-full p-3 border rounded-lg mb-2 tabular-nums" value={retireForm.retireAge} onChange={e=>setRetireForm({...retireForm, retireAge:e.target.value})}/>
                                 <input type="number" placeholder="æœˆèŠ±è²»" className="w-full p-3 border rounded-lg mb-2 tabular-nums" value={retireForm.monthlyExpense} onChange={e=>setRetireForm({...retireForm, monthlyExpense:e.target.value})}/>
                                 <button onClick={()=>{handleRetireSubmit({preventDefault:()=>{}}); setModal(null);}} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">å„²å­˜</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">å–æ¶ˆ</button>
                             </div>
                         </div>
                    )}
                    
                     {/* Category Modal */}
                    {modal === 'cat' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl max-h-[80vh] overflow-y-auto">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">é¡åˆ¥ç®¡ç†</h3>
                                 <div className="flex gap-2 mb-4">
                                     <button onClick={()=>setEditingCategoryType('expense')} className={`flex-1 py-2 rounded ${editingCategoryType==='expense'?'bg-rose-500 text-white':'bg-stone-100 text-stone-500'}`}>æ”¯å‡º</button>
                                     <button onClick={()=>setEditingCategoryType('income')} className={`flex-1 py-2 rounded ${editingCategoryType==='income'?'bg-rose-500 text-white':'bg-stone-100 text-stone-500'}`}>æ”¶å…¥</button>
                                 </div>
                                 <div className="space-y-2">
                                     {categories[editingCategoryType].map(c=>(
                                         <div key={c.name} className="flex justify-between p-3 bg-stone-50 rounded-lg cursor-pointer hover:bg-stone-100" onClick={()=>{setEditingCategory(c); setModal('editCat')}}>
                                             <span><Icon name={c.icon} size={14} className="inline mr-2"/>{c.name}</span>
                                             <span className="text-xs text-stone-400">{c.subs.length} å­é¡åˆ¥ ></span>
                                         </div>
                                     ))}
                                 </div>
                                 <div className="mt-4 pt-4 border-t flex gap-2">
                                     <input id="newCatName" placeholder="æ–°é¡åˆ¥åç¨±" className="flex-1 p-2 border rounded" value={newCatForm.name} onChange={e=>setNewCatForm({...newCatForm, name:e.target.value, type:editingCategoryType})}/>
                                     <button onClick={handleAddCategory} className="bg-blue-600 text-white px-4 rounded">æ–°å¢</button>
                                 </div>
                                 <button onClick={()=>setModal(null)} className="w-full mt-4 text-stone-400">é—œé–‰</button>
                             </div>
                         </div>
                    )}
                    
                    {/* ğŸŸ¢ ä»‹é¢ä¿®æ­£ï¼šå®Œæ•´ç‰ˆç·¨è¼¯è¦–çª— */}
                    {modal === 'editCat' && editingCategory && (
                        <div className="fixed inset-0 z-[210] bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                
                                {/* 1. æ¨™é¡Œèˆ‡åç¨±ç·¨è¼¯ */}
                                <div className="flex items-center gap-2 mb-4">
                                    <Icon name={editingCategory.icon} size={24} className="text-rose-500"/>
                                    <input 
                                        className="font-bold text-xl bg-transparent border-b border-stone-300 focus:border-rose-500 outline-none w-full py-1" 
                                        value={editingCategory.name} 
                                        onChange={(e) => handleEditMainCategoryName(e.target.value)}
                                    />
                                </div>
                                
                                {/* 2. Icon é¸æ“‡å€ */}
                                <div className="mb-4 h-24 overflow-y-auto grid grid-cols-6 gap-2 p-2 bg-stone-50 rounded border border-stone-100">
                                    {AVAILABLE_ICONS.map(icon => (
                                        <button key={icon} onClick={() => handleEditMainCategoryIcon(icon)} className={`p-2 rounded hover:bg-stone-200 transition-colors ${editingCategory.icon === icon ? 'bg-rose-100 text-rose-500' : 'text-stone-400'}`}>
                                            <Icon name={icon} size={18}/>
                                        </button>
                                    ))}
                                </div>

                                {/* 3. å­é¡åˆ¥åˆ—è¡¨ (Chips) */}
                                <div className="flex flex-wrap gap-2 mb-4 max-h-32 overflow-y-auto">
                                    {editingCategory.subs.map(s => (
                                        <span key={s} className="bg-stone-100 px-3 py-1 rounded-full text-sm flex items-center gap-1 text-stone-600 border border-stone-200">
                                            {s} 
                                            <button onClick={() => handleDeleteSubCategory(editingCategory.name, s)} className="text-stone-400 hover:text-red-500 w-4 h-4 flex items-center justify-center rounded-full hover:bg-red-50">
                                                <Icon name="x" size={12}/>
                                            </button>
                                        </span>
                                    ))}
                                </div>

                                {/* 4. ğŸŸ¢ è£œå›æ¶ˆå¤±çš„ï¼šæ–°å¢å­é¡åˆ¥è¼¸å…¥æ¡† */}
                                <div className="flex gap-2 mb-6">
                                    <input id="newSubCat" className="flex-1 border border-stone-200 p-2 rounded-lg text-sm outline-none focus:border-rose-500 transition-colors" placeholder="æ–°å¢å­é¡åˆ¥" />
                                    <button 
                                        onClick={() => {
                                            const input = document.getElementById('newSubCat');
                                            handleAddSubCategory(editingCategory.name, input.value);
                                            input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                                            input.focus();    // ä¿æŒç„¦é»æ–¹ä¾¿é€£çºŒè¼¸å…¥
                                        }} 
                                        className="bg-rose-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-rose-600 active:scale-95 transition-all"
                                    >
                                        æ–°å¢
                                    </button>
                                </div>

                                {/* 5. åº•éƒ¨æŒ‰éˆ•å€ (åˆªé™¤ / å–æ¶ˆ / å„²å­˜) */}
                                <div className="pt-4 border-t border-stone-100 flex flex-col gap-3">
                                    <button onClick={() => { handleDeleteCategory(editingCategory.name); setModal('cat'); }} className="w-full text-red-400 text-xs py-2 hover:bg-red-50 rounded-lg flex items-center justify-center gap-1 transition-colors">
                                        <Icon name="trash-2" size={14} /> åˆªé™¤æ­¤ä¸»é¡åˆ¥
                                    </button>
                                    
                                    <div className="flex gap-3">
                                        <button onClick={() => setModal('cat')} className="flex-1 py-3 rounded-xl bg-stone-100 text-stone-500 font-bold hover:bg-stone-200 transition-colors">
                                            å–æ¶ˆ
                                        </button>
                                        <button onClick={handleSaveCategoryChanges} className="flex-1 py-3 rounded-xl bg-stone-800 text-white font-bold shadow-lg hover:bg-stone-900 transition-transform active:scale-95">
                                            ç¢ºå®šå„²å­˜
                                        </button>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    )}
                    
                    {/* Rate Modal */}
                    {modal === 'rate' && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl max-h-[80vh] overflow-y-auto">
                                 <h3 className="font-bold text-xl mb-4 text-stone-800">åŒ¯ç‡è¨­å®š (1 å¤–å¹£ = ? TWD)</h3>
                                 <div className="space-y-2">
                                     {CURRENCIES.filter(c=>c!=='TWD').map(c=>(
                                         <div key={c} className="flex justify-between items-center"><span className="font-bold w-12 text-stone-600">{c}</span><input type="number" className="border p-2 rounded w-32 text-right tabular-nums" value={exchangeRates[c]||''} onChange={e=>setExchangeRates({...exchangeRates, [c]:parseFloat(e.target.value)})}/></div>
                                     ))}
                                 </div>
                                 <button onClick={handleRatesSubmit} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold mt-4 shadow-lg">å„²å­˜</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Market Value Modal */}
                    {modal === 'market' && editTarget && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-2 text-stone-800">æ›´æ–°å¸‚å€¼</h3>
                                 <p className="text-sm text-stone-500 mb-4">{editTarget.name} ({editTarget.currency})</p>
                                 <input type="number" autoFocus className="w-full p-4 bg-stone-50 rounded-xl text-2xl font-black mb-4 outline-none tabular-nums text-stone-800" value={newMarketValue} onChange={e=>setNewMarketValue(e.target.value)} placeholder="æœ€æ–°å¸‚å€¼" />
                                 <button onClick={handleUpdateMarketValue} className="w-full bg-rose-500 text-white py-3 rounded-xl font-bold shadow-lg">æ›´æ–°</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">å–æ¶ˆ</button>
                             </div>
                         </div>
                    )}
                    
                    {/* Settle Modal */}
                    {modal === 'settle' && settleTargetTx && (
                         <div className="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-sm p-6 rounded-2xl">
                                 <h3 className="font-bold text-xl mb-2 text-stone-800">æ”¶å›ä»£å¢Š</h3>
                                 <p className="text-stone-500 mb-4">å°è±¡: {settleTargetTx.debtor} / é‡‘é¡: ${settleTargetTx.amount.toLocaleString()}</p>
                                 <select className="w-full p-3 border rounded-lg mb-4" value={settleToAccount} onChange={e=>setSettleToAccount(e.target.value)}><option value="">å­˜å…¥å¸³æˆ¶</option>{accounts.map(a=><option key={a.id} value={a.id}>{a.name}</option>)}</select>
                                 <button onClick={handleSettle} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg">ç¢ºèªæ”¶æ¬¾</button>
                                 <button onClick={()=>setModal(null)} className="w-full mt-2 text-stone-400">å–æ¶ˆ</button>
                             </div>
                         </div>
                    )}

                    {error && (
                        <div className="fixed inset-0 z-[300] bg-black/50 flex items-center justify-center p-6">
                            <div className="bg-white p-6 rounded-2xl max-w-xs w-full shadow-2xl">
                                <h3 className="font-bold text-lg text-rose-500 mb-2">{error.title}</h3>
                                <p className="text-sm text-stone-600 mb-4 whitespace-pre-wrap">{error.message}</p>
                                <button onClick={()=>setError(null)} className="w-full bg-stone-800 text-white py-2 rounded-lg">OK</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
