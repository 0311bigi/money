<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Èõ≤Á´ØÂ∏≥Êú¨ Pro (V17.0)</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Èõ≤Á´ØÂ∏≥Êú¨">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1c1917">
    
    <script>
        window.EMBEDDED_CONFIG = {
          apiKey: "AIzaSyD5AwqqAkFRBNY-f-FXAMAbf4H8BlBCGsk",
          authDomain: "bigi-1234.firebaseapp.com",
          projectId: "bigi-1234",
          storageBucket: "bigi-1234.firebasestorage.app",
          messagingSenderId: "177215769037",
          appId: "1:177215769037:web:740e6d3277ef5f7e0b1c84",
          measurementId: "G-5Q2HQY3S6Y"
        }; 
    </script>

    <script>
        (function() {
            var c = document.createElement('canvas'); c.width = 512; c.height = 512; var x = c.getContext('2d');
            x.fillStyle = '#e11d48'; 
            x.fillRect(0, 0, 512, 512);
            x.strokeStyle = 'rgba(255,255,255,0.2)'; x.lineWidth = 40; x.beginPath(); x.arc(512, 512, 200, 0, Math.PI*2); x.stroke();
            x.fillStyle = '#fff'; x.font = 'bold 300px sans-serif'; x.textAlign = 'center'; x.textBaseline = 'middle'; x.fillText('Â∏≥', 256, 270);
            var u = c.toDataURL('image/png');
            var l1 = document.createElement('link'); l1.rel = 'apple-touch-icon'; l1.href = u; document.head.appendChild(l1);
            var l2 = document.createElement('link'); l2.rel = 'icon'; l2.type = 'image/png'; l2.href = u; document.head.appendChild(l2);
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        /* Ê†πÂ≠óÈ´îÂ§ßÂ∞èË®≠ÂÆö */
        html { font-size: 18px; }
        
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 text-base">
    <div id="root"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        window.FirebaseSDK = { initializeApp, getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setDoc, query, where, writeBatch, getDoc, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut };
        window.isFirebaseSDKReady = true;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => { if (window.lucide && ref.current) { const i = document.createElement('i'); i.setAttribute('data-lucide', name); ref.current.innerHTML = ''; ref.current.appendChild(i); window.lucide.createIcons({ root: ref.current, attrs: { width: String(size), height: String(size), class: className } }); } }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
        };

        const getLocalToday = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
        const getLocalMonth = () => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; };
        const addMonths = (dStr, m) => { const [y,M,d]=dStr.split('-').map(Number); const nd=new Date(y,M-1+m,1); if(m>0) return `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-01`; const maxD=new Date(nd.getFullYear(),nd.getMonth()+1,0).getDate(); return `${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}-${String(Math.min(d,maxD)).padStart(2,'0')}`; };
        const getDayOfWeek = (dateStr) => { const days = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠']; return days[new Date(dateStr).getDay()]; };

        const DEFAULT_CATS = { expense: [{name:'È£≤È£ü',icon:'utensils',subs:[]},{name:'‰∫§ÈÄö',icon:'bus',subs:[]},{name:'Ë≥ºÁâ©',icon:'shopping-bag',subs:[]},{name:'Â®õÊ®Ç',icon:'film',subs:[]},{name:'Â±Ö‰Ωè',icon:'home',subs:[]}], income: [{name:'Ëñ™Ë≥á',icon:'wallet',subs:[]},{name:'ÁçéÈáë',icon:'gift',subs:[]},{name:'ÊäïË≥á',icon:'trending-up',subs:[]}] };
        
        const ACCOUNT_TYPES = { 
            'cash': { label: 'ÁèæÈáë', iconName: 'coins', color: 'text-emerald-600 bg-emerald-50' },
            'bank': { label: 'ÈäÄË°å', iconName: 'landmark', color: 'text-blue-600 bg-blue-50' },
            'credit': { label: '‰ø°Áî®Âç°', iconName: 'credit-card', color: 'text-purple-600 bg-purple-50' },
            'electronic': { label: 'ÈõªÂ≠êË≤®Âπ£', iconName: 'smartphone-nfc', color: 'text-sky-600 bg-sky-50' },
            'invest': { label: 'ÊäïË≥áÁêÜË≤°', iconName: 'trending-up', color: 'text-rose-600 bg-rose-50' },
            'payable': { label: 'Êáâ‰ªòÂ∏≥Ê¨æ', iconName: 'file-minus', color: 'text-orange-600 bg-orange-50' },
            'receivable': { label: 'ÊáâÊî∂Â∏≥Ê¨æ', iconName: 'file-plus', color: 'text-teal-600 bg-teal-50' },
            'other': { label: 'ÂÖ∂ÂÆÉ', iconName: 'wallet', color: 'text-stone-600 bg-stone-100' }
        };

        const CURRENCIES = ['TWD','USD','JPY','EUR','CNY','HKD','KRW','AUD','CAD','GBP','SGD','CHF'];
        const DEFAULT_RATES = {'TWD':1,'USD':32.5,'JPY':0.22,'EUR':35.0,'CNY':4.5,'HKD':4.1,'KRW':0.024,'AUD':21.5,'CAD':24.0,'GBP':41.0,'SGD':24.2,'CHF':36.5};
        
        // Êì¥ÂÖÖÈ°èËâ≤Â∫´‰ª•ÊáâÂ∞çÊõ¥Â§öÂàÜÈ°û
        const CATEGORY_COLORS = { 'È£≤È£ü': '#0ea5e9', '‰∫§ÈÄö': '#22c55e', 'Ë≥ºÁâ©': '#eab308', 'Â®õÊ®Ç': '#a855f7', 'Â±Ö‰Ωè': '#f97316', 'ÈÜ´ÁôÇ': '#ef4444', 'ÊïôËÇ≤': '#6366f1', 'Ëñ™Ë≥á': '#10b981', 'ÁçéÈáë': '#f59e0b', 'ÊäïË≥á': '#f43f5e', 'ËΩâÂ∏≥': '#64748b', '‰ª£Â¢ä': '#8b5cf6', 'ÈÇÑÊ¨æ': '#14b8a6', 'Ëá™ÂãïÁπ≥Ê¨æ': '#94a3b8', 'ÈÅãÂãï': '#84cc16' };
        const FALLBACK_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

        const AVAILABLE_ICONS = ['utensils', 'coffee', 'beer', 'shopping-cart', 'shopping-bag', 'gift', 'bus', 'car', 'plane', 'bed', 'map', 'home', 'zap', 'wifi', 'phone', 'hammer', 'film', 'gamepad-2', 'music', 'camera', 'ticket', 'stethoscope', 'pill', 'heart', 'graduation-cap', 'book', 'briefcase', 'smile', 'frown', 'star', 'tag', 'dumbbell', 'more-horizontal'];
        
        const OFFSET_ACCOUNT_ID = 'virtual-offset-account';

        const NavBtn = ({icon, label, active, onClick}) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-full gap-1 ${active?'text-rose-600 scale-105':'text-stone-400 hover:text-stone-600'}`}>{icon}<span className="text-xs font-bold">{label}</span></button>
        );

        const Header = ({ currentBook, setIsBookSelectOpen, user, handleGoogleLogin, title }) => (
            <header className="sticky top-0 z-20 bg-white border-b border-stone-100 px-6 py-4 flex justify-between items-center shadow-sm">
                <div className="flex items-center gap-3 cursor-pointer p-2 hover:bg-stone-50 rounded-xl" onClick={() => !title && setIsBookSelectOpen(true)}>
                    <div className="bg-rose-500 p-2.5 rounded-xl text-white shadow-md shadow-rose-200"><Icon name={title ? 'landmark' : (currentBook.id==='main'?'book':'plane')} size={24}/></div>
                    <div><h1 className="font-bold text-lg text-stone-700 tracking-wide flex items-center gap-1.5">{title || currentBook.name} {!title && <Icon name="chevron-down" size={18} className="text-stone-400"/>}</h1></div>
                </div>
                {user?.isAnonymous ? <button onClick={handleGoogleLogin} className="text-sm font-bold text-rose-600 bg-rose-50 px-3 py-2 rounded-lg">ÁôªÂÖ•</button> : <div className="h-9 w-9 rounded-full overflow-hidden border border-stone-200"><img src={user?.photoURL||'https://via.placeholder.com/32'} alt="User"/></div>}
            </header>
        );

        function App() {
            const [sdkReady, setSdkReady] = useState(false);
            const [needConfig, setNeedConfig] = useState(false);
            const [configInput, setConfigInput] = useState('');
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('home');

            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATS);
            const [recurring, setRecurring] = useState([]);
            const [retirement, setRetirement] = useState({ currentAge:30, retireAge:60, monthlyExpense:30000, inflation:2 });
            const [exchangeRates, setExchangeRates] = useState(DEFAULT_RATES);
            const [monthlyBudget, setMonthlyBudget] = useState(30000);
            const [books, setBooks] = useState([]);
            const [currentBook, setCurrentBook] = useState({ id:'main', name:'Êó•Â∏∏Â∏≥Êú¨', currency:'TWD' });

            const [currentLedgerMonth, setCurrentLedgerMonth] = useState(getLocalMonth());
            const [analysisMode, setAnalysisMode] = useState('month');
            const [analysisType, setAnalysisType] = useState('expense');
            const [expandedCategory, setExpandedCategory] = useState(null); // ÊéßÂà∂ÂàÜÊûêÈ†ÅÂ±ïÈñãÂì™ÂÄãÈ°ûÂà•
            
            const [modal, setModal] = useState(null); 
            const [editTarget, setEditTarget] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState(null); 
            
            const [txForm, setTxForm] = useState({ type:'expense', amount:'', toAmount:'', category:'', subCategory:'', accountId:'', toAccountId:'', debtor:'', date:getLocalToday(), note:'', currency:'TWD' });
            const [editingTx, setEditingTx] = useState(null);
            const [accForm, setAccForm] = useState({ name:'', type:'cash', currency:'TWD', initialBalance:'', includeInTotal: true });
            const [recForm, setRecForm] = useState({ name:'', type:'expense', amount:'', day:1 });
            const [newCatForm, setNewCatForm] = useState({ name:'', icon:'tag', type:'expense' });
            const [retireForm, setRetireForm] = useState({});
            
            const [isAdvanceSplit, setIsAdvanceSplit] = useState(false);
            const [splitData, setSplitData] = useState({ advances:[{debtor:'',amount:''}], principalAmount:'', sourceAccountId:'' });
            const [installment, setInstallment] = useState({ enabled:false, periods:3 });
            const [settleToAccount, setSettleToAccount] = useState('');
            const [newMarketValue, setNewMarketValue] = useState('');
            const [editingCategoryType, setEditingCategoryType] = useState('expense');
            const [editingCategory, setEditingCategory] = useState(null);
            const [settleTargetTx, setSettleTargetTx] = useState(null);
            const [isOffset, setIsOffset] = useState(false);
            const [offsetTargetId, setOffsetTargetId] = useState('');
            const [viewingAccount, setViewingAccount] = useState(null);
            const [accountDetailMonth, setAccountDetailMonth] = useState(getLocalMonth());
            
            const [isImporting, setIsImporting] = useState(false);
            const fileInputRef = useRef(null);

            const fbRef = useRef(null);
            const authRef = useRef(null);
            const dbRef = useRef(null);
            const appId = 'my-cloud-ledger-pro';

            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            useEffect(() => {
                const init = () => {
                    if (window.isFirebaseSDKReady) {
                        try {
                            let cfg = window.EMBEDDED_CONFIG;
                            if (!cfg) {
                                cfg = window.__firebase_config ? JSON.parse(window.__firebase_config) : JSON.parse(localStorage.getItem('my_ledger_firebase_config'));
                            }

                            if (cfg) {
                                const app = window.FirebaseSDK.initializeApp(cfg);
                                fbRef.current = window.FirebaseSDK;
                                authRef.current = window.FirebaseSDK.getAuth(app);
                                dbRef.current = window.FirebaseSDK.getFirestore(app);
                                setSdkReady(true);
                            } else { setNeedConfig(true); setLoading(false); }
                        } catch (e) { setNeedConfig(true); setLoading(false); }
                    } else setTimeout(init, 100);
                };
                init();
            }, []);

            const handleSaveConfig = () => {
                try {
                    let v = configInput.trim().replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g, '$1"$2":').replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
                    if(v.includes("const")) v = v.substring(v.indexOf('{'), v.lastIndexOf('}')+1);
                    const c = JSON.parse(v);
                    if(!c.apiKey) throw new Error("Áº∫Â∞ë apiKey");
                    localStorage.setItem('my_ledger_firebase_config', JSON.stringify(c));
                    window.location.reload();
                } catch(e) { setError({ title:"Ë®≠ÂÆöÁÑ°Êïà", message:e.message }); }
            };

            useEffect(() => {
                if (!sdkReady) return;
                const unsubAuth = fbRef.current.onAuthStateChanged(authRef.current, async (u) => {
                    if (u) setUser(u);
                    else {
                        try { await fbRef.current.signInAnonymously(authRef.current); }
                        catch (e) { setError({ title:"ÁôªÂÖ•Â§±Êïó", message: "Ë´ãÈñãÂïüÂåøÂêçÁôªÂÖ•ÊàñÊ™¢Êü•Á∂≤ÂüüÊéàÊ¨ä" }); setLoading(false); }
                    }
                });
                return () => unsubAuth();
            }, [sdkReady]);

            const handleGoogleLogin = async () => { try { await fbRef.current.signInWithPopup(authRef.current, new fbRef.current.GoogleAuthProvider()); } catch(e) { setError({title:"ÁôªÂÖ•ÈåØË™§", message:e.message}); } };

            useEffect(() => {
                if (!user || !sdkReady) return;
                const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                
                const checkAutoPay = async (accs) => {
                    const m = getLocalMonth();
                    const cards = accs.filter(a => a.type==='credit' && a.autoPayment && a.autoPaymentAccount);
                    if (cards.length === 0) return;
                    const batch = fbRef.current.writeBatch(dbRef.current);
                    let hasUpd = false;
                    cards.forEach(c => {
                        if (c.lastAutoPaymentMonth !== m && new Date().getDate() >= parseInt(c.paymentDueDay||15)) {
                            batch.set(fbRef.current.doc(fbRef.current.collection(userRef, 'transactions')), {
                                type: 'transfer', amount: 0, category: 'Ëá™ÂãïÁπ≥Ê¨æ', accountId: c.autoPaymentAccount, toAccountId: c.id, date: getLocalToday(), bookId: 'main', note: `[Á≥ªÁµ±] Âç°Ë≤ª (${c.name})`, createdAt: new Date().toISOString()
                            });
                            batch.update(fbRef.current.doc(userRef, 'accounts', c.id), { lastAutoPaymentMonth: m });
                            hasUpd = true;
                        }
                    });
                    if (hasUpd) await batch.commit();
                };

                const unsubs = [
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'transactions'), s => setTransactions(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>new Date(b.date)-new Date(a.date)))),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'accounts'), s => { 
                        const a = s.docs.map(d=>({id:d.id,...d.data()})).sort((a, b) => (a.order || 0) - (b.order || 0)); 
                        setAccounts(a); 
                        checkAutoPay(a); 
                    }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'config'), d => { 
                        if(d.exists()) { 
                            const data = d.data();
                            if (data.categories) setCategories(data.categories); 
                            if (data.budget) setMonthlyBudget(data.budget); 
                        } else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'config'), { categories: DEFAULT_CATS }, {merge: true}); 
                    }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'rates'), d => { if(d.exists()) setExchangeRates(d.data()); else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'rates'), DEFAULT_RATES, {merge: true}); }),
                    fbRef.current.onSnapshot(fbRef.current.doc(userRef, 'settings', 'retirement'), d => { if(d.exists()) setRetirement(d.data()); else fbRef.current.setDoc(fbRef.current.doc(userRef, 'settings', 'retirement'), retirement, {merge: true}); }),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'recurring'), s => setRecurring(s.docs.map(d=>({id:d.id,...d.data()})))),
                    fbRef.current.onSnapshot(fbRef.current.collection(userRef, 'books'), s => setBooks([{id:'main',name:'Êó•Â∏∏Â∏≥Êú¨',currency:'TWD'},...s.docs.map(d=>({id:d.id,...d.data()}))]))
                ];
                setLoading(false);
                return () => unsubs.forEach(u => u());
            }, [user, sdkReady]);

            const saveData = async (col, data, id=null) => {
                const ref = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                if (id) await fbRef.current.updateDoc(fbRef.current.doc(ref, col, id), data);
                else await fbRef.current.addDoc(fbRef.current.collection(ref, col), { ...data, createdAt: new Date().toISOString() });
            };
            const deleteData = async (col, id) => { await fbRef.current.deleteDoc(fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid, col, id)); };

            const getCategoryIcon = (catName, type) => {
                if(type === 'transfer') return 'arrow-right-left';
                if(type === 'advance') return 'hand-coins';
                if(type === 'repayment') return 'check-circle';
                if(type === 'transfer_in') return 'arrow-left-right'; 
                if(type === 'transfer_out') return 'arrow-right-left';
                if (!categories[type] && type!=='expense' && type!=='income') return 'tag';
                if (!categories[type]) return 'tag';
                const cat = categories[type].find(c => c.name === catName);
                return cat ? cat.icon : 'tag';
            };

            const stats = useMemo(() => {
                const bals = {}; accounts.forEach(a => bals[a.id] = parseFloat(a.initialBalance)||0);
                const advanceMap = {}; 
                transactions.forEach(t => { if (t.type === 'advance') advanceMap[t.id] = { ...t, repaid: 0, remaining: parseFloat(t.amount) }; });
                transactions.forEach(t => { if (t.type === 'repayment' && t.relatedTxId && advanceMap[t.relatedTxId]) { const repaidAmt = parseFloat(t.amount); advanceMap[t.relatedTxId].repaid += repaidAmt; advanceMap[t.relatedTxId].remaining -= repaidAmt; } });
                let debt = 0;
                Object.values(advanceMap).forEach(a => { if (!a.isSettled && a.remaining > 0.1) debt += a.remaining; });
                
                let totalAsset=0, inc=0, exp=0;
                transactions.forEach(t => {
                    const amt = parseFloat(t.amount)||0;
                    if (t.accountId !== OFFSET_ACCOUNT_ID && t.toAccountId !== OFFSET_ACCOUNT_ID) { 
                        if (t.type==='income'||t.type==='repayment') if(bals[t.accountId]!=null) bals[t.accountId]+=amt;
                        if (t.type==='expense'||t.type==='advance') if(bals[t.accountId]!=null) bals[t.accountId]-=amt;
                        if (t.type==='transfer') { if(bals[t.accountId]!=null) bals[t.accountId]-=amt; if(bals[t.toAccountId]!=null) bals[t.toAccountId]+=(t.toAmount?parseFloat(t.toAmount):amt); }
                    }
                    
                    const txDate = String(t.date || '');
                    if ((t.bookId||'main') === currentBook.id && txDate.startsWith(currentLedgerMonth)) {
                        if (t.type==='income') inc+=amt;
                        if (t.type==='expense') exp+=amt;
                    }
                });
                accounts.forEach(a => { if(a.includeInTotal !== false) { let v = (a.type==='invest' && a.marketValue) ? parseFloat(a.marketValue) : (bals[a.id]||0); if(a.currency!=='TWD') v *= (exchangeRates[a.currency]||1); totalAsset+=v; } });
                return { bals, totalAsset, inc, exp, debt, advanceMap };
            }, [accounts, transactions, currentLedgerMonth, currentBook, exchangeRates]);

            const retireProgress = useMemo(() => {
                const years = Math.max(0, retirement.retireAge - retirement.currentAge);
                const target = retirement.monthlyExpense * Math.pow(1 + (retirement.inflation/100), years) * 12 * 25;
                const pct = target > 0 ? Math.min(100, (stats.totalAsset / target) * 100) : 0;
                return { target, pct, years };
            }, [retirement, stats.totalAsset]);

            const homeInsight = useMemo(() => {
                const saving = stats.inc - stats.exp;
                if (saving < 0) return { type:'danger', icon:'alert-triangle', text:`‚ö†Ô∏è ÈÄèÊîØ $${Math.abs(saving)}` };
                if (stats.exp > monthlyBudget) return { type:'danger', icon:'alert-triangle', text:`‚ö†Ô∏è Ë∂ÖÂá∫È†êÁÆó $${stats.exp - monthlyBudget}` };
                return { type:'success', icon:'thumbs-up', text:`‚úÖ È†êÁÆóÂâ©È§ò $${monthlyBudget - stats.exp}` };
            }, [stats, monthlyBudget]);
            
            const retirementInsight = useMemo(() => {
                const savings = stats.inc - stats.exp;
                if (savings < 0) return { icon: 'alert-triangle', text: `‚ö†Ô∏è Êú¨ÊúàÈÄèÊîØÔºåË≥áÁî¢Á∏ÆÊ∞¥‰∏≠ÔºÅ`, color: 'text-rose-400', bg: 'bg-rose-500/20' };
                if (savings < retirement.monthlyExpense) return { icon: 'target', text: `üéØ Èõ¢ÊúàÂ≠òÈ°çÁõÆÊ®ôÈÇÑÊúâÂ∑ÆË∑ùÔºåÂä†Ê≤πÔºÅ`, color: 'text-amber-400', bg: 'bg-amber-500/20' };
                return { icon: 'party-popper', text: `üöÄ Â§™Ê£í‰∫ÜÔºÅÂÑ≤ËìÑÂäõË∂ÖÊ®ôÔºÅ`, color: 'text-emerald-400', bg: 'bg-emerald-500/20' };
            }, [stats, retirement, currentLedgerMonth]);

            // üü¢ V17 ÂçáÁ¥öÁâàÂàÜÊûêÊï∏ÊìöÔºöË®àÁÆó‰∏ªÂàÜÈ°ûËàáÂ≠êÂàÜÈ°ûÁöÑÈöéÂ±§ÁµêÊßã
            const analysisData = useMemo(() => {
                const bookTxs = transactions.filter(tx => (tx.bookId || 'main') === currentBook.id);
                let filteredTx = [];
                if (analysisMode === 'month') { filteredTx = bookTxs.filter(t => String(t.date || '').substring(0, 7) === currentLedgerMonth); } 
                else if (analysisMode === 'year') { const year = currentLedgerMonth.split('-')[0]; filteredTx = bookTxs.filter(t => String(t.date || '').substring(0, 4) === year); }

                const targetTx = filteredTx.filter(t => t.type === analysisType);
                const total = targetTx.reduce((sum, t) => sum + (parseFloat(t.amount)||0), 0);
                
                // Âª∫Á´ãÈöéÂ±§Ë≥áÊñô
                // breakdown = { 'È£≤È£ü': { total: 1000, subs: { 'Êó©È§ê': 200, 'ÂçàÈ§ê': 800 }, txs: [] } }
                const breakdown = {};
                targetTx.forEach(t => {
                    const cat = t.category;
                    const sub = t.subCategory || 'ÁÑ°Â≠êÈ°ûÂà•';
                    const amt = parseFloat(t.amount);
                    
                    if (!breakdown[cat]) breakdown[cat] = { total: 0, subs: {}, txs: [] };
                    breakdown[cat].total += amt;
                    breakdown[cat].txs.push(t);
                    
                    if (!breakdown[cat].subs[sub]) breakdown[cat].subs[sub] = 0;
                    breakdown[cat].subs[sub] += amt;
                });

                // ËΩâÁÇ∫Èô£Âàó‰∏¶ÊéíÂ∫è
                const chartData = Object.entries(breakdown).map(([name, data], index) => {
                    let color = CATEGORY_COLORS[name] || FALLBACK_COLORS[index % FALLBACK_COLORS.length];
                    const percent = total ? (data.total / total) * 100 : 0;
                    
                    // ËôïÁêÜÂ≠êÈ°ûÂà•Èô£Âàó
                    const subList = Object.entries(data.subs)
                        .map(([subName, subVal]) => ({ name: subName, value: subVal, percent: (subVal / data.total) * 100 }))
                        .sort((a,b) => b.value - a.value);

                    return { name, value: data.total, percent, color, subs: subList, txs: data.txs.sort((a,b)=>new Date(b.date)-new Date(a.date)) };
                }).sort((a,b) => b.value - a.value);

                return { total, chart: chartData };
            }, [transactions, analysisMode, currentLedgerMonth, currentBook, analysisType, categories]);

            const groupedTransactions = useMemo(() => {
                const targetTxs = transactions.filter(t => (t.bookId||'main')===currentBook.id && String(t.date || '').startsWith(currentLedgerMonth));
                const groups = {};
                targetTxs.forEach(tx => {
                    if (!groups[tx.date]) groups[tx.date] = [];
                    groups[tx.date].push(tx);
                });
                return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
            }, [transactions, currentBook, currentLedgerMonth]);
            
            const accountDetailData = useMemo(() => {
                if (!viewingAccount) return null;
                const related = transactions.filter(t => t.accountId === viewingAccount.id || t.toAccountId === viewingAccount.id);
                related.sort((a, b) => {
                    const dateA = new Date(a.date).getTime();
                    const dateB = new Date(b.date).getTime();
                    if (dateA !== dateB) return dateA - dateB;
                    return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
                });

                let balance = parseFloat(viewingAccount.initialBalance) || 0;
                const withBalance = related.map(t => {
                    const amt = parseFloat(t.amount);
                    let change = 0;
                    let type = 'neutral';
                    if (t.accountId === viewingAccount.id) {
                        if (t.type === 'expense' || t.type === 'advance') { balance -= amt; change = -amt; type = 'expense'; } 
                        else if (t.type === 'income' || t.type === 'repayment') { balance += amt; change = amt; type = 'income'; } 
                        else if (t.type === 'transfer') { balance -= amt; change = -amt; type = 'transfer_out'; }
                    } else if (t.toAccountId === viewingAccount.id && t.type === 'transfer') {
                        const inAmt = t.toAmount ? parseFloat(t.toAmount) : amt; balance += inAmt; change = inAmt; type = 'transfer_in';
                    }
                    return { ...t, balanceSnapshot: balance, change, displayType: type };
                });

                const monthTxs = withBalance.filter(t => String(t.date || '').startsWith(accountDetailMonth));
                const displayList = [...monthTxs].sort((a, b) => {
                     const dateA = new Date(a.date).getTime();
                     const dateB = new Date(b.date).getTime();
                     if (dateA !== dateB) return dateB - dateA;
                     return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
                });

                let mIncome = 0, mExpense = 0, mTrans = 0;
                monthTxs.forEach(t => {
                    if (t.displayType === 'income' || t.displayType === 'repayment') mIncome += t.change;
                    else if (t.displayType === 'expense' || t.displayType === 'advance') mExpense += Math.abs(t.change);
                    else if (t.displayType === 'transfer_in' || t.displayType === 'transfer_out') mTrans += t.change;
                });

                return { displayList, stats: { mIncome, mExpense, mTrans }, currentBalance: balance };
            }, [viewingAccount, transactions, accountDetailMonth]);

            const handleTxSave = () => {
                const amt = parseFloat(txForm.amount);
                if (!amt) { alert('Ë´ãËº∏ÂÖ•ÈáëÈ°ç'); return; }
                if (!txForm.accountId && !isOffset) { alert('Ë´ãÈÅ∏ÊìáÂ∏≥Êà∂'); return; }

                let finalCategory = txForm.category;
                if (!finalCategory) {
                    if (categories[txForm.type] && categories[txForm.type].length > 0) finalCategory = categories[txForm.type][0].name;
                    else finalCategory = 'Êú™ÂàÜÈ°û';
                }
                const createdAt = editingTx ? editingTx.createdAt : new Date().toISOString();
                const base = { ...txForm, bookId: currentBook.id, amount: amt, category: finalCategory, createdAt };
                if (editingTx) {
                    saveData('transactions', base, editingTx.id);
                    setModal(null);
                    setEditingTx(null);
                    return;
                }
                if (isOffset && offsetTargetId) {
                    saveData('transactions', { ...base, accountId: OFFSET_ACCOUNT_ID, note: `ÊäµÊâ£: ${txForm.note}` }); 
                    saveData('transactions', { type: 'repayment', amount: amt, accountId: OFFSET_ACCOUNT_ID, relatedTxId: offsetTargetId, date: txForm.date, bookId: currentBook.id, note: `ÊäµÊâ£ÊîØÂá∫ (${finalCategory})`, createdAt: new Date().toISOString() }); 
                    setModal(null); return;
                }
                if (txForm.type === 'expense' && installment.enabled) {
                    const p = parseInt(installment.periods);
                    const per = Math.round(amt / p);
                    for (let i = 0; i < p; i++) {
                        saveData('transactions', { ...base, amount: (i===0?amt-(per*p)+per:per), date: addMonths(txForm.date, i), note: `${txForm.note} (${i+1}/${p})`, createdAt: new Date().toISOString() });
                    }
                } else if (txForm.type === 'expense' && isAdvanceSplit) {
                     let advTotal = 0;
                     splitData.advances.forEach(a => {
                         if (a.debtor && a.amount) {
                             saveData('transactions', { ...base, type:'advance', amount: parseFloat(a.amount), debtor: a.debtor, isSettled: false, note: `‰ª£Â¢ä: ${txForm.note}`, createdAt: new Date().toISOString() });
                             advTotal += parseFloat(a.amount);
                         }
                     });
                     const myExp = amt - advTotal;
                     if (myExp > 0) saveData('transactions', { ...base, amount: myExp, createdAt: new Date().toISOString() });
                } else if (txForm.type === 'income' && isAdvanceSplit) {
                    const principal = parseFloat(splitData.principalAmount) || 0;
                    const gain = amt - principal;
                    if (principal > 0) saveData('transactions', { ...base, type: 'transfer', amount: principal, category: 'ËΩâÂ∏≥', accountId: splitData.sourceAccountId, toAccountId: txForm.accountId, note: `ÊäïË≥áÊú¨Èáë`, createdAt: new Date().toISOString() });
                    if (gain !== 0) saveData('transactions', { ...base, type: 'income', amount: gain, category: txForm.category || 'ÊäïË≥á', note: `ÊäïË≥áÁç≤Âà©`, createdAt: new Date().toISOString() });
                } else {
                    saveData('transactions', base);
                }
                setModal(null);
            };
            
            const handleAddSubCategory = (mainCat, sub) => {
                if (!sub) return;
                const newCats = { ...categories };
                const catIndex = newCats[editingCategoryType].findIndex(c => c.name === mainCat);
                if (catIndex > -1) {
                    const targetCat = { ...newCats[editingCategoryType][catIndex] };
                    if (!targetCat.subs.includes(sub)) {
                        targetCat.subs = [...targetCat.subs, sub]; 
                        newCats[editingCategoryType][catIndex] = targetCat;
                        setCategories(newCats);
                        setEditingCategory(targetCat); 
                    }
                }
            };

            const handleDeleteSubCategory = (mainCat, sub) => {
                const newCats = { ...categories };
                const catIndex = newCats[editingCategoryType].findIndex(c => c.name === mainCat);
                if (catIndex > -1) {
                    const targetCat = { ...newCats[editingCategoryType][catIndex] };
                    targetCat.subs = targetCat.subs.filter(s => s !== sub);
                    newCats[editingCategoryType][catIndex] = targetCat;
                    setCategories(newCats);
                    setEditingCategory(targetCat); 
                }
            };

            const handleSaveCategoryChanges = async () => {
                await saveData('settings', { categories: categories }, 'config');
                setModal(null); 
            };

            const handleVoiceInput = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ• (Ë´ã‰ΩøÁî® Chrome Êàñ Safari)");
                    return;
                }
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.start();
                recognition.onstart = () => { console.log("Ë´ãÈñãÂßãË™™Ë©±..."); };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    let processedText = transcript
                        .replace(/‰∏Ä/g, '1').replace(/‰∫å/g, '2').replace(/‰∏â/g, '3')
                        .replace(/Âõõ/g, '4').replace(/‰∫î/g, '5').replace(/ÂÖ≠/g, '6')
                        .replace(/‰∏É/g, '7').replace(/ÂÖ´/g, '8').replace(/‰πù/g, '9')
                        .replace(/ÂçÅ/g, '10').replace(/Áôæ/g, '00');
                    const amountMatch = processedText.match(/\d+/);
                    const amount = amountMatch ? amountMatch[0] : '';
                    let note = transcript.replace(amountMatch ? amountMatch[0] : '', '').replace(/ÂÖÉ|Â°ä/g, '').trim();
                    let matchedCategory = txForm.category;
                    let matchedSubCategory = '';
                    const keywordMap = {
                        'È£≤È£ü': ['ÂêÉ', 'È£Ø', 'È∫µ', 'È§ê', 'Âñù', 'È£≤Êñô', 'ÂÖ®ËÅØ', '7-11', '‰æøÁï∂'],
                        '‰∫§ÈÄö': ['Ëªä', 'Ê≤π', 'Êç∑ÈÅã', 'È´òÈêµ', 'ÊÇ†ÈÅäÂç°', 'Âä†Ê≤π'],
                        'Ë≥ºÁâ©': ['Ë≤∑', 'Ëù¶ÁöÆ', 'Ë°£Êúç', 'Èûã', 'Ë°õÁîüÁ¥ô'],
                        'Â®õÊ®Ç': ['ÈõªÂΩ±', 'ÈÅäÊà≤', 'Áé©', 'Netflix'],
                        'Â±Ö‰Ωè': ['ÈõªË≤ª', 'Ê∞¥Ë≤ª', 'ÊàøÁßü', 'Áì¶ÊñØ']
                    };
                    if (categories[txForm.type]) {
                        for (const cat of categories[txForm.type]) {
                            if (note.includes(cat.name)) { matchedCategory = cat.name; break; }
                            if (keywordMap[cat.name] && keywordMap[cat.name].some(k => note.includes(k))) { matchedCategory = cat.name; break; }
                            if (cat.subs) { const sub = cat.subs.find(s => note.includes(s)); if (sub) { matchedCategory = cat.name; matchedSubCategory = sub; break; } }
                        }
                    }
                    setTxForm(prev => ({ ...prev, amount: amount || prev.amount, category: matchedCategory, subCategory: matchedSubCategory, note: note || prev.note }));
                };
                recognition.onerror = (event) => { console.error("Ë™ûÈü≥Ëæ®Ë≠òÈåØË™§", event.error); };
            };

            const handleAccSubmit = async (e) => { 
                e.preventDefault(); 
                if (!accForm.name) return; 
                const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid); 
                const accountData = { ...accForm, order: editTarget ? editTarget.order : accounts.length }; 
                if (editTarget) { 
                    await fbRef.current.updateDoc(fbRef.current.doc(userRef, 'accounts', editTarget.id), accountData); 
                } else { 
                    await fbRef.current.addDoc(fbRef.current.collection(userRef, 'accounts'), { ...accountData, createdAt: new Date().toISOString() }); 
                } 
                setModal(null); 
            };

            const handleSort = async () => { if (dragItem.current === null || dragOverItem.current === null) return; const _accounts = [...accounts]; const draggedItemContent = _accounts[dragItem.current]; _accounts.splice(dragItem.current, 1); _accounts.splice(dragOverItem.current, 0, draggedItemContent); dragItem.current = null; dragOverItem.current = null; setAccounts(_accounts); const batch = fbRef.current.writeBatch(dbRef.current); const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid); _accounts.forEach((acc, index) => { const ref = fbRef.current.doc(userRef, 'accounts', acc.id); batch.update(ref, { order: index }); }); await batch.commit(); };
            const handleUpdateMarketValue = async () => { if (!editTarget) return; const accRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid, 'accounts', editTarget.id); await fbRef.current.updateDoc(accRef, { marketValue: parseFloat(newMarketValue) || 0 }); setModal(null); };
            const handleBudgetSubmit = (val) => { setMonthlyBudget(val); saveData('settings', { budget: parseFloat(val) }, 'config'); };
            const handleAddCategory = () => { if(!newCatForm.name) return; const newCats = {...categories}; newCats[newCatForm.type].push({ name: newCatForm.name, icon: newCatForm.icon, subs: [] }); setCategories(newCats); saveData('settings', {categories: newCats}, 'config'); };
            const handleDeleteCategory = (catName) => { const newCats = {...categories}; newCats[editingCategoryType] = newCats[editingCategoryType].filter(c => c.name !== catName); setCategories(newCats); saveData('settings', {categories: newCats}, 'config'); };
            const handleRatesSubmit = () => { saveData('settings', exchangeRates, 'rates'); setModal(null); };
            const updateAdvanceRow = (index, field, value) => { const newAdvances = [...splitData.advances]; newAdvances[index][field] = value; setSplitData({...splitData, advances: newAdvances}); };
            const addAdvanceRow = () => { setSplitData({...splitData, advances: [...splitData.advances, { debtor: '', amount: '' }]}); };
            const removeAdvanceRow = (index) => { if (splitData.advances.length <= 1) return; const newAdvances = splitData.advances.filter((_, i) => i !== index); setSplitData({...splitData, advances: newAdvances}); };
            const openTxModal = (type = 'expense', existingTx = null) => {
                 if (existingTx) { setEditingTx(existingTx); setTxForm({ ...existingTx, accountId: existingTx.accountId || (accounts.length > 0 ? accounts[0].id : ''), }); setIsAdvanceSplit(false); setIsOffset(false); setInstallment({ enabled: false, periods: 3 }); } else { setEditingTx(null); setTxForm({ ...txForm, type, category: categories[type] && categories[type].length > 0 ? categories[type][0].name : '', accountId: accounts.length > 0 ? accounts[0].id : '', amount: '', note: '', date: getLocalToday() }); setIsAdvanceSplit(false); setIsOffset(false); setSplitData({ advances:[{debtor:'',amount:''}], principalAmount:'', sourceAccountId:'' }); } setModal('tx');
            };
            const changeMonthStep = (step) => { const [y, m] = currentLedgerMonth.split('-').map(Number); const date = new Date(y, m - 1 + step, 1); setCurrentLedgerMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`); };
            const changeDetailMonthStep = (step) => { const [y, m] = accountDetailMonth.split('-').map(Number); const date = new Date(y, m - 1 + step, 1); setAccountDetailMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`); };
            const handleEditMainCategoryName = async (newName) => { if (!newName || !editingCategory) return; const newCats = { ...categories }; const catIdx = newCats[editingCategoryType].findIndex(c => c.name === editingCategory.name); if (catIdx > -1) { newCats[editingCategoryType][catIdx].name = newName; setCategories(newCats); setEditingCategory(newCats[editingCategoryType][catIdx]); } };
            const handleEditMainCategoryIcon = async (newIcon) => { if (!editingCategory) return; const newCats = { ...categories }; const catIdx = newCats[editingCategoryType].findIndex(c => c.name === editingCategory.name); if (catIdx > -1) { newCats[editingCategoryType][catIdx].icon = newIcon; setCategories(newCats); setEditingCategory(newCats[editingCategoryType][catIdx]); } };
            
            const openAccModalCorrect = (acc = null) => { if (acc) { setEditTarget(acc); setAccForm({ name: acc.name, type: acc.type, currency: acc.currency || 'TWD', initialBalance: acc.initialBalance || '', includeInTotal: acc.includeInTotal !== false, closingDay: acc.closingDay || '27', paymentDueDay: acc.paymentDueDay || '15', autoPaymentAccount: acc.autoPaymentAccount || '', holidayAdjustment: acc.holidayAdjustment || 'defer', autoPayment: acc.autoPayment || false }); } else { setEditTarget(null); setAccForm({ name: '', type: 'cash', currency: 'TWD', initialBalance: '', includeInTotal: true, closingDay: '27', paymentDueDay: '15', autoPaymentAccount: '', holidayAdjustment: 'defer', autoPayment: false }); } setModal('acc'); };

            const handleExport = () => {
                if (!window.XLSX) { alert("Excel ÂÖÉ‰ª∂ËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶"); return; }
                const wb = XLSX.utils.book_new();
                const txData = transactions.map(t => {
                    const accName = accounts.find(a => a.id === t.accountId)?.name || 'Êú™Áü•Â∏≥Êà∂';
                    const toAccName = t.toAccountId ? (accounts.find(a => a.id === t.toAccountId)?.name || 'Êú™Áü•Â∏≥Êà∂') : '';
                    let typeLabel = t.type;
                    if (t.type === 'expense') typeLabel = 'ÊîØÂá∫'; else if (t.type === 'income') typeLabel = 'Êî∂ÂÖ•'; else if (t.type === 'transfer') typeLabel = 'ËΩâÂ∏≥'; else if (t.type === 'advance') typeLabel = '‰ª£Â¢ä'; else if (t.type === 'repayment') typeLabel = 'ÈÇÑÊ¨æ';
                    return { Êó•Êúü: t.date, È°ûÂûã: typeLabel, ÈáëÈ°ç: t.amount, ‰∏ªÈ°ûÂà•: t.category, Â≠êÈ°ûÂà•: t.subCategory || '', Â∏≥Êà∂: accName, ËΩâÂÖ•Â∏≥Êà∂: toAccName, ÂÇôË®ª: t.note || '', ‰ª£Â¢äÂ∞çË±°: t.debtor || '', Âª∫Á´ãÊôÇÈñì: t.createdAt };
                });
                const wsTx = XLSX.utils.json_to_sheet(txData);
                XLSX.utils.book_append_sheet(wb, wsTx, "‰∫§ÊòìÁ¥ÄÈåÑ");
                const accData = accounts.map(a => ({ ÂêçÁ®±: a.name, È°ûÂûã: ACCOUNT_TYPES[a.type]?.label || a.type, Âπ£Âà•: a.currency, ÂàùÂßãÈ§òÈ°ç: a.initialBalance, Ë®àÂÖ•Á∏ΩË≥áÁî¢: a.includeInTotal ? 'ÊòØ' : 'Âê¶' }));
                const wsAcc = XLSX.utils.json_to_sheet(accData);
                XLSX.utils.book_append_sheet(wb, wsAcc, "Â∏≥Êà∂Ë®≠ÂÆö");
                XLSX.writeFile(wb, `Ë®òÂ∏≥ÂÇô‰ªΩ_${new Date().toISOString().slice(0,10)}.xlsx`);
            };

            const handleImportClick = () => { if (fileInputRef.current) fileInputRef.current.click(); };
            const handleImportFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsImporting(true);
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsName = wb.SheetNames.includes("‰∫§ÊòìÁ¥ÄÈåÑ") ? "‰∫§ÊòìÁ¥ÄÈåÑ" : wb.SheetNames[0];
                        const ws = wb.Sheets[wsName];
                        const jsonData = XLSX.utils.sheet_to_json(ws, { raw: false });
                        if (!jsonData || jsonData.length === 0) { alert("Ê™îÊ°àÂÖßÂÆπÁÇ∫Á©∫ÊàñÊ†ºÂºè‰∏çÁ¨¶"); setIsImporting(false); return; }
                        const batch = fbRef.current.writeBatch(dbRef.current);
                        const userRef = fbRef.current.doc(dbRef.current, 'artifacts', appId, 'users', user.uid);
                        const txCol = fbRef.current.collection(userRef, 'transactions');
                        let importCount = 0;
                        jsonData.forEach(row => {
                            let rawDate = row['Êó•Êúü'];
                            let date = '';
                            if (!rawDate) return; 
                            if (typeof rawDate === 'number') {
                                const excelDate = new Date(Math.round((rawDate - 25569) * 86400 * 1000));
                                date = excelDate.toISOString().split('T')[0];
                            } else {
                                try {
                                    let d = new Date(rawDate);
                                    if (isNaN(d.getTime())) d = new Date();
                                    date = d.toISOString().split('T')[0];
                                } catch (e) { return; }
                            }
                            const amount = parseFloat(row['ÈáëÈ°ç']);
                            const category = row['‰∏ªÈ°ûÂà•'] || 'Êú™ÂàÜÈ°û';
                            const subCategory = row['Â≠êÈ°ûÂà•'] || '';
                            const note = row['ÂÇôË®ª'] || '';
                            const accName = row['Â∏≥Êà∂'];
                            if (!date || isNaN(amount)) return;
                            let type = 'expense';
                            if (row['È°ûÂûã'] === 'Êî∂ÂÖ•') type = 'income'; else if (row['È°ûÂûã'] === 'ËΩâÂ∏≥') type = 'transfer'; else if (row['È°ûÂûã'] === '‰ª£Â¢ä') type = 'advance'; else if (row['È°ûÂûã'] === 'ÈÇÑÊ¨æ') type = 'repayment';
                            const acc = accounts.find(a => a.name === accName);
                            const accountId = acc ? acc.id : (accounts[0]?.id || ''); 
                            let toAccountId = '';
                            if (type === 'transfer' && row['ËΩâÂÖ•Â∏≥Êà∂']) { const toAcc = accounts.find(a => a.name === row['ËΩâÂÖ•Â∏≥Êà∂']); if (toAcc) toAccountId = toAcc.id; }
                            const newDocRef = fbRef.current.doc(txCol);
                            batch.set(newDocRef, { date, amount, type, category, subCategory, accountId, toAccountId, note: note + (acc ? '' : ' (ÂåØÂÖ•:Êú™Áü•Â∏≥Êà∂)'), debtor: row['‰ª£Â¢äÂ∞çË±°'] || '', createdAt: new Date().toISOString() });
                            importCount++;
                        });
                        await batch.commit();
                        alert(`ÊàêÂäüÂåØÂÖ• ${importCount} Á≠Ü‰∫§ÊòìÔºÅ`);
                    } catch (err) { console.error("Import failed", err); alert("ÂåØÂÖ•Â§±ÊïóÔºåË´ãÁ¢∫Ë™çÊ™îÊ°àÊ†ºÂºèÊòØÂê¶Ê≠£Á¢∫„ÄÇ"); } finally { setIsImporting(false); if (fileInputRef.current) fileInputRef.current.value = ''; }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <div className="min-h-screen pb-24 max-w-xl mx-auto bg-stone-900 text-stone-200 relative">
                    <div className="sticky top-0 z-20 bg-stone-900 border-b border-stone-800 px-6 py-4 flex justify-between items-center shadow-md">
                        <div className="flex items-center gap-3 cursor-pointer p-2 hover:bg-stone-800 rounded-xl" onClick={() => setIsBookSelectOpen(true)}>
                            <div className="bg-rose-500 p-2.5 rounded-xl text-white shadow-md shadow-rose-900/50"><Icon name={currentBook.id==='main'?'book':'plane'} size={24}/></div>
                            <div><h1 className="font-bold text-lg text-white tracking-wide flex items-center gap-1.5">{currentBook.name} <Icon name="chevron-down" size={18} className="text-stone-500"/></h1></div>
                        </div>
                        {user?.isAnonymous ? <button onClick={handleGoogleLogin} className="text-sm font-bold text-rose-400 bg-rose-500/10 px-3 py-2 rounded-lg">ÁôªÂÖ•</button> : <div className="h-9 w-9 rounded-full overflow-hidden border border-stone-700"><img src={user?.photoURL||'https://via.placeholder.com/32'} alt="User"/></div>}
                    </div>
                    
                    <main className="p-4 space-y-6">
                        {activeTab === 'home' && (
                            <div className="animate-in space-y-6">
                                <div className="flex items-center justify-between bg-stone-800 rounded-xl p-2 shadow-sm border border-stone-700">
                                    <button onClick={()=>changeMonthStep(-1)} className="p-2 hover:bg-stone-700 rounded-lg text-stone-400"><Icon name="chevron-left"/></button>
                                    <div className="text-center font-bold text-white text-lg">{currentLedgerMonth.replace('-','Âπ¥ ')}Êúà</div>
                                    <button onClick={()=>changeMonthStep(1)} className="p-2 hover:bg-stone-700 rounded-lg text-stone-400"><Icon name="chevron-right"/></button>
                                </div>
                                <div className={`rounded-xl p-6 text-white shadow-lg relative overflow-hidden bg-gradient-to-br from-orange-600 to-rose-700`}>
                                    <p className="text-white/80 text-xs mb-1">Êú¨ÊúàÁµêÈ§ò</p>
                                    <h2 className="text-4xl font-black tabular-nums">${(stats.inc - stats.exp).toLocaleString()}</h2>
                                    <div className="flex gap-4 mt-6">
                                            <div className="flex-1 p-3 bg-black/20 rounded-lg backdrop-blur-sm"><p className="text-xs text-white/80">Êî∂ÂÖ•</p><p className="font-bold text-white">+${stats.inc.toLocaleString()}</p></div>
                                            <div className="flex-1 p-3 bg-black/20 rounded-lg backdrop-blur-sm"><p className="text-xs text-white/80">ÊîØÂá∫</p><p className="font-bold text-white">-${stats.exp.toLocaleString()}</p></div>
                                    </div>
                                    <div className="mt-4 bg-stone-900/50 p-2 rounded-lg text-xs flex items-center gap-2 font-bold text-white shadow-sm"><Icon name={homeInsight.icon} size={14} className="text-rose-400"/> {homeInsight.text}</div>
                                </div>
                                <div className="space-y-4">
                                    {groupedTransactions.length === 0 ? <div className="text-center py-16 text-stone-500 text-sm border-2 border-dashed border-stone-800 rounded-xl bg-stone-900">Êú¨ÊúàÂ∞öÁÑ°Á¥ÄÈåÑ</div> : 
                                        groupedTransactions.map(([date, txs]) => (
                                            <div key={date} className="animate-in slide-in-from-bottom">
                                                <div className="flex items-center gap-2 mb-2 px-1">
                                                    <span className="text-xs font-bold text-stone-400 bg-stone-800 px-2 py-1 rounded-md tabular-nums">{date}</span>
                                                    <span className="text-xs font-bold text-stone-500">{getDayOfWeek(date)}</span>
                                                </div>
                                                <div className="bg-stone-800 rounded-xl shadow-sm border border-stone-700 overflow-hidden">
                                                    {txs.map((tx, idx) => {
                                                        const acc = accounts.find(a => a.id === tx.accountId);
                                                        let accName = acc ? acc.name : (tx.accountId === OFFSET_ACCOUNT_ID ? 'ÊäµÊâ£' : 'Êú™Áü•');
                                                        if (tx.type === 'transfer' && tx.toAccountId) {
                                                            const toAcc = accounts.find(a => a.id === tx.toAccountId);
                                                            accName += ` ‚ûù ${toAcc ? toAcc.name : 'Êú™Áü•'}`;
                                                        }
                                                        let rowStyle = "bg-stone-800 border-l-4 border-stone-800"; 
                                                        if (tx.type === 'expense') rowStyle = "bg-stone-800 border-l-4 border-rose-500";
                                                        if (tx.type === 'income') rowStyle = "bg-stone-800/50 border-l-4 border-emerald-500";
                                                        if (tx.type === 'transfer') rowStyle = "bg-stone-800/30 border-l-4 border-slate-500";
                                                        if (tx.type === 'advance') rowStyle = "bg-stone-800/30 border-l-4 border-indigo-500";

                                                        return (
                                                            <div key={tx.id} onClick={() => openTxModal(tx.type, tx)} className={`p-4 flex justify-between items-center cursor-pointer hover:bg-stone-700 transition-colors ${idx !== txs.length - 1 ? 'border-b border-stone-700' : ''} ${rowStyle}`}>
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`p-2.5 rounded-xl ${tx.type==='income'?'bg-emerald-500/10 text-emerald-400': tx.type==='advance'?'bg-indigo-500/10 text-indigo-400' : 'bg-stone-700 text-stone-400'}`}><Icon name={getCategoryIcon(tx.category, tx.type)} size={18}/></div>
                                                                    <div><p className="font-bold text-sm text-stone-200">{tx.type === 'advance' ? `‰ª£Â¢ä: ${tx.debtor}` : (tx.category || 'Êú™ÂàÜÈ°û')} {tx.subCategory && <span className="text-xs text-stone-500 ml-1">({tx.subCategory})</span>}</p><p className="text-xs text-stone-500 mt-0.5">{tx.note}</p></div>
                                                                </div>
                                                                <div className="text-right">
                                                                    <p className={`font-bold tabular-nums ${tx.type==='income'?'text-emerald-400':'text-stone-200'}`}>{tx.type==='income'?'+':'-'}{parseFloat(tx.amount).toLocaleString()}</p>
                                                                    <div className="flex items-center justify-end gap-1 mt-0.5">
                                                                        <span className="text-xs text-stone-500 bg-stone-900 px-1.5 py-0.5 rounded">{accName}</span>
                                                                        <button onClick={(e)=>{e.stopPropagation();deleteData('transactions', tx.id)}} className="text-stone-600 hover:text-rose-500 p-1"><Icon name="trash-2" size={14}/></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        ))
                                    }
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'analysis' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold text-white px-1">Êî∂ÊîØÂàÜÊûê</h2>
                                <div className="bg-stone-800 rounded-xl p-4 shadow-sm border border-stone-700 space-y-3">
                                    <div className="flex justify-between items-center bg-stone-900 rounded-lg p-1">
                                            <button onClick={()=>changeMonthStep(-1)} className="p-2 text-stone-400"><Icon name="chevron-left"/></button>
                                            <div className="relative">
                                                <span className="font-bold text-stone-200">{currentLedgerMonth.replace('-','Âπ¥ ')}Êúà</span>
                                                <input type="month" className="absolute inset-0 opacity-0 w-full h-full cursor-pointer" value={currentLedgerMonth} onChange={e=>setCurrentLedgerMonth(e.target.value)} />
                                            </div>
                                            <button onClick={()=>changeMonthStep(1)} className="p-2 text-stone-400"><Icon name="chevron-right"/></button>
                                    </div>
                                    <div className="flex bg-stone-900 p-1 rounded-lg">
                                            <button onClick={()=>setAnalysisType('expense')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisType==='expense'?'bg-stone-700 text-rose-400 shadow':'text-stone-500'}`}>ÊîØÂá∫</button>
                                            <button onClick={()=>setAnalysisType('income')} className={`flex-1 py-2 text-sm font-bold rounded-md ${analysisType==='income'?'bg-stone-700 text-emerald-400 shadow':'text-stone-500'}`}>Êî∂ÂÖ•</button>
                                    </div>
                                </div>
                                <div className="bg-stone-800 rounded-xl p-6 shadow-sm border border-stone-700 flex flex-col items-center">
                                    <div className="relative h-48 w-48 mb-4">
                                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                                            {(() => {
                                                if (analysisData.chart.length === 1 && analysisData.chart[0].value > 0) return <circle cx="50" cy="50" r="40" fill={analysisData.chart[0].color} />;
                                                let cumulative = 0;
                                                return analysisData.chart.map((d, i) => {
                                                    const startA = cumulative * Math.PI * 2; cumulative += d.percent / 100; const endA = cumulative * Math.PI * 2;
                                                    const x1 = 50 + 40 * Math.cos(startA), y1 = 50 + 40 * Math.sin(startA), x2 = 50 + 40 * Math.cos(endA), y2 = 50 + 40 * Math.sin(endA);
                                                    const largeArc = d.percent > 50 ? 1 : 0;
                                                    return <path key={i} d={`M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`} fill={d.color} stroke="#1c1917" strokeWidth="1" onClick={() => setExpandedCategory(expandedCategory === d.name ? null : d.name)} style={{cursor: 'pointer'}} />;
                                                });
                                            })()}
                                            <circle cx="50" cy="50" r="28" fill="#1c1917" />
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                                            <p className="text-xs text-stone-500 font-bold uppercase">Á∏ΩÈ°ç</p>
                                            <p className="text-sm font-black tabular-nums text-white">${analysisData.total.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    
                                    {/* üü¢ V17.0 ÈöéÂ±§ÂºèÂàóË°® */}
                                    <div className="w-full space-y-3">
                                        <div className="flex justify-between text-xs text-stone-500 px-2 font-bold uppercase tracking-wider"><span>È°ûÂà•</span><span>ÈáëÈ°ç / ÊØî‰æã</span></div>
                                        {analysisData.chart.map((d, index) => (
                                            <div key={d.name} className="space-y-1">
                                                {/* ‰∏ªÈ°ûÂà• Row */}
                                                <div 
                                                    className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${expandedCategory === d.name ? 'bg-stone-700' : 'bg-stone-900 hover:bg-stone-700/50'}`}
                                                    onClick={() => setExpandedCategory(expandedCategory === d.name ? null : d.name)}
                                                >
                                                    <div className="font-black text-stone-500 w-4 text-center">{index + 1}</div>
                                                    <div className="w-3 h-3 rounded-full shrink-0" style={{backgroundColor: d.color}}></div>
                                                    <div className="flex-1 font-bold text-stone-200">{d.name}</div>
                                                    <div className="text-right">
                                                        <div className={`font-bold tabular-nums ${analysisType==='income'?'text-emerald-400':'text-rose-400'}`}>${d.value.toLocaleString()}</div>
                                                        <div className="text-xs text-stone-500 font-bold">{Math.round(d.percent)}%</div>
                                                    </div>
                                                </div>

                                                {/* Â±ïÈñãÂæåÁöÑÂ≠êÈ°ûÂà•ÂàóË°®Ëàá‰∫§ÊòìÊòéÁ¥∞ */}
                                                {expandedCategory === d.name && (
                                                    <div className="pl-10 pr-2 space-y-2 animate-in slide-in-from-top-2 duration-200">
                                                        {/* Â≠êÈ°ûÂà•Áµ±Ë®à */}
                                                        {d.subs.length > 0 && d.subs.map((sub, sIdx) => (
                                                            <div key={sub.name} className="flex justify-between text-sm py-1 border-b border-stone-700 last:border-0">
                                                                <span className="text-stone-400 flex items-center gap-2">
                                                                    <span className="text-[10px] bg-stone-700 px-1.5 rounded text-stone-300">{index+1}-{sIdx+1}</span>
                                                                    {sub.name}
                                                                </span>
                                                                <span className="text-stone-300 tabular-nums">
                                                                    ${sub.value.toLocaleString()} 
                                                                    <span className="text-xs text-stone-500 ml-1">({Math.round(sub.percent)}%)</span>
                                                                </span>
                                                            </div>
                                                        ))}
                                                        
                                                        {/* Ë©≤È°ûÂà•ÁöÑÊâÄÊúâ‰∫§ÊòìÊòéÁ¥∞ */}
                                                        <div className="mt-2 bg-black/20 rounded-lg p-2">
                                                            <p className="text-[10px] text-stone-500 mb-1 font-bold uppercase">ËøëÊúüÊòéÁ¥∞</p>
                                                            {d.txs.map(t => (
                                                                <div key={t.id} className="flex justify-between items-center py-1.5 border-b border-white/5 last:border-0 text-xs" onClick={()=>openTxModal(t.type, t)}>
                                                                    <div className="text-stone-400">
                                                                        <span className="mr-2 opacity-50">{t.date.slice(5)}</span>
                                                                        <span>{t.subCategory || t.note || 'ÁÑ°ÂÇôË®ª'}</span>
                                                                    </div>
                                                                    <div className="tabular-nums font-bold text-stone-300">${parseFloat(t.amount).toLocaleString()}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                        {analysisData.total === 0 && <p className="text-center text-stone-500 text-xs py-4">Êú¨ÊúàÂ∞öÁÑ°Á¥ÄÈåÑ</p>}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* ÈÄôË£°‰øùÁïô Assets, Settings, Debts ÁöÑÂÖßÂÆπÔºåÁÇ∫ÁØÄÁúÅÁØáÂπÖËàá‰∏äÊñπÁõ∏ÂêåÔºå‰ΩÜÂ∫ïËâ≤ÈúÄÊîπÁÇ∫ Dark Mode È¢®Ê†º */}
                        {/* ... (ÂÖ∂È§òÈ†ÅÈù¢Á®ãÂºèÁ¢ºË´ãÊ≤øÁî® V16.5 ÁöÑÈÇèËºØÔºå‰ΩÜÂ∞á bg-white ÊîπÁÇ∫ bg-stone-800Ôºåtext-stone-800 ÊîπÁÇ∫ text-stone-200 Âç≥ÂèØ) ... */}
                        {/* ÁÇ∫Á¢∫‰øùÂÆåÊï¥ÊÄßÔºåÊàëÂ∞áÁπºÁ∫åÊèê‰æõÂâ©È§òÁöÑÈ†ÅÈù¢Á®ãÂºèÁ¢º */}
                        
                        {activeTab === 'assets' && (
                            <div className="animate-in space-y-4">
                                <div className="flex justify-between items-center mb-4">
                                    <div>
                                        <p className="text-sm text-stone-500 font-bold">Á∏ΩË≥áÁî¢ (TWD)</p>
                                        <h2 className="text-3xl font-black text-white tabular-nums">${stats.totalAsset.toLocaleString()}</h2>
                                    </div>
                                    <button onClick={()=>{setEditTarget(null); setAccForm({name:'', type:'cash', currency:'TWD', initialBalance:'', includeInTotal: true}); setModal('acc')}}><Icon name="plus-circle" className="text-rose-500" size={32}/></button>
                                </div>
                                <div className="grid gap-3">{accounts.map((acc, index) => (
                                    <div key={acc.id} onClick={() => { setViewingAccount(acc); setAccountDetailMonth(currentLedgerMonth); }} className="bg-stone-800 p-4 rounded-xl shadow-sm border border-stone-700 relative cursor-pointer hover:shadow-md transition-shadow">
                                            <div className="absolute top-3 right-3 flex gap-2" onClick={e => e.stopPropagation()}>
                                                <button onClick={()=>{setEditTarget(acc); openAccModalCorrect(acc);}} className="text-stone-500 hover:text-rose-500"><Icon name="edit-2" size={14}/></button>
                                            </div>
                                            <div className="flex gap-3 items-center mb-2">
                                                <div className={`p-2 rounded-lg ${ACCOUNT_TYPES[acc.type]?.color || 'bg-stone-700 text-stone-400'}`}><Icon name={ACCOUNT_TYPES[acc.type]?.iconName || 'wallet'} size={18}/></div>
                                                <div><h3 className="font-bold text-stone-200">{acc.name}</h3></div>
                                            </div>
                                            <p className="text-2xl font-black tabular-nums text-white ml-7">${(acc.marketValue || stats.bals[acc.id]||0).toLocaleString()} <span className="text-xs text-stone-500 font-normal">{acc.currency}</span></p>
                                            {acc.type === 'invest' && (<div className="mt-2 pt-2 border-t border-stone-700 flex justify-between items-center text-xs ml-7" onClick={e => e.stopPropagation()}><span className="text-stone-500">ÊàêÊú¨: ${(stats.bals[acc.id]||0).toLocaleString()}</span><button onClick={()=>{setEditTarget(acc); setNewMarketValue(acc.marketValue||''); setModal('market')}} className="text-rose-400 font-bold bg-rose-500/10 px-2 py-1 rounded">Ë™øÊï¥Â∏ÇÂÄº</button></div>)}
                                    </div>
                                ))}</div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="animate-in space-y-4">
                                <h2 className="text-xl font-bold text-white">Ë®≠ÂÆö</h2>
                                <button onClick={()=>setModal('budget')} className="w-full bg-stone-800 p-4 rounded-xl shadow-sm border border-stone-700 text-left font-bold flex justify-between items-center text-stone-200"><div>ÊúàÈ†êÁÆóË®≠ÂÆö <span className="text-xs text-stone-500 font-normal block">ÁõÆÂâç: ${monthlyBudget.toLocaleString()}</span></div><Icon name="chevron-right" className="text-stone-600"/></button>
                                <button onClick={()=>setModal('cat')} className="w-full bg-stone-800 p-4 rounded-xl shadow-sm border border-stone-700 text-left font-bold flex justify-between items-center text-stone-200">È°ûÂà•ÁÆ°ÁêÜ <Icon name="chevron-right" className="text-stone-600"/></button>
                                <div className="grid grid-cols-2 gap-3 mt-4">
                                    <button onClick={handleExport} className="bg-emerald-900/30 text-emerald-400 p-4 rounded-xl font-bold text-center border border-emerald-900/50 flex items-center justify-center gap-2"><Icon name="download" size={18}/> ÂåØÂá∫ Excel</button>
                                    <button onClick={handleImportClick} className="bg-blue-900/30 text-blue-400 p-4 rounded-xl font-bold text-center border border-blue-900/50 flex items-center justify-center gap-2"><Icon name="upload" size={18}/> ÂåØÂÖ• Excel</button>
                                    <input type="file" ref={fileInputRef} onChange={handleImportFile} className="hidden" accept=".xlsx, .xls, .csv" />
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-0 w-full bg-stone-900 border-t border-stone-800 px-6 py-3 flex justify-between z-[100] pb-safe max-w-xl mx-auto left-0 right-0 shadow-lg">
                        <NavBtn icon={<Icon name="home"/>} label="Â∏≥Êú¨" active={activeTab==='home'} onClick={()=>setActiveTab('home')}/>
                        <NavBtn icon={<Icon name="pie-chart"/>} label="ÂàÜÊûê" active={activeTab==='analysis'} onClick={()=>setActiveTab('analysis')}/>
                        <NavBtn icon={<Icon name="landmark"/>} label="Â∏≥Êà∂" active={activeTab==='assets'} onClick={()=>setActiveTab('assets')}/>
                        <NavBtn icon={<Icon name="settings"/>} label="Ë®≠ÂÆö" active={activeTab==='settings'} onClick={()=>setActiveTab('settings')}/>
                    </nav>

                    {activeTab === 'home' && <button onClick={()=>openTxModal('expense')} className="fixed bottom-24 right-6 bg-gradient-to-r from-orange-600 to-rose-600 text-white p-4 rounded-full shadow-lg z-[100] transition-transform active:scale-95 border-2 border-stone-800"><Icon name="plus" size={32}/></button>}

                    {/* Modals (TX Modal Example - kept simplified for length, apply dark mode classes) */}
                    {modal === 'tx' && (
                        <div className="fixed inset-0 z-[200] bg-black/80 flex items-end sm:items-center justify-center p-4">
                            <div className="bg-stone-900 w-full max-w-md rounded-t-2xl sm:rounded-2xl p-6 animate-in slide-in-from-bottom max-h-[90vh] overflow-y-auto border border-stone-800">
                                <h3 className="font-bold text-xl mb-4 text-white">Ë®ò‰∏ÄÁ≠Ü</h3>
                                <input type="number" step="0.01" className="w-full text-4xl font-black mb-4 outline-none tabular-nums bg-transparent text-white placeholder-stone-700" placeholder="0.00" value={txForm.amount} onChange={e=>setTxForm({...txForm, amount:e.target.value})} autoFocus />
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <button onClick={()=>{setTxForm({...txForm, type:'expense'});}} className={`p-3 rounded-lg font-bold ${txForm.type==='expense'?'bg-rose-500/20 text-rose-400 border border-rose-500/50':'bg-stone-800 text-stone-500'}`}>ÊîØÂá∫</button>
                                    <button onClick={()=>{setTxForm({...txForm, type:'income'});}} className={`p-3 rounded-lg font-bold ${txForm.type==='income'?'bg-emerald-500/20 text-emerald-400 border border-emerald-500/50':'bg-stone-800 text-stone-500'}`}>Êî∂ÂÖ•</button>
                                </div>
                                <div className="space-y-4">
                                    <select className="w-full bg-stone-800 p-3 rounded-lg font-bold text-stone-200 border border-stone-700" value={txForm.category} onChange={e=>setTxForm({...txForm, category:e.target.value})}>
                                        {categories[txForm.type].map(c=><option key={c.name} value={c.name}>{c.name}</option>)}
                                    </select>
                                    <div className="flex gap-2">
                                        <input type="date" className="bg-stone-800 p-3 rounded-lg flex-1 font-bold text-stone-200 border border-stone-700" value={txForm.date} onChange={e=>setTxForm({...txForm, date:e.target.value})} />
                                        <input className="bg-stone-800 p-3 rounded-lg flex-[2] font-bold text-stone-200 border border-stone-700" placeholder="ÂÇôË®ª" value={txForm.note} onChange={e=>setTxForm({...txForm, note:e.target.value})} />
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={()=>setModal(null)} className="flex-1 bg-stone-800 py-3 rounded-xl font-bold text-stone-400">ÂèñÊ∂à</button>
                                    <button onClick={handleTxSave} className="flex-1 bg-rose-600 text-white py-3 rounded-xl font-bold shadow-lg">ÂÑ≤Â≠ò</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Other modals omitted for brevity, similar dark mode styling applied */}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
